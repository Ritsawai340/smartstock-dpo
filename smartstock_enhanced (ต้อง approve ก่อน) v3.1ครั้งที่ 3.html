<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartStock อ.ส.ค. - ระบบจัดการสต๊อกวัตถุดิบอาหารโคนมอัจฉริยะ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; overflow-x: hidden; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); padding: 50px; border-radius: 25px; box-shadow: 0 25px 80px rgba(0,0,0,0.2); width: 100%; max-width: 450px; text-align: center; border: 1px solid rgba(255,255,255,0.3); animation: slideInUp 0.8s ease-out; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .login-logo { font-size: 5rem; margin-bottom: 25px; animation: float 3s ease-in-out infinite; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.2)); }
        .login-title { font-size: 2.2rem; margin-bottom: 15px; color: #2c3e50; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .login-subtitle { color: #7f8c8d; margin-bottom: 35px; font-size: 1.1rem; font-weight: 500; }
        .form-group { margin-bottom: 25px; text-align: left; }
        label { display: block; margin-bottom: 10px; font-weight: 700; color: #2c3e50; font-size: 1rem; }
        input, select, textarea { width: 100%; padding: 15px 20px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 1.05rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15); transform: translateY(-2px); }
        .btn { display: inline-block; padding: 15px 30px; border: none; border-radius: 12px; cursor: pointer; font-size: 1.05rem; font-weight: 700; text-decoration: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); margin: 5px; position: relative; overflow: hidden; text-transform: uppercase; letter-spacing: 1px; }
        .btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); transition: left 0.5s; }
        .btn:hover::before { left: 100%; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; box-shadow: 0 10px 30px rgba(108, 117, 125, 0.3); }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; box-shadow: 0 10px 30px rgba(220, 53, 69, 0.3); }
        .btn-warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529; box-shadow: 0 10px 30px rgba(255, 193, 7, 0.3); }
        .btn-info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; box-shadow: 0 10px 30px rgba(23, 162, 184, 0.3); }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(0,0,0,0.2); }
        .btn:active { transform: translateY(-1px); }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; min-width: 80px; height: 36px; display: flex; align-items: center; justify-content: center; }
        .header { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 25px; border-radius: 20px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; box-shadow: 0 15px 50px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); position: relative; overflow: hidden; }
        .header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #667eea, #764ba2, #667eea); background-size: 200% 100%; animation: shimmer 3s ease-in-out infinite; }
        .header h1 { color: #2c3e50; font-size: 2.2rem; margin-bottom: 5px; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header p { color: #7f8c8d; font-size: 1rem; font-weight: 500; }
        .user-info { display: flex; align-items: center; gap: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 12px 20px; border-radius: 30px; border: 1px solid rgba(0,0,0,0.05); }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .nav-tabs { display: flex; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 20px; padding: 8px; margin-bottom: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow-x: auto; border: 1px solid rgba(255,255,255,0.3); }
        .nav-tab { flex: 1; padding: 15px 20px; text-align: center; background: transparent; border: none; border-radius: 12px; cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); font-size: 1rem; font-weight: 600; white-space: nowrap; min-width: 140px; position: relative; overflow: hidden; }
        .nav-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transform: translateY(-3px); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); }
        .nav-tab:hover:not(.active) { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 20px; padding: 30px; margin-bottom: 25px; box-shadow: 0 15px 50px rgba(0,0,0,0.08); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(255,255,255,0.3); position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #667eea, #764ba2, #667eea); background-size: 200% 100%; animation: shimmer 3s ease-in-out infinite; }
        .card:hover { transform: translateY(-8px); box-shadow: 0 25px 80px rgba(0,0,0,0.15); }
        .card h3 { color: #2c3e50; margin-bottom: 25px; font-size: 1.6rem; font-weight: 700; background: linear-gradient(135deg, #2c3e50 0%, #667eea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 25px; }
        .stat-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 15px 50px rgba(0,0,0,0.08); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; }
        .stat-card.green::before { background: linear-gradient(90deg, #27ae60, #2ecc71); }
        .stat-card.blue::before { background: linear-gradient(90deg, #3498db, #2980b9); }
        .stat-card.orange::before { background: linear-gradient(90deg, #f39c12, #e67e22); }
        .stat-card.red::before { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .stat-card.purple::before { background: linear-gradient(90deg, #9b59b6, #8e44ad); }
        .stat-card:hover { transform: translateY(-10px) scale(1.02); box-shadow: 0 25px 80px rgba(0,0,0,0.15); }
        .stat-number { font-size: 3rem; font-weight: 800; margin-bottom: 12px; background: linear-gradient(135deg, #2c3e50 0%, #667eea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: pulse 2s ease-in-out infinite; }
        .stat-label { font-weight: 600; color: #7f8c8d; font-size: 1.1rem; }
        .quick-actions { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 25px; }
        .content-section { display: none; animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .content-section.active { display: block; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .hide { display: none !important; }
        .notification { position: fixed; top: 25px; right: 25px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 20px 25px; border-radius: 15px; box-shadow: 0 15px 50px rgba(0,0,0,0.2); z-index: 10000; transform: translateX(400px); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); max-width: 350px; border: 1px solid rgba(255,255,255,0.3); }
        .notification.show { transform: translateX(0); }
        .notification.success { border-left: 6px solid #28a745; }
        .notification.error { border-left: 6px solid #dc3545; }
        .notification.warning { border-left: 6px solid #ffc107; }
        .notification.info { border-left: 6px solid #17a2b8; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 40px; border-radius: 20px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.3); animation: scaleIn 0.3s ease-out; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        .modal h3 { color: #2c3e50; margin-bottom: 25px; font-size: 1.8rem; font-weight: 700; text-align: center; background: linear-gradient(135deg, #2c3e50 0%, #667eea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .modal-buttons { display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px; flex-wrap: wrap; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .alert { padding: 20px 25px; border-radius: 15px; margin-bottom: 25px; border-left: 6px solid; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .alert-success { background: rgba(212, 237, 218, 0.9); border-color: #28a745; color: #155724; }
        .alert-warning { background: rgba(255, 243, 205, 0.9); border-color: #ffc107; color: #856404; }
        .alert-danger { background: rgba(248, 215, 218, 0.9); border-color: #dc3545; color: #721c24; }
        .alert-info { background: rgba(209, 236, 241, 0.9); border-color: #17a2b8; color: #0c5460; }
        .table-container { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 15px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); margin-bottom: 25px; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 18px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .table th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; font-size: 0.95rem; }
        .table tr:hover { background: rgba(102, 126, 234, 0.05); transform: scale(1.01); transition: all 0.3s ease; }
        .status-badge { padding: 8px 16px; border-radius: 25px; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .status-normal { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; border: 1px solid #b8dacc; }
        .status-warning { background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); color: #856404; border: 1px solid #f5c842; }
        .status-danger { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); color: #721c24; border: 1px solid #f1aeb5; }
        .status-pending { background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); color: #0c5460; border: 1px solid #b8daff; }
        .status-approved { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; border: 1px solid #b8dacc; }
        .status-rejected { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); color: #721c24; border: 1px solid #f1aeb5; }
        .status-expired { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); color: #721c24; border: 1px solid #f1aeb5; }

        /* TMR Requisition Styles */
        .requisition-form { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 20px; padding: 30px; margin-bottom: 25px; border: 2px solid rgba(102, 126, 234, 0.2); }
        .requisition-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; }
        .shift-buttons { display: flex; gap: 15px; margin-bottom: 20px; }
        .shift-btn { padding: 12px 25px; border: 2px solid #667eea; border-radius: 12px; background: white; color: #667eea; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        .shift-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .shift-btn:hover:not(.active) { background: rgba(102, 126, 234, 0.1); }
        .requisition-items { background: white; border-radius: 15px; padding: 25px; }
        .requisition-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 5px solid #17a2b8; }
        .requisition-card.pending { border-left-color: #ffc107; }
        .requisition-card.approved { border-left-color: #28a745; }
        .requisition-card.rejected { border-left-color: #dc3545; }
        .requisition-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .summary-item { padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; text-align: center; }
        .summary-value { font-size: 1.2rem; font-weight: bold; color: #2c3e50; }
        .summary-label { font-size: 0.9rem; color: #666; }
        .notification-badge { position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* Record Section Styles */
        .record-container { margin-bottom: 25px; }
        .record-form { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; }
        .form-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .form-tab { padding: 10px 20px; border: 2px solid #e9ecef; border-radius: 8px; background: white; cursor: pointer; transition: all 0.3s ease; }
        .form-tab.active { background: #667eea; color: white; border-color: #667eea; }

        /* Reports Section Styles */
        .report-filters { background: rgba(255,255,255,0.95); padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .filter-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .report-results { background: white; border-radius: 15px; padding: 25px; }
        .chart-container { height: 300px; margin: 20px 0; }

        /* Management Section Styles */
        .management-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .item-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        @media (max-width: 768px) { 
            .container { padding: 15px; } 
            .header { flex-direction: column; text-align: center; padding: 20px; } 
            .header h1 { font-size: 1.8rem; } 
            .nav-tabs { flex-direction: column; gap: 5px; } 
            .nav-tab { padding: 15px 20px; margin-bottom: 0; } 
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; } 
            .quick-actions { justify-content: center; } 
            .table-container { overflow-x: auto; } 
            .table { min-width: 600px; } 
            .table th, .table td { padding: 12px 10px; font-size: 0.9rem; } 
            .form-grid { grid-template-columns: 1fr; } 
            .requisition-header { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">🐄</div>
            <h2 class="login-title">SmartStock อ.ส.ค.</h2>
            <p class="login-subtitle">ระบบจัดการสต๊อกวัตถุดิบอาหารโคนมอัจฉริยะ<br>องค์การส่งเสริมกิจการโคนมแห่งประเทศไทย</p>
            
            <div class="form-group">
                <label>อีเมล</label>
                <input type="email" id="loginEmail" placeholder="example@dairy.co.th" required>
            </div>
            <div class="form-group">
                <label>รหัสผ่าน</label>
                <input type="password" id="loginPassword" placeholder="กรุณากรอกรหัสผ่าน" required>
            </div>
            <div class="form-group">
                <button class="btn btn-primary" onclick="doLogin()" style="width: 100%;">
                    🔐 เข้าสู่ระบบ
                </button>
            </div>

            <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%); padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px solid rgba(255,193,7,0.3); text-align: center;">
                <div style="font-size: 0.9rem; color: #e65100; margin-bottom: 5px;">
                    <strong>🔒 ข้อมูลความปลอดภัย</strong>
                </div>
                <div style="color: #bf360c; font-size: 0.8rem; line-height: 1.4;">
                    กรุณาอย่าแบ่งปันข้อมูลการเข้าสู่ระบบให้ผู้อื่น<br>
                    และออกจากระบบทุกครั้งหลังใช้งานเสร็จ
                </div>
            </div>

            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); padding: 20px; border-radius: 15px; margin-top: 25px; border: 1px solid rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 1.2rem; margin-bottom: 10px;">📞 ช่วยเหลือและสนับสนุน</div>
                <div style="color: #555; font-size: 0.95rem; line-height: 1.5;">
                    <strong>หากมีปัญหาในการใช้งาน หรือต้องการปรึกษาเพิ่มเติม</strong><br>
                    กรุณาติดต่อ: <strong style="color: #1976d2;">แผนกวิชาการโคนม</strong><br>
                    <small style="color: #666;">ฝ่ายวิจัยและพัฒนาการเลี้ยงโคนม</small><br><br>
                    <small style="color: #888; font-style: italic;">
                        💡 สำหรับการเข้าสู่ระบบ กรุณาใช้บัญชีที่ได้รับจากหน่วยงาน
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="container hide" id="mainApp">
        <div class="header">
            <div>
                <h1>🚀 SmartStock อ.ส.ค.</h1>
                <p>ระบบจัดการสต๊อกวัตถุดิบอาหารโคนมอัจฉริยะ Version 3.0</p>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <span id="userName">Admin</span>
                <div style="position: relative;">
                    <button class="btn btn-warning" id="notificationBtn" onclick="showNotifications()" style="position: relative;">
                        🔔 แจ้งเตือน
                    </button>
                    <span class="notification-badge hide" id="notificationBadge">0</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">🚪 ออกจากระบบ</button>
            </div>
        </div>

        <div class="nav-tabs" id="mainNavigation">
            <button class="nav-tab active" onclick="showSection('dashboard')">📊 ภาพรวม</button>
            <button class="nav-tab" onclick="showSection('inventory')" id="inventoryTab">📦 สต๊อก</button>
            <button class="nav-tab" onclick="showSection('record')" id="recordTab">📝 บันทึก</button>
            <button class="nav-tab" onclick="showSection('requisition')" id="requisitionTab" style="display: none;">📋 ใบเบิก TMR</button>
            <button class="nav-tab" onclick="showSection('approval')" id="approvalTab" style="display: none;">✅ อนุมัติ</button>
            <button class="nav-tab" onclick="showSection('reports')" id="reportsTab">📈 รายงาน</button>
            <button class="nav-tab" onclick="showSection('alerts')" id="alertsTab">🚨 แจ้งเตือน</button>
            <button class="nav-tab" onclick="showSection('management')" id="managementTab">⚙️ จัดการรายการ</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card green">
                    <div class="stat-number" id="totalItems">13</div>
                    <div class="stat-label">รายการทั้งหมด</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-number" id="totalValue">0</div>
                    <div class="stat-label">มูลค่ารวม (บาท)</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-number" id="lowStock">0</div>
                    <div class="stat-label">สต๊อกต่ำ</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-number" id="pendingRequisitions">0</div>
                    <div class="stat-label">ใบเบิกรออนุมัติ</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-number" id="expiredItems">0</div>
                    <div class="stat-label">หมดอายุแล้ว</div>
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="refreshData()">🔄 รีเฟรชข้อมูล</button>
                <button class="btn btn-success" onclick="exportToExcel()">📊 Export Excel</button>
                <button class="btn btn-secondary" onclick="exportData()">📄 Export JSON</button>
                <button class="btn btn-info" onclick="backupData()">💾 สำรองข้อมูล</button>
            </div>

            <div class="card">
                <h3>📊 สรุปมูลค่าสต๊อกตามแผนก</h3>
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-number" id="farmValue">0</div>
                        <div class="stat-label">ฟาร์มโคนม (บาท)</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-number" id="breedingValue">0</div>
                        <div class="stat-label">ผลิตน้ำเชื้อ (บาท)</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>🔄 กิจกรรมล่าสุด</h3>
                <div id="recentActivities">
                    <p style="color: #7f8c8d; font-style: italic;">ยังไม่มีกิจกรรม</p>
                </div>
            </div>
        </div>

        <!-- Inventory Section -->
        <div id="inventory" class="content-section">
            <div class="card">
                <h3>🌾 สต๊อกวัตถุดิบแผนกฟาร์มโคนม</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>รายการ</th>
                                <th>คงเหลือ (กก.)</th>
                                <th>ราคา/กก.</th>
                                <th>มูลค่า (บาท)</th>
                                <th>วันหมดอายุ</th>
                                <th>สถานะ</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="farmInventoryTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">กำลังโหลดข้อมูล...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>🐂 สต๊อกอาหารแผนกผลิตน้ำเชื้อ</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>รายการ</th>
                                <th>คงเหลือ (กก.)</th>
                                <th>ราคา/กก.</th>
                                <th>มูลค่า (บาท)</th>
                                <th>วันหมดอายุ</th>
                                <th>สถานะ</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="breedingInventoryTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">กำลังโหลดข้อมูล...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Record Section -->
        <div id="record" class="content-section">
            <div class="card">
                <h3>📝 บันทึกการรับ-จ่ายวัตถุดิบ</h3>
                <div class="alert alert-info">
                    <strong>ℹ️ หมายเหตุ:</strong> 
                    สำหรับการเบิกใช้ TMR ประจำวัน กรุณาใช้ระบบ "ใบเบิก TMR" เพื่อความสะดวกและการควบคุมที่ดีกว่า
                </div>
                
                <div class="record-container">
                    <div class="form-tabs">
                        <button class="form-tab active" onclick="setRecordType('in')">📥 รับเข้า</button>
                        <button class="form-tab" onclick="setRecordType('out')">📤 จ่ายออก</button>
                    </div>
                    
                    <div class="record-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>วันที่</label>
                                <input type="date" id="recordDate" required>
                            </div>
                            <div class="form-group">
                                <label>เวลา</label>
                                <input type="time" id="recordTime" required>
                            </div>
                            <div class="form-group">
                                <label>แผนก</label>
                                <select id="recordDepartment" required>
                                    <option value="">เลือกแผนก</option>
                                    <option value="farm">ฟาร์มโคนม</option>
                                    <option value="breeding">ผลิตน้ำเชื้อ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>รายการวัตถุดิบ</label>
                                <select id="recordItem" required>
                                    <option value="">เลือกรายการ</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label>จำนวน (กิโลกรัม)</label>
                                <input type="number" id="recordQuantity" min="0" step="0.1" required>
                            </div>
                            <div class="form-group" id="priceGroup">
                                <label>ราคาต่อกิโลกรัม (บาท)</label>
                                <input type="number" id="recordPrice" min="0" step="0.01">
                            </div>
                            <div class="form-group" id="supplierGroup">
                                <label>ผู้จำหน่าย/หน่วยงาน</label>
                                <input type="text" id="recordSupplier" placeholder="บริษัท ABC จำกัด">
                            </div>
                            <div class="form-group">
                                <label>เอกสารอ้างอิง</label>
                                <input type="text" id="recordRef" placeholder="INV-2025-001">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>หมายเหตุ</label>
                            <textarea id="recordNotes" rows="3" placeholder="ข้อมูลเพิ่มเติม (ไม่บังคับ)"></textarea>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="saveRecord()">💾 บันทึกข้อมูล</button>
                            <button class="btn btn-secondary" onclick="clearRecordForm()">🗑️ ล้างฟอร์ม</button>
                        </div>
                    </div>
                </div>
                
                <!-- Transaction History -->
                <div class="card" style="margin-top: 30px;">
                    <h4>📈 ประวัติการบันทึก (10 รายการล่าสุด)</h4>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>วันที่</th>
                                    <th>ประเภท</th>
                                    <th>รายการ</th>
                                    <th>จำนวน</th>
                                    <th>ราคา/หน่วย</th>
                                    <th>มูลค่า</th>
                                    <th>ผู้บันทึก</th>
                                </tr>
                            </thead>
                            <tbody id="transactionHistory">
                                <tr><td colspan="7" style="text-align: center; padding: 20px;">ยังไม่มีประวัติการบันทึก</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TMR Requisition Section -->
        <div id="requisition" class="content-section">
            <div class="card">
                <h3>📋 ใบเบิกวัตถุดิบ TMR</h3>
                <div class="requisition-form">
                    <div class="requisition-header">
                        <div>
                            <h4 style="margin: 0; color: #2c3e50;">🌾 สร้างใบเบิกใหม่</h4>
                            <p style="color: #666; margin: 5px 0 0 0; font-size: 1.1rem;">เลือกกะ วันที่ และรายการวัตถุดิบที่ต้องการเบิก</p>
                        </div>
                        <div>
                            <button class="btn btn-success" onclick="submitRequisition()" style="font-size: 1.2rem; padding: 18px 35px;">
                                📤 ส่งใบเบิก
                            </button>
                            <button class="btn btn-secondary" onclick="clearRequisition()">🗑️ ล้างข้อมูล</button>
                        </div>
                    </div>

                    <div class="form-grid" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label>วันที่</label>
                            <input type="date" id="requisitionDate" required style="font-size: 1.1rem;">
                        </div>
                        <div class="form-group">
                            <label>กะการทำงาน</label>
                            <div class="shift-buttons">
                                <button type="button" class="shift-btn active" onclick="selectShift('morning')" id="morningShift">
                                    🌅 กะเช้า (05:00-12:00)
                                </button>
                                <button type="button" class="shift-btn" onclick="selectShift('afternoon')" id="afternoonShift">
                                    🌇 กะบ่าย (13:00-20:00)
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="requisition-items">
                        <h5 style="margin-bottom: 20px; color: #2c3e50;">🌾 เลือกวัตถุดิบที่ต้องการเบิก</h5>
                        <p style="color: #666; margin-bottom: 20px; font-size: 1.1rem;">
                            ✅ <strong>ติ๊กเลือกรายการ</strong> และ <strong>ใส่จำนวนที่ต้องการ</strong> (หน่วย: กิโลกรัม)
                        </p>
                        
                        <div class="table-container" style="margin-bottom: 20px;">
                            <table class="table" id="requisitionItemsTable">
                                <thead>
                                    <tr>
                                        <th style="width: 60px; text-align: center;">เลือก</th>
                                        <th>รายการวัตถุดิบ</th>
                                        <th style="width: 150px; text-align: center;">สต๊อกคงเหลือ (กก.)</th>
                                        <th style="width: 150px; text-align: center;">จำนวนที่เบิก (กก.)</th>
                                        <th style="width: 120px; text-align: center;">ราคา/กก.</th>
                                        <th style="width: 150px; text-align: center;">มูลค่า (บาท)</th>
                                    </tr>
                                </thead>
                                <tbody id="requisitionTableBody">
                                    <!-- Items will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                            <button class="btn btn-warning" onclick="selectAllItems()" style="font-size: 1.1rem; padding: 15px 25px;">
                                ☑️ เลือกทั้งหมด
                            </button>
                            <button class="btn btn-secondary" onclick="clearAllSelections()" style="font-size: 1.1rem; padding: 15px 25px;">
                                ❌ ยกเลิกการเลือก
                            </button>
                        </div>
                    </div>

                    <div class="requisition-summary" id="requisitionSummary" style="margin-top: 20px; display: none;">
                        <div class="summary-item">
                            <div class="summary-value" id="totalItems">0</div>
                            <div class="summary-label">รายการ</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="totalQuantity">0</div>
                            <div class="summary-label">รวม (กก.)</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="estimatedValue">0</div>
                            <div class="summary-label">มูลค่าประมาณ (บาท)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Requisitions -->
            <div class="card">
                <h3>📄 ใบเบิกของฉัน</h3>
                <div id="myRequisitions">
                    <div class="alert alert-info">
                        <strong>ℹ️ ข้อมูล:</strong> ยังไม่มีใบเบิกในระบบ
                    </div>
                </div>
            </div>
        </div>

        <!-- Approval Section -->
        <div id="approval" class="content-section">
            <div class="card">
                <h3>✅ อนุมัติใบเบิก TMR</h3>
                <div class="pending-requisitions">
                    <h4 style="color: #2c3e50; margin-bottom: 20px;">📋 ใบเบิกรออนุมัติ</h4>
                    <div id="pendingRequisitionsList">
                        <div class="alert alert-info">
                            <strong>ℹ️ ข้อมูล:</strong> ไม่มีใบเบิกรออนุมัติในขณะนี้
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h4 style="color: #2c3e50; margin-bottom: 20px;">📚 ประวัติการอนุมัติ</h4>
                    <div id="approvalHistory">
                        <div class="alert alert-info">
                            <strong>ℹ️ ข้อมูล:</strong> ยังไม่มีประวัติการอนุมัติ
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports" class="content-section">
            <!-- Summary Report -->
            <div class="card">
                <h3>📈 รายงานการใช้งานวัตถุดิบ</h3>
                
                <div class="report-filters">
                    <h4 style="margin-bottom: 15px;">🔍 ตัวกรองรายงาน</h4>
                    <div class="filter-group">
                        <div class="form-group">
                            <label>ช่วงเวลา</label>
                            <select id="reportPeriod">
                                <option value="7">7 วันล่าสุด</option>
                                <option value="14">14 วันล่าสุด</option>
                                <option value="30" selected>30 วันล่าสุด</option>
                                <option value="custom">กำหนดเอง</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>แผนก</label>
                            <select id="reportDepartment">
                                <option value="all">ทุกแผนก</option>
                                <option value="farm">ฟาร์มโคนม</option>
                                <option value="breeding">ผลิตน้ำเชื้อ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ประเภทข้อมูล</label>
                            <select id="reportType">
                                <option value="all">ทั้งหมด</option>
                                <option value="normal">บันทึกปกติ</option>
                                <option value="requisition">ใบเบิก TMR</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="generateReport()" style="width: 100%;">
                                📊 สร้างรายงาน
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="report-results" id="reportResults" style="display: none;">
                    <h4 style="margin-bottom: 20px;">📋 ผลลัพธ์รายงาน</h4>
                    <div id="reportContent"></div>
                </div>
            </div>

            <!-- Material Movement Charts -->
            <div class="card">
                <h3>📊 กราฟการเคลื่อนไหววัตถุดิบรายตัว</h3>
                
                <div class="report-filters">
                    <h4 style="margin-bottom: 15px;">🎯 ตัวกรองกราฟ</h4>
                    <div class="filter-group">
                        <div class="form-group">
                            <label>รายการวัตถุดิบ</label>
                            <select id="chartItem" onchange="updateChart()">
                                <option value="">เลือกรายการ</option>
                                <option value="all">ทุกรายการ (Top 5)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ช่วงเวลา</label>
                            <select id="chartPeriod" onchange="updateChart()">
                                <option value="weekly">รายสัปดาห์</option>
                                <option value="monthly" selected>รายเดือน</option>
                                <option value="yearly">รายปี</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ประเภทกราฟ</label>
                            <select id="chartType" onchange="updateChart()">
                                <option value="line">เส้นกราฟ</option>
                                <option value="bar" selected>แท่งกราฟ</option>
                                <option value="area">พื้นที่กราฟ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ข้อมูลที่แสดง</label>
                            <select id="chartData" onchange="updateChart()">
                                <option value="usage" selected>การใช้งาน (จ่ายออก)</option>
                                <option value="incoming">การรับเข้า</option>
                                <option value="both">ทั้งรับเข้าและจ่ายออก</option>
                                <option value="stock">สต๊อกคงเหลือ</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Chart Canvas -->
                <div class="chart-container" style="position: relative; height: 400px; margin: 20px 0;">
                    <canvas id="materialChart" style="max-width: 100%; max-height: 100%;"></canvas>
                </div>

                <!-- Chart Legend and Statistics -->
                <div id="chartLegend" style="margin: 20px 0;"></div>
                
                <div class="chart-stats" id="chartStats" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card blue">
                            <div class="stat-number" id="chartTotalUsage">0</div>
                            <div class="stat-label">รวมการใช้งาน (กก.)</div>
                        </div>
                        <div class="stat-card green">
                            <div class="stat-number" id="chartAvgUsage">0</div>
                            <div class="stat-label">เฉลี่ยต่อช่วง (กก.)</div>
                        </div>
                        <div class="stat-card orange">
                            <div class="stat-number" id="chartMaxUsage">0</div>
                            <div class="stat-label">สูงสุด (กก.)</div>
                        </div>
                        <div class="stat-card purple">
                            <div class="stat-number" id="chartMinUsage">0</div>
                            <div class="stat-label">ต่ำสุด (กก.)</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="exportChart()">📊 Export กราฟเป็น PNG</button>
                    <button class="btn btn-info" onclick="showChartData()">📋 ดูข้อมูลตาราง</button>
                </div>
            </div>

            <!-- Trend Analysis -->
            <div class="card">
                <h3>📈 การวิเคราะห์แนวโน้ม</h3>
                
                <div id="trendAnalysis">
                    <div class="alert alert-info">
                        <strong>ℹ️ ข้อมูล:</strong> เลือกรายการวัตถุดิบเพื่อดูการวิเคราะห์แนวโน้ม
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div id="alerts" class="content-section">
            <div class="card">
                <h3>🚨 การแจ้งเตือนสำคัญ</h3>
                
                <div class="alert-settings" style="margin-bottom: 30px;">
                    <h4 style="margin-bottom: 15px;">⚙️ ตั้งค่าการแจ้งเตือน</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>แจ้งเตือนเมื่อสต๊อกต่ำกว่า (%)</label>
                            <input type="number" id="lowStockPercent" value="20" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>แจ้งเตือนก่อนหมดอายุ (วัน)</label>
                            <input type="number" id="expiryDays" value="7" min="1" max="365">
                        </div>
                        <div class="form-group">
                            <label>แจ้งเตือนใบเบิกรออนุมัติเกิน (ชั่วโมง)</label>
                            <input type="number" id="requisitionHours" value="4" min="1" max="24">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="saveAlertSettings()" style="width: 100%;">
                                💾 บันทึกการตั้งค่า
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="alertsContent">
                    <div class="alert alert-info">
                        <strong>ℹ️ สถานะ:</strong> ระบบพร้อมใช้งาน ข้อมูลถูกอัพเดทแบบ Real-time
                    </div>
                </div>
            </div>
        </div>

        <!-- Management Section -->
        <div id="management" class="content-section">
            <div class="card">
                <h3>⚙️ จัดการรายการอาหาร/วัตถุดิบ</h3>
                
                <div class="management-controls">
                    <button class="btn btn-success" onclick="showAddItemModal()">➕ เพิ่มรายการใหม่</button>
                    <button class="btn btn-info" onclick="refreshItems()">🔄 รีเฟรชรายการ</button>
                    <select id="sortItems" onchange="sortItemsList()">
                        <option value="name">เรียงตาม: ชื่อรายการ A-Z</option>
                        <option value="name-desc">เรียงตาม: ชื่อรายการ Z-A</option>
                        <option value="department">เรียงตาม: แผนก</option>
                        <option value="stock">เรียงตาม: สต๊อกมาก→น้อย</option>
                        <option value="price">เรียงตาม: ราคาสูง→ต่ำ</option>
                    </select>
                    <select id="filterDepartment" onchange="filterItemsList()">
                        <option value="all">ทุกแผนก</option>
                        <option value="farm">ฟาร์มโคนม</option>
                        <option value="breeding">ผลิตน้ำเชื้อ</option>
                    </select>
                </div>
                
                <div class="item-grid" id="itemsList">
                    <!-- Items will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <!-- Requisition Detail Modal -->
    <div class="modal" id="requisitionModal">
        <div class="modal-content">
            <h3 id="requisitionModalTitle">📋 รายละเอียดใบเบิก</h3>
            <div id="requisitionModalContent"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeRequisitionModal()">❌ ปิด</button>
            </div>
        </div>
    </div>

    <!-- Item Management Modal -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <h3 id="itemModalTitle">📦 จัดการรายการวัตถุดิบ</h3>
            <div id="itemModalContent">
                <div class="form-grid">
                    <div class="form-group">
                        <label>ชื่อรายการ *</label>
                        <input type="text" id="itemName" required>
                    </div>
                    <div class="form-group">
                        <label>แผนก *</label>
                        <select id="itemDepartment" required>
                            <option value="">เลือกแผนก</option>
                            <option value="farm">ฟาร์มโคนม</option>
                            <option value="breeding">ผลิตน้ำเชื้อ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>จุดสั่งซื้อ (กก.) *</label>
                        <input type="number" id="itemReorderPoint" required min="0">
                    </div>
                    <div class="form-group">
                        <label>วันหมดอายุ</label>
                        <input type="date" id="itemExpiryDate">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>บรรจุภัณฑ์</label>
                    <input type="text" id="itemPackaging" placeholder="ขนาดบรรจุ 50 กิโลกรัมต่อกระสอบ">
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>โปรตีน (%)</label>
                        <input type="text" id="itemProtein" placeholder="ไม่น้อยกว่า 16%">
                    </div>
                    <div class="form-group">
                        <label>ไขมัน (%)</label>
                        <input type="text" id="itemFat" placeholder="ไม่น้อยกว่า 3%">
                    </div>
                    <div class="form-group">
                        <label>ความชื้น (%)</label>
                        <input type="text" id="itemMoisture" placeholder="ไม่มากกว่า 13%">
                    </div>
                    <div class="form-group">
                        <label>เยื่อใย (%)</label>
                        <input type="text" id="itemFiber" placeholder="ไม่มากกว่า 14%">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>เงื่อนไขคุณภาพ</label>
                    <textarea id="itemQuality" rows="2" placeholder="เป็นของใหม่ไม่มีกลิ่น"></textarea>
                </div>
                
                <div class="form-group">
                    <label>หมายเหตุ</label>
                    <textarea id="itemNotes" rows="3" placeholder="ข้อมูลเพิ่มเติม"></textarea>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-success" onclick="saveItem()">💾 บันทึก</button>
                <button type="button" class="btn btn-secondary" onclick="closeItemModal()">❌ ยกเลิก</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let currentShift = 'morning';
        let currentRecordType = 'in';
        let currentEditingItem = null;

        // Enhanced Login Data with TMR operator
        const users = {
            'admin@dairy.co.th': { name: 'ผู้บริหาร', password: 'admin123', role: 'admin', department: 'all' },
            'farm@dairy.co.th': { name: 'แผนกฟาร์มโคนม', password: 'farm123', role: 'farm', department: 'farm' },
            'breeding@dairy.co.th': { name: 'แผนกผลิตน้ำเชื้อและพิสูจน์พันธุ์', password: 'breed123', role: 'breeding', department: 'breeding' },
            'tmr@dairy.co.th': { name: 'หน่วยผสม TMR', password: 'tmr123', role: 'tmr', department: 'farm' }
        };

        // Enhanced Demo Data with requisitions
        const demoData = {
            items: {
                farm: {
                    'F001': { name: 'อาหารลูกโค CP 973', stock: 840, pricePerKg: 19.00, reorderPoint: 500, expiryDate: '2026-12-31', lastModified: new Date().toISOString(), notes: 'อาหารลูกโค คุณภาพสูง', packaging: '50 กก./กระสอบ', protein: '≥18%', fat: '≥3.5%', moisture: '≤12%', fiber: '≤12%', quality: 'เป็นของใหม่ไม่มีกลิ่น' },
                    'F002': { name: 'อาหารข้น 16%', stock: 9900, pricePerKg: 10.11, reorderPoint: 1000, expiryDate: '2026-06-30', lastModified: new Date().toISOString(), notes: 'อาหารข้นโปรตีน 16%', packaging: '50 กก./กระสอบ', protein: '≥16%', fat: '≥3%', moisture: '≤13%', fiber: '≤14%', quality: 'คุณภาพมาตรฐาน' },
                    'F003': { name: 'อาหารข้น 20% (ผสม TMR)', stock: 21510, pricePerKg: 11.675, reorderPoint: 800, expiryDate: '2026-06-30', lastModified: new Date().toISOString(), notes: 'อาหารข้นโปรตีน 20% สำหรับผสม TMR', packaging: '50 กก./กระสอบ', protein: '≥20%', fat: '≥3%', moisture: '≤13%', fiber: '≤12%', quality: 'คุณภาพสูง' },
                    'F004': { name: 'กากถั่วเหลือง', stock: 4600, pricePerKg: 18.00, reorderPoint: 1000, expiryDate: '2025-12-31', lastModified: new Date().toISOString(), notes: 'กากถั่วเหลือง คุณภาพดี', packaging: '50 กก./กระสอบ', protein: '≥44%', fat: '≥0.5%', moisture: '≤12%', fiber: '≤7%', quality: 'แห้งดี ไม่มีเชื้อรา' },
                    'F005': { name: 'มันเส้น', stock: 25560, pricePerKg: 8.56, reorderPoint: 2000, expiryDate: '2025-12-31', lastModified: new Date().toISOString(), notes: 'มันเส้น แห้งดี', packaging: '50 กก./กระสอบ', protein: '≥2%', fat: '≥0.3%', moisture: '≤14%', fiber: '≤6%', quality: 'แห้งดี สีขาว' },
                    'F006': { name: 'MC Miner', stock: 475, pricePerKg: 350.00, reorderPoint: 200, expiryDate: '2027-12-31', lastModified: new Date().toISOString(), notes: 'แร่ธาตุผสม MC Miner', packaging: '25 กก./ถุง', protein: '-', fat: '-', moisture: '≤10%', fiber: '-', quality: 'ผงละเอียด ไม่จับตัว' },
                    'F007': { name: 'ไขมันผง', stock: 1100, pricePerKg: 55.00, reorderPoint: 100, expiryDate: '2026-03-31', lastModified: new Date().toISOString(), notes: 'ไขมันผง คุณภาพสูง', packaging: '25 กก./ถุง', protein: '≥24%', fat: '≥60%', moisture: '≤5%', fiber: '≤2%', quality: 'ผงละเอียด สีครีม' },
                    'F008': { name: 'แร่ธาตุ', stock: 425, pricePerKg: 9.42, reorderPoint: 200, expiryDate: '2027-12-31', lastModified: new Date().toISOString(), notes: 'แร่ธาตุผสม', packaging: '50 กก./กระสอบ', protein: '-', fat: '-', moisture: '≤12%', fiber: '-', quality: 'ผสมเท่าๆ กัน' },
                    'F009': { name: 'พรีมิกซ์', stock: 640, pricePerKg: 47.88, reorderPoint: 50, expiryDate: '2026-12-31', lastModified: new Date().toISOString(), notes: 'วิตามินและแร่ธาตุผสม', packaging: '25 กก./ถุง', protein: '-', fat: '-', moisture: '≤10%', fiber: '-', quality: 'ผงละเอียด เก็บในที่แห้ง' }
                },
                breeding: {
                    'B001': { name: 'อาหารข้น 16%', stock: 7170, pricePerKg: 14.17, reorderPoint: 500, expiryDate: '2026-06-30', lastModified: new Date().toISOString(), notes: 'อาหารข้นสำหรับโคพันธุ์', packaging: '50 กก./กระสอบ', protein: '≥16%', fat: '≥3%', moisture: '≤13%', fiber: '≤14%', quality: 'คุณภาพพิเศษสำหรับโคพันธุ์' },
                    'B002': { name: 'แร่ธาตุ', stock: 50, pricePerKg: 10.90, reorderPoint: 100, expiryDate: '2027-12-31', lastModified: new Date().toISOString(), notes: 'แร่ธาตุสำหรับโคพันธุ์', packaging: '25 กก./ถุง', protein: '-', fat: '-', moisture: '≤10%', fiber: '-', quality: 'สูตรพิเศษสำหรับโคพันธุ์' },
                    'B003': { name: 'พรีมิกซ์', stock: 210, pricePerKg: 95.76, reorderPoint: 25, expiryDate: '2026-12-31', lastModified: new Date().toISOString(), notes: 'วิตามินและแร่ธาตุสำหรับโคพันธุ์', packaging: '20 กก./ถุง', protein: '-', fat: '-', moisture: '≤8%', fiber: '-', quality: 'สูตรสำหรับโคพันธุ์พิเศษ' }
                }
            },
            transactions: [],
            requisitions: [],
            settings: { lowStockPercent: 20, expiryDays: 7, requisitionHours: 4, alertEmail: 'admin@dairy.co.th' }
        };

        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type} show`;
            notification.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center;"><span><strong>${message}</strong></span><button onclick="hideNotification()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">×</button></div>`;
            setTimeout(() => hideNotification(), 5000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        function generateId() {
            return 'R' + Date.now() + Math.random().toString(36).substr(2, 5);
        }

        // Login Functions
        function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showNotification('กรุณากรอกอีเมลและรหัสผ่าน', 'error');
                return;
            }
            
            const user = users[email];
            if (user && user.password === password) {
                currentUser = {
                    name: user.name,
                    email: email,
                    role: user.role,
                    department: user.department,
                    lastLogin: new Date().toISOString()
                };
                
                showNotification('เข้าสู่ระบบสำเร็จ!', 'success');
                document.getElementById('loginPassword').value = '';
                showMainApp();
            } else {
                showNotification('อีเมลหรือรหัสผ่านไม่ถูกต้อง', 'error');
                document.getElementById('loginPassword').value = '';
            }
        }

        function logout() {
            if (confirm('คุณต้องการออกจากระบบใช่หรือไม่?')) {
                currentUser = null;
                showLoginScreen();
                showNotification('ออกจากระบบเรียบร้อย', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        }

        // App Functions
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.add('hide');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hide');
            
            if (currentUser) {
                document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
                document.getElementById('userName').textContent = currentUser.name;
                setupNavigationByRole();
                setupCurrentDateTime();
                updateStats();
                updateInventoryTables();
                loadRequisitions();
                updateNotificationBadge();
                updateTransactionHistory();
                updateAlertsContent();
                loadItemsList();
                populateChartItemsList();
            }
        }

        function setupNavigationByRole() {
            const tabs = {
                requisitionTab: document.getElementById('requisitionTab'),
                approvalTab: document.getElementById('approvalTab'),
                inventoryTab: document.getElementById('inventoryTab'),
                recordTab: document.getElementById('recordTab'),
                reportsTab: document.getElementById('reportsTab'),
                alertsTab: document.getElementById('alertsTab'),
                managementTab: document.getElementById('managementTab')
            };
            
            // Reset all tabs
            Object.values(tabs).forEach(tab => {
                if (tab) tab.style.display = 'block';
            });
            
            if (currentUser.role === 'tmr') {
                // TMR operator จะเห็นเฉพาะ dashboard และ requisition
                tabs.requisitionTab.style.display = 'block';
                tabs.approvalTab.style.display = 'none';
                tabs.inventoryTab.style.display = 'none';
                tabs.recordTab.style.display = 'none';
                tabs.reportsTab.style.display = 'none';
                tabs.alertsTab.style.display = 'none';
                tabs.managementTab.style.display = 'none';
            } else if (currentUser.role === 'admin' || currentUser.role === 'farm') {
                // Admin และ farm manager จะเห็น approval tab แต่ไม่เห็น requisition tab
                tabs.requisitionTab.style.display = 'none';
                tabs.approvalTab.style.display = 'block';
            } else if (currentUser.role === 'breeding') {
                // Breeding จะไม่เห็นทั้ง requisition และ approval
                tabs.requisitionTab.style.display = 'none';
                tabs.approvalTab.style.display = 'none';
            }
        }

        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');

            // Initialize section-specific content
            switch(sectionName) {
                case 'requisition':
                    setupRequisitionForm();
                    loadMyRequisitions();
                    break;
                case 'approval':
                    loadPendingRequisitions();
                    loadApprovalHistory();
                    break;
                case 'inventory':
                    updateInventoryTables();
                    break;
                case 'record':
                    setupRecordForm();
                    updateTransactionHistory();
                    break;
                case 'reports':
                    populateChartItemsList();
                    updateChart();
                    break;
                case 'alerts':
                    updateAlertsContent();
                    break;
                case 'management':
                    loadItemsList();
                    break;
            }
        }

        function setupCurrentDateTime() {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().slice(0, 5);
            
            const requisitionDate = document.getElementById('requisitionDate');
            const recordDate = document.getElementById('recordDate');
            const recordTime = document.getElementById('recordTime');
            
            if (requisitionDate) requisitionDate.value = dateStr;
            if (recordDate) recordDate.value = dateStr;
            if (recordTime) recordTime.value = timeStr;
        }

        // Record Section Functions
        function setupRecordForm() {
            setupCurrentDateTime();
            setRecordType('in');
            updateRecordItemsList();
        }

        function setRecordType(type) {
            currentRecordType = type;
            
            // Update form tabs
            document.querySelectorAll('.form-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide price and supplier fields
            const priceGroup = document.getElementById('priceGroup');
            const supplierGroup = document.getElementById('supplierGroup');
            
            if (type === 'in') {
                priceGroup.style.display = 'block';
                supplierGroup.style.display = 'block';
                document.querySelector('label[for="recordPrice"]').textContent = 'ราคาต่อกิโลกรัม (บาท) *';
                document.getElementById('recordPrice').required = true;
            } else {
                priceGroup.style.display = 'none';
                supplierGroup.style.display = 'none';
                document.getElementById('recordPrice').required = false;
            }
            
            clearRecordForm();
        }

        function updateRecordItemsList() {
            const department = document.getElementById('recordDepartment').value;
            const itemSelect = document.getElementById('recordItem');
            
            itemSelect.innerHTML = '<option value="">เลือกรายการ</option>';
            
            if (department && demoData.items[department]) {
                Object.entries(demoData.items[department]).forEach(([code, item]) => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = `${item.name} (${code})`;
                    itemSelect.appendChild(option);
                });
            }
        }

        function saveRecord() {
            const date = document.getElementById('recordDate').value;
            const time = document.getElementById('recordTime').value;
            const department = document.getElementById('recordDepartment').value;
            const itemCode = document.getElementById('recordItem').value;
            const quantity = parseFloat(document.getElementById('recordQuantity').value);
            const price = parseFloat(document.getElementById('recordPrice').value);
            const supplier = document.getElementById('recordSupplier').value;
            const ref = document.getElementById('recordRef').value;
            const notes = document.getElementById('recordNotes').value;
            
            // Validation
            if (!date || !time || !department || !itemCode || !quantity) {
                showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
                return;
            }
            
            if (currentRecordType === 'in' && !price) {
                showNotification('กรุณากรอกราคาสำหรับการรับเข้า', 'error');
                return;
            }
            
            const item = demoData.items[department][itemCode];
            if (!item) {
                showNotification('ไม่พบรายการที่เลือก', 'error');
                return;
            }
            
            // Check stock for outgoing
            if (currentRecordType === 'out' && quantity > item.stock) {
                showNotification(`จำนวนที่จ่ายเกินสต๊อกที่มี (คงเหลือ: ${item.stock.toLocaleString()} กก.)`, 'error');
                return;
            }
            
            // Create transaction record
            const transaction = {
                id: 'T' + Date.now() + Math.random().toString(36).substr(2, 3),
                date: date,
                time: time,
                type: currentRecordType,
                itemCode: itemCode,
                itemName: item.name,
                department: department,
                quantity: quantity,
                unitPrice: currentRecordType === 'in' ? price : item.pricePerKg,
                totalPrice: currentRecordType === 'in' ? quantity * price : quantity * item.pricePerKg,
                supplier: supplier || (currentRecordType === 'out' ? 'ใช้งานภายใน' : ''),
                recorder: currentUser.name,
                notes: notes,
                documentRef: ref,
                fifoCalculation: currentRecordType === 'out'
            };
            
            // Update stock
            if (currentRecordType === 'in') {
                item.stock += quantity;
                // Update FIFO price (simplified)
                const currentValue = (item.stock - quantity) * item.pricePerKg;
                const newValue = quantity * price;
                item.pricePerKg = (currentValue + newValue) / item.stock;
            } else {
                item.stock -= quantity;
            }
            
            item.lastModified = new Date().toISOString();
            
            // Save transaction
            demoData.transactions.push(transaction);
            
            // Update displays
            updateStats();
            updateInventoryTables();
            updateTransactionHistory();
            clearRecordForm();
            
            showNotification(`บันทึก${currentRecordType === 'in' ? 'การรับเข้า' : 'การจ่ายออก'}เรียบร้อย\n${item.name}: ${quantity.toLocaleString()} กก.`, 'success');
        }

        function clearRecordForm() {
            document.getElementById('recordDepartment').value = '';
            document.getElementById('recordItem').innerHTML = '<option value="">เลือกรายการ</option>';
            document.getElementById('recordQuantity').value = '';
            document.getElementById('recordPrice').value = '';
            document.getElementById('recordSupplier').value = '';
            document.getElementById('recordRef').value = '';
            document.getElementById('recordNotes').value = '';
        }

        function updateTransactionHistory() {
            const tbody = document.getElementById('transactionHistory');
            if (!tbody) return;
            
            const transactions = demoData.transactions
                .sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time))
                .slice(0, 10);
            
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">ยังไม่มีประวัติการบันทึก</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            transactions.forEach(tx => {
                const row = document.createElement('tr');
                const typeText = tx.type === 'in' ? '📥 รับเข้า' : '📤 จ่ายออก';
                const typeColor = tx.type === 'in' ? '#28a745' : '#dc3545';
                
                row.innerHTML = `
                    <td>${new Date(tx.date).toLocaleDateString('th-TH')}<br><small>${tx.time}</small></td>
                    <td><span style="color: ${typeColor}; font-weight: bold;">${typeText}</span></td>
                    <td><strong>${tx.itemName}</strong><br><small>${tx.itemCode}</small></td>
                    <td style="text-align: right;">${tx.quantity.toLocaleString()} กก.</td>
                    <td style="text-align: right;">${tx.unitPrice.toFixed(2)}</td>
                    <td style="text-align: right;"><strong>${tx.totalPrice.toLocaleString()}</strong></td>
                    <td>${tx.recorder}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // TMR Requisition Functions
        function setupRequisitionForm() {
            populateRequisitionTable();
            clearRequisition();
        }

        function populateRequisitionTable() {
            const tbody = document.getElementById('requisitionTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Get all farm items
            const farmItems = demoData.items.farm || {};
            
            Object.entries(farmItems).forEach(([code, item]) => {
                const row = document.createElement('tr');
                row.style.backgroundColor = 'rgba(255,255,255,0.8)';
                
                const stockStatus = item.stock === 0 ? 
                    '<span style="color: #dc3545; font-weight: bold;">❌ หมด</span>' : 
                    `<span style="color: #28a745; font-weight: bold;">${item.stock.toLocaleString()}</span>`;
                
                row.innerHTML = `
                    <td style="text-align: center;">
                        <input type="checkbox" id="item_${code}" onchange="onItemCheck('${code}')" 
                               style="transform: scale(1.5); cursor: pointer;" 
                               ${item.stock === 0 ? 'disabled' : ''}>
                    </td>
                    <td>
                        <div style="font-weight: bold; font-size: 1.1rem; color: #2c3e50;">${item.name}</div>
                        <div style="color: #666; font-size: 0.9rem;">รหัส: ${code}</div>
                        ${item.stock <= item.reorderPoint * 0.2 ? '<div style="color: #ffc107; font-size: 0.8rem;">⚠️ สต๊อกต่ำ</div>' : ''}
                    </td>
                    <td style="text-align: center; font-size: 1.1rem;">
                        ${stockStatus}
                    </td>
                    <td style="text-align: center;">
                        <input type="number" id="qty_${code}" 
                               min="0" max="${item.stock}" step="0.1" 
                               placeholder="0" 
                               style="width: 100%; padding: 10px; font-size: 1.1rem; text-align: center; border: 2px solid #e9ecef; border-radius: 8px; font-weight: bold;"
                               onchange="onQuantityChange('${code}')"
                               oninput="onQuantityChange('${code}')"
                               ${item.stock === 0 ? 'disabled' : ''}>
                    </td>
                    <td style="text-align: center; font-size: 1rem; color: #666;">
                        ${item.pricePerKg.toFixed(2)}
                    </td>
                    <td style="text-align: center;">
                        <div id="value_${code}" style="font-weight: bold; font-size: 1.1rem; color: #27ae60;">0</div>
                    </td>
                `;
                
                // Add hover effect
                row.addEventListener('mouseenter', function() {
                    if (item.stock > 0) {
                        this.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
                        this.style.transform = 'scale(1.01)';
                        this.style.transition = 'all 0.2s ease';
                    }
                });
                
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'rgba(255,255,255,0.8)';
                    this.style.transform = 'scale(1)';
                });
                
                tbody.appendChild(row);
            });
        }

        function onItemCheck(code) {
            const checkbox = document.getElementById(`item_${code}`);
            const quantityInput = document.getElementById(`qty_${code}`);
            
            if (checkbox.checked) {
                quantityInput.style.borderColor = '#667eea';
                quantityInput.style.backgroundColor = '#f8f9ff';
                quantityInput.focus();
            } else {
                quantityInput.style.borderColor = '#e9ecef';
                quantityInput.style.backgroundColor = 'white';
                quantityInput.value = '';
                onQuantityChange(code);
            }
            
            updateRequisitionSummary();
        }

        function onQuantityChange(code) {
            const checkbox = document.getElementById(`item_${code}`);
            const quantityInput = document.getElementById(`qty_${code}`);
            const valueDiv = document.getElementById(`value_${code}`);
            const item = demoData.items.farm[code];
            
            let quantity = parseFloat(quantityInput.value) || 0;
            
            // Validate quantity
            if (quantity > item.stock) {
                quantity = item.stock;
                quantityInput.value = quantity;
                showNotification(`จำนวนเกินสต๊อกที่มี (${item.name}: คงเหลือ ${item.stock.toLocaleString()} กก.)`, 'warning');
            }
            
            if (quantity < 0) {
                quantity = 0;
                quantityInput.value = '';
            }
            
            // Auto check/uncheck based on quantity
            if (quantity > 0) {
                checkbox.checked = true;
                quantityInput.style.borderColor = '#667eea';
                quantityInput.style.backgroundColor = '#f8f9ff';
            } else {
                checkbox.checked = false;
                quantityInput.style.borderColor = '#e9ecef';
                quantityInput.style.backgroundColor = 'white';
            }
            
            // Calculate value
            const value = quantity * item.pricePerKg;
            valueDiv.textContent = value > 0 ? value.toLocaleString() : '0';
            
            updateRequisitionSummary();
        }

        function selectAllItems() {
            const farmItems = demoData.items.farm || {};
            let selectedCount = 0;
            
            Object.keys(farmItems).forEach(code => {
                const item = farmItems[code];
                if (item.stock > 0) {
                    const checkbox = document.getElementById(`item_${code}`);
                    const quantityInput = document.getElementById(`qty_${code}`);
                    
                    checkbox.checked = true;
                    quantityInput.style.borderColor = '#667eea';
                    quantityInput.style.backgroundColor = '#f8f9ff';
                    
                    // Set a default quantity if not already set
                    if (!quantityInput.value) {
                        const defaultQty = Math.min(10, Math.floor(item.stock * 0.1)); // 10% of stock or 10kg, whichever is less
                        if (defaultQty > 0) {
                            quantityInput.value = defaultQty;
                            onQuantityChange(code);
                        }
                    }
                    selectedCount++;
                }
            });
            
            updateRequisitionSummary();
            showNotification(`เลือกรายการทั้งหมด ${selectedCount} รายการแล้ว`, 'info');
        }

        function clearAllSelections() {
            const farmItems = demoData.items.farm || {};
            
            Object.keys(farmItems).forEach(code => {
                const checkbox = document.getElementById(`item_${code}`);
                const quantityInput = document.getElementById(`qty_${code}`);
                const valueDiv = document.getElementById(`value_${code}`);
                
                checkbox.checked = false;
                quantityInput.value = '';
                quantityInput.style.borderColor = '#e9ecef';
                quantityInput.style.backgroundColor = 'white';
                valueDiv.textContent = '0';
            });
            
            updateRequisitionSummary();
            showNotification('ยกเลิกการเลือกทั้งหมดแล้ว', 'info');
        }

        function updateRequisitionSummary() {
            const farmItems = demoData.items.farm || {};
            let totalItems = 0;
            let totalQuantity = 0;
            let totalValue = 0;
            
            Object.keys(farmItems).forEach(code => {
                const checkbox = document.getElementById(`item_${code}`);
                const quantityInput = document.getElementById(`qty_${code}`);
                
                if (checkbox && checkbox.checked) {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    if (quantity > 0) {
                        totalItems++;
                        totalQuantity += quantity;
                        totalValue += quantity * farmItems[code].pricePerKg;
                    }
                }
            });
            
            const summary = document.getElementById('requisitionSummary');
            if (totalItems > 0) {
                document.getElementById('totalItems').textContent = totalItems;
                document.getElementById('totalQuantity').textContent = totalQuantity.toLocaleString();
                document.getElementById('estimatedValue').textContent = totalValue.toLocaleString();
                summary.style.display = 'block';
            } else {
                summary.style.display = 'none';
            }
        }

        function selectShift(shift) {
            currentShift = shift;
            document.getElementById('morningShift').classList.toggle('active', shift === 'morning');
            document.getElementById('afternoonShift').classList.toggle('active', shift === 'afternoon');
        }

        function clearRequisition() {
            clearAllSelections();
            currentShift = 'morning';
            selectShift('morning');
            showNotification('ล้างข้อมูลใบเบิกแล้ว', 'info');
        }

        function submitRequisition() {
            const date = document.getElementById('requisitionDate').value;
            if (!date) {
                showNotification('กรุณาเลือกวันที่', 'error');
                return;
            }
            
            // Collect selected items from table
            const selectedItems = [];
            const farmItems = demoData.items.farm || {};
            
            Object.keys(farmItems).forEach(code => {
                const checkbox = document.getElementById(`item_${code}`);
                const quantityInput = document.getElementById(`qty_${code}`);
                
                if (checkbox && checkbox.checked) {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    if (quantity > 0) {
                        const item = farmItems[code];
                        selectedItems.push({
                            code: code,
                            name: item.name,
                            quantity: quantity,
                            pricePerKg: item.pricePerKg,
                            availableStock: item.stock
                        });
                    }
                }
            });
            
            if (selectedItems.length === 0) {
                showNotification('กรุณาเลือกวัตถุดิบและระบุจำนวนก่อนส่งใบเบิก', 'error');
                return;
            }
            
            // Check stock availability again
            for (const reqItem of selectedItems) {
                const currentStock = demoData.items.farm[reqItem.code].stock;
                if (reqItem.quantity > currentStock) {
                    showNotification(`${reqItem.name} มีสต๊อกไม่เพียงพอ (คงเหลือ: ${currentStock.toLocaleString()} กก.)`, 'error');
                    return;
                }
            }
            
            const requisition = {
                id: generateId(),
                date: date,
                shift: currentShift,
                shiftText: currentShift === 'morning' ? 'กะเช้า (05:00-12:00)' : 'กะบ่าย (13:00-20:00)',
                requester: currentUser.name,
                requesterEmail: currentUser.email,
                status: 'pending',
                items: selectedItems,
                totalQuantity: selectedItems.reduce((sum, item) => sum + item.quantity, 0),
                totalValue: selectedItems.reduce((sum, item) => sum + (item.quantity * item.pricePerKg), 0),
                createdAt: new Date().toISOString(),
                approvedAt: null,
                approver: null,
                approverNotes: ''
            };
            
            demoData.requisitions.push(requisition);
            
            clearRequisition();
            loadMyRequisitions();
            updateStats();
            updateNotificationBadge();
            
            showNotification(`✅ ส่งใบเบิก ${requisition.id} เรียบร้อย\n\n📋 รายการ: ${selectedItems.length} รายการ\n📦 รวม: ${requisition.totalQuantity.toLocaleString()} กก.\n💰 มูลค่า: ${requisition.totalValue.toLocaleString()} บาท\n\n⏳ รอการอนุมัติจากผู้บริหาร`, 'success');
        }

        function loadMyRequisitions() {
            const container = document.getElementById('myRequisitions');
            if (!container) return;
            
            const myRequisitions = demoData.requisitions.filter(req => req.requesterEmail === currentUser.email);
            
            if (myRequisitions.length === 0) {
                container.innerHTML = '<div class="alert alert-info"><strong>ℹ️ ข้อมูล:</strong> ยังไม่มีใบเบิกในระบบ</div>';
                return;
            }
            
            let html = '';
            myRequisitions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(req => {
                const statusClass = req.status === 'pending' ? 'pending' : 
                                  req.status === 'approved' ? 'approved' : 'rejected';
                const statusText = req.status === 'pending' ? 'รออนุมัติ' : 
                                 req.status === 'approved' ? 'อนุมัติแล้ว' : 'ไม่อนุมัติ';
                
                html += `
                    <div class="requisition-card ${statusClass}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h5 style="margin: 0; color: #2c3e50;">ใบเบิก ${req.id}</h5>
                                <p style="margin: 5px 0; color: #666;">
                                    ${new Date(req.date).toLocaleDateString('th-TH')} - ${req.shiftText}
                                </p>
                            </div>
                            <span class="status-badge status-${statusClass}">${statusText}</span>
                        </div>
                        
                        <div class="requisition-summary">
                            <div class="summary-item">
                                <div class="summary-value">${req.items.length}</div>
                                <div class="summary-label">รายการ</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value">${req.totalQuantity.toLocaleString()}</div>
                                <div class="summary-label">รวม (กก.)</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value">${req.totalValue.toLocaleString()}</div>
                                <div class="summary-label">มูลค่า (บาท)</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-info btn-sm" onclick="viewRequisitionDetails('${req.id}')">
                                👁️ ดูรายละเอียด
                            </button>
                            ${req.status === 'pending' ? `<button class="btn btn-danger btn-sm" onclick="cancelRequisition('${req.id}')">❌ ยกเลิก</button>` : ''}
                        </div>
                        
                        ${req.status === 'approved' && req.approver ? `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(40, 167, 69, 0.1); border-radius: 8px;">
                                <small><strong>อนุมัติโดย:</strong> ${req.approver} 
                                เมื่อ ${new Date(req.approvedAt).toLocaleDateString('th-TH')} ${new Date(req.approvedAt).toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'})}</small>
                            </div>
                        ` : ''}
                        
                        ${req.status === 'rejected' && req.approverNotes ? `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(220, 53, 69, 0.1); border-radius: 8px;">
                                <small><strong>หมายเหตุ:</strong> ${req.approverNotes}</small>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function loadPendingRequisitions() {
            const container = document.getElementById('pendingRequisitionsList');
            if (!container) return;
            
            const pendingReqs = demoData.requisitions.filter(req => req.status === 'pending');
            
            if (pendingReqs.length === 0) {
                container.innerHTML = '<div class="alert alert-info"><strong>ℹ️ ข้อมูล:</strong> ไม่มีใบเบิกรออนุมัติในขณะนี้</div>';
                return;
            }
            
            let html = '';
            pendingReqs.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)).forEach(req => {
                html += `
                    <div class="requisition-card pending">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h5 style="margin: 0; color: #2c3e50;">ใบเบิก ${req.id}</h5>
                                <p style="margin: 5px 0; color: #666;">
                                    ${new Date(req.date).toLocaleDateString('th-TH')} - ${req.shiftText}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>ผู้เบิก:</strong> ${req.requester} | 
                                    <strong>ส่งเมื่อ:</strong> ${new Date(req.createdAt).toLocaleDateString('th-TH')} ${new Date(req.createdAt).toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'})}
                                </p>
                            </div>
                            <span class="status-badge status-pending">รออนุมัติ</span>
                        </div>
                        
                        <div class="requisition-summary">
                            <div class="summary-item">
                                <div class="summary-value">${req.items.length}</div>
                                <div class="summary-label">รายการ</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value">${req.totalQuantity.toLocaleString()}</div>
                                <div class="summary-label">รวม (กก.)</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value">${req.totalValue.toLocaleString()}</div>
                                <div class="summary-label">มูลค่า (บาท)</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-info btn-sm" onclick="viewRequisitionDetails('${req.id}')">
                                👁️ ดูรายละเอียด
                            </button>
                            <button class="btn btn-success btn-sm" onclick="approveRequisition('${req.id}')">
                                ✅ อนุมัติ
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="rejectRequisition('${req.id}')">
                                ❌ ไม่อนุมัติ
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function loadApprovalHistory() {
            const container = document.getElementById('approvalHistory');
            if (!container) return;
            
            const processedReqs = demoData.requisitions.filter(req => req.status !== 'pending');
            
            if (processedReqs.length === 0) {
                container.innerHTML = '<div class="alert alert-info"><strong>ℹ️ ข้อมูล:</strong> ยังไม่มีประวัติการอนุมัติ</div>';
                return;
            }
            
            let html = '';
            processedReqs.sort((a, b) => new Date(b.approvedAt) - new Date(a.approvedAt)).forEach(req => {
                const statusClass = req.status === 'approved' ? 'approved' : 'rejected';
                const statusText = req.status === 'approved' ? 'อนุมัติแล้ว' : 'ไม่อนุมัติ';
                
                html += `
                    <div class="requisition-card ${statusClass}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h5 style="margin: 0; color: #2c3e50;">ใบเบิก ${req.id}</h5>
                                <p style="margin: 5px 0; color: #666;">
                                    ${new Date(req.date).toLocaleDateString('th-TH')} - ${req.shiftText}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>ผู้เบิก:</strong> ${req.requester} | 
                                    <strong>อนุมัติโดย:</strong> ${req.approver} |
                                    <strong>เมื่อ:</strong> ${new Date(req.approvedAt).toLocaleDateString('th-TH')} ${new Date(req.approvedAt).toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'})}
                                </p>
                            </div>
                            <span class="status-badge status-${statusClass}">${statusText}</span>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-info btn-sm" onclick="viewRequisitionDetails('${req.id}')">
                                👁️ ดูรายละเอียด
                            </button>
                        </div>
                        
                        ${req.approverNotes ? `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(108, 117, 125, 0.1); border-radius: 8px;">
                                <small><strong>หมายเหตุ:</strong> ${req.approverNotes}</small>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function approveRequisition(reqId) {
            const req = demoData.requisitions.find(r => r.id === reqId);
            if (!req) return;
            
            // Check stock availability before approval
            const unavailableItems = [];
            for (const item of req.items) {
                const currentStock = demoData.items.farm[item.code].stock;
                if (item.quantity > currentStock) {
                    unavailableItems.push(`${item.name} (ต้องการ: ${item.quantity.toLocaleString()} กก., คงเหลือ: ${currentStock.toLocaleString()} กก.)`);
                }
            }
            
            if (unavailableItems.length > 0) {
                showNotification(`ไม่สามารถอนุมัติได้ สต๊อกไม่เพียงพอ:\n${unavailableItems.join('\n')}`, 'error');
                return;
            }
            
            if (confirm(`คุณต้องการอนุมัติใบเบิก ${reqId} ใช่หรือไม่?\n\nเมื่ออนุมัติแล้ว ระบบจะตัดยอดสต๊อกทันที`)) {
                // Update requisition status
                req.status = 'approved';
                req.approvedAt = new Date().toISOString();
                req.approver = currentUser.name;
                
                // Deduct stock
                req.items.forEach(item => {
                    demoData.items.farm[item.code].stock -= item.quantity;
                    
                    // Add transaction record
                    const transaction = {
                        id: 'T' + Date.now() + Math.random().toString(36).substr(2, 3),
                        date: new Date().toISOString().split('T')[0],
                        time: new Date().toTimeString().slice(0, 5),
                        type: 'out',
                        itemCode: item.code,
                        itemName: item.name,
                        department: 'farm',
                        quantity: item.quantity,
                        unitPrice: item.pricePerKg,
                        totalPrice: item.quantity * item.pricePerKg,
                        supplier: 'เบิกใช้ TMR',
                        recorder: currentUser.name,
                        notes: `ใบเบิก ${reqId} (${req.shiftText})`,
                        documentRef: reqId,
                        requisitionId: reqId
                    };
                    demoData.transactions.push(transaction);
                });
                
                loadPendingRequisitions();
                loadApprovalHistory();
                updateStats();
                updateInventoryTables();
                updateNotificationBadge();
                updateTransactionHistory();
                
                showNotification(`อนุมัติใบเบิก ${reqId} เรียบร้อย และตัดยอดสต๊อกแล้ว`, 'success');
            }
        }

        function rejectRequisition(reqId) {
            const notes = prompt(`กรุณาระบุเหตุผลในการไม่อนุมัติใบเบิก ${reqId}:`);
            if (notes === null) return; // User cancelled
            
            const req = demoData.requisitions.find(r => r.id === reqId);
            if (!req) return;
            
            req.status = 'rejected';
            req.approvedAt = new Date().toISOString();
            req.approver = currentUser.name;
            req.approverNotes = notes || 'ไม่ได้ระบุเหตุผล';
            
            loadPendingRequisitions();
            loadApprovalHistory();
            updateStats();
            updateNotificationBadge();
            
            showNotification(`ไม่อนุมัติใบเบิก ${reqId} แล้ว`, 'info');
        }

        function cancelRequisition(reqId) {
            if (confirm(`คุณต้องการยกเลิกใบเบิก ${reqId} ใช่หรือไม่?`)) {
                const index = demoData.requisitions.findIndex(r => r.id === reqId);
                if (index >= 0) {
                    demoData.requisitions.splice(index, 1);
                    loadMyRequisitions();
                    updateStats();
                    updateNotificationBadge();
                    showNotification(`ยกเลิกใบเบิก ${reqId} แล้ว`, 'info');
                }
            }
        }

        function viewRequisitionDetails(reqId) {
            const req = demoData.requisitions.find(r => r.id === reqId);
            if (!req) return;
            
            document.getElementById('requisitionModalTitle').textContent = `📋 รายละเอียดใบเบิก ${req.id}`;
            
            const statusClass = req.status === 'pending' ? 'pending' : 
                              req.status === 'approved' ? 'approved' : 'rejected';
            const statusText = req.status === 'pending' ? 'รออนุมัติ' : 
                             req.status === 'approved' ? 'อนุมัติแล้ว' : 'ไม่อนุมัติ';
            
            let itemsHtml = '';
            req.items.forEach(item => {
                const itemValue = item.quantity * item.pricePerKg;
                itemsHtml += `
                    <tr>
                        <td><strong>${item.name}</strong><br><small>${item.code}</small></td>
                        <td style="text-align: right;">${item.quantity.toLocaleString()}</td>
                        <td style="text-align: right;">${item.pricePerKg.toFixed(2)}</td>
                        <td style="text-align: right;"><strong>${itemValue.toLocaleString()}</strong></td>
                    </tr>
                `;
            });
            
            const content = `
                <div style="margin-bottom: 25px;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>รหัสใบเบิก</label>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;"><strong>${req.id}</strong></div>
                        </div>
                        <div class="form-group">
                            <label>สถานะ</label>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                <span class="status-badge status-${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>วันที่เบิก</label>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">${new Date(req.date).toLocaleDateString('th-TH')}</div>
                        </div>
                        <div class="form-group">
                            <label>กะการทำงาน</label>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">${req.shiftText}</div>
                        </div>
                        <div class="form-group">
                            <label>ผู้เบิก</label>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">${req.requester}</div>
                        </div>
                        <div class="form-group">
                            <label>วันเวลาที่ส่งใบเบิก</label>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                ${new Date(req.createdAt).toLocaleDateString('th-TH')} 
                                ${new Date(req.createdAt).toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'})}
                            </div>
                        </div>
                    </div>
                    
                    ${req.status !== 'pending' ? `
                        <div class="form-grid">
                            <div class="form-group">
                                <label>ผู้อนุมัติ</label>
                                <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">${req.approver || '-'}</div>
                            </div>
                            <div class="form-group">
                                <label>วันเวลาอนุมัติ</label>
                                <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                    ${req.approvedAt ? new Date(req.approvedAt).toLocaleDateString('th-TH') + ' ' + new Date(req.approvedAt).toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'}) : '-'}
                                </div>
                            </div>
                        </div>
                        
                        ${req.approverNotes ? `
                            <div class="form-group">
                                <label>หมายเหตุ</label>
                                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ffc107;">
                                    ${req.approverNotes}
                                </div>
                            </div>
                        ` : ''}
                    ` : ''}
                </div>
                
                <h5 style="margin-bottom: 15px; color: #2c3e50;">รายการวัตถุดิบที่เบิก</h5>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>รายการ</th>
                                <th style="text-align: right;">จำนวน (กก.)</th>
                                <th style="text-align: right;">ราคา/กก.</th>
                                <th style="text-align: right;">มูลค่า (บาท)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                            <tr style="background: rgba(102, 126, 234, 0.1); font-weight: bold;">
                                <td><strong>รวมทั้งหมด</strong></td>
                                <td style="text-align: right;"><strong>${req.totalQuantity.toLocaleString()}</strong></td>
                                <td style="text-align: right;">-</td>
                                <td style="text-align: right;"><strong>${req.totalValue.toLocaleString()}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('requisitionModalContent').innerHTML = content;
            document.getElementById('requisitionModal').classList.add('show');
        }

        function closeRequisitionModal() {
            document.getElementById('requisitionModal').classList.remove('show');
        }

        function showNotifications() {
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'farm')) {
                showSection('approval');
                // Find and click the approval tab
                document.querySelector('[onclick="showSection(\'approval\')"]').click();
            }
        }

        // Updated Stats Functions
        function updateStats() {
            const totalItems = Object.keys(demoData.items.farm).length + Object.keys(demoData.items.breeding).length;
            let totalValue = 0;
            let farmValue = 0;
            let breedingValue = 0;
            let lowStock = 0;
            let expiredItems = 0;
            
            // Calculate farm values
            Object.values(demoData.items.farm).forEach(item => {
                const value = item.stock * item.pricePerKg;
                farmValue += value;
                totalValue += value;
                const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                if (item.stock <= lowStockThreshold) {
                    lowStock++;
                }
                const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                if (expiryStatus.status === 'expired') {
                    expiredItems++;
                }
            });
            
            // Calculate breeding values
            Object.values(demoData.items.breeding).forEach(item => {
                const value = item.stock * item.pricePerKg;
                breedingValue += value;
                totalValue += value;
                const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                if (item.stock <= lowStockThreshold) {
                    lowStock++;
                }
                const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                if (expiryStatus.status === 'expired') {
                    expiredItems++;
                }
            });
            
            // Count pending requisitions
            const pendingReqs = demoData.requisitions.filter(req => req.status === 'pending').length;
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalValue').textContent = totalValue.toLocaleString('th-TH', { maximumFractionDigits: 0 });
            document.getElementById('farmValue').textContent = farmValue.toLocaleString('th-TH', { maximumFractionDigits: 0 });
            document.getElementById('breedingValue').textContent = breedingValue.toLocaleString('th-TH', { maximumFractionDigits: 0 });
            document.getElementById('lowStock').textContent = lowStock;
            document.getElementById('pendingRequisitions').textContent = pendingReqs;
            document.getElementById('expiredItems').textContent = expiredItems;
            
            updateRecentActivities();
        }

        function updateNotificationBadge() {
            const pendingReqs = demoData.requisitions.filter(req => req.status === 'pending').length;
            const badge = document.getElementById('notificationBadge');
            
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'farm')) {
                if (pendingReqs > 0) {
                    badge.textContent = pendingReqs;
                    badge.classList.remove('hide');
                } else {
                    badge.classList.add('hide');
                }
            } else {
                badge.classList.add('hide');
            }
        }

        // Utility Functions
        function getExpiryStatus(expiryDate, expiryDays = 7) {
            const today = new Date();
            const expiry = new Date(expiryDate);
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return { status: 'expired', statusClass: 'status-expired', message: 'หมดอายุแล้ว' };
            } else if (diffDays <= expiryDays) {
                return { status: 'expiring', statusClass: 'status-danger', message: `เหลือ ${diffDays} วัน` };
            } else if (diffDays <= expiryDays * 2) {
                return { status: 'warning', statusClass: 'status-warning', message: `เหลือ ${diffDays} วัน` };
            } else {
                return { status: 'normal', statusClass: 'status-normal', message: `เหลือ ${diffDays} วัน` };
            }
        }

        function updateInventoryTables() {
            updateInventoryTable('farm', 'farmInventoryTable');
            updateInventoryTable('breeding', 'breedingInventoryTable');
        }

        function updateInventoryTable(department, tableId) {
            const tbody = document.getElementById(tableId);
            if (!tbody) return;
            
            tbody.innerHTML = '';
            const items = demoData.items[department] || {};
            
            // Check user permissions
            if (currentUser.role === 'breeding' && department === 'farm') {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #7f8c8d; font-style: italic;">ไม่มีสิทธิ์เข้าถึงข้อมูลแผนกนี้</td></tr>';
                return;
            }
            
            if (currentUser.role === 'farm' && department === 'breeding') {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #7f8c8d; font-style: italic;">ไม่มีสิทธิ์เข้าถึงข้อมูลแผนกนี้</td></tr>';
                return;
            }
            
            if (Object.keys(items).length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #7f8c8d; font-style: italic;">ยังไม่มีรายการวัตถุดิบ</td></tr>';
                return;
            }
            
            Object.entries(items).forEach(([code, item]) => {
                const row = document.createElement('tr');
                const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                let stockStatus, stockStatusClass;
                
                if (item.stock === 0) {
                    stockStatus = 'หมด';
                    stockStatusClass = 'status-danger';
                } else if (item.stock <= lowStockThreshold) {
                    stockStatus = 'ต่ำ';
                    stockStatusClass = 'status-warning';
                } else {
                    stockStatus = 'ปกติ';
                    stockStatusClass = 'status-normal';
                }

                const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                let finalStatus, finalStatusClass;
                if (expiryStatus.status === 'expired') {
                    finalStatus = 'หมดอายุ';
                    finalStatusClass = 'status-expired';
                } else if (expiryStatus.status === 'expiring') {
                    finalStatus = `หมดอายุ ${expiryStatus.message}`;
                    finalStatusClass = 'status-danger';
                } else if (stockStatus === 'หมด') {
                    finalStatus = stockStatus;
                    finalStatusClass = stockStatusClass;
                } else if (stockStatus === 'ต่ำ') {
                    finalStatus = `สต๊อกต่ำ`;
                    finalStatusClass = stockStatusClass;
                } else {
                    finalStatus = 'ปกติ';
                    finalStatusClass = 'status-normal';
                }
                
                const totalValue = item.stock * item.pricePerKg;
                const expiryDate = new Date(item.expiryDate).toLocaleDateString('th-TH');
                
                row.innerHTML = `
                    <td>
                        <strong>${item.name}</strong><br>
                        <small style="color: #666;">${code}</small>
                    </td>
                    <td><strong>${item.stock.toLocaleString()}</strong></td>
                    <td>${item.pricePerKg.toFixed(2)}</td>
                    <td><strong style="color: #27ae60;">${totalValue.toLocaleString('th-TH', { maximumFractionDigits: 0 })}</strong></td>
                    <td>${expiryDate}</td>
                    <td><span class="status-badge ${finalStatusClass}">${finalStatus}</span></td>
                    <td style="text-align: center;">
                        <button class="btn btn-info btn-sm" onclick="showItemDetails('${code}', '${department}')" title="ดูรายละเอียด">
                            ℹ️ รายละเอียด
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function showItemDetails(code, department) {
            const item = demoData.items[department][code];
            if (!item) return;
            
            const detailsHtml = `
                รายละเอียด ${item.name}:
                • สต๊อก: ${item.stock.toLocaleString()} กก.
                • ราคา: ${item.pricePerKg.toFixed(2)} บาท/กก.
                • มูลค่า: ${(item.stock * item.pricePerKg).toLocaleString()} บาท
                • บรรจุภัณฑ์: ${item.packaging || '-'}
                • โปรตีน: ${item.protein || '-'}
                • วันหมดอายุ: ${new Date(item.expiryDate).toLocaleDateString('th-TH')}
            `;
            
            showNotification(detailsHtml, 'info');
        }

        function loadRequisitions() {
            // Load requisitions from storage if available
            if (currentUser) {
                updateNotificationBadge();
            }
        }

        // Recent Activities
        function updateRecentActivities() {
            const container = document.getElementById('recentActivities');
            if (!container) return;
            
            const recentReqs = demoData.requisitions
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 5);
            
            if (recentReqs.length === 0) {
                container.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">ยังไม่มีกิจกรรม</p>';
                return;
            }
            
            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            recentReqs.forEach(req => {
                const timeAgo = getTimeAgo(req.createdAt);
                const statusText = req.status === 'pending' ? 'รออนุมัติ' : 
                                 req.status === 'approved' ? 'อนุมัติแล้ว' : 'ไม่อนุมัติ';
                const statusColor = req.status === 'pending' ? '#ffc107' : 
                                   req.status === 'approved' ? '#28a745' : '#dc3545';
                
                html += `
                    <div style="padding: 15px; border-left: 4px solid ${statusColor}; margin-bottom: 15px; background: rgba(0,0,0,0.02); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong>ใบเบิก ${req.id}</strong><br>
                                <small style="color: #666;">โดย ${req.requester} • ${req.totalQuantity.toLocaleString()} กก. • ${timeAgo}</small>
                            </div>
                            <span style="color: ${statusColor}; font-weight: bold; font-size: 0.9rem;">${statusText}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function getTimeAgo(dateString) {
            const now = new Date();
            const past = new Date(dateString);
            const diffInSeconds = Math.floor((now - past) / 1000);
            
            if (diffInSeconds < 60) {
                return 'เมื่อสักครู่';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes} นาทีที่แล้ว`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours} ชั่วโมงที่แล้ว`;
            } else {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days} วันที่แล้ว`;
            }
        }

        // Charts and Analytics Variables
        let materialChart = null;
        let chartColors = [
            '#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a',
            '#ffcc70', '#a8e6cf', '#ff8a80', '#b39ddb', '#ffab91'
        ];

        // Reports Functions
        function generateReport() {
            const period = document.getElementById('reportPeriod').value;
            const department = document.getElementById('reportDepartment').value;
            const type = document.getElementById('reportType').value;
            
            let reportData = {
                transactions: [],
                requisitions: [],
                summary: {
                    totalUsage: 0,
                    totalValue: 0,
                    avgDaily: 0,
                    totalRequisitions: 0,
                    approvedRequisitions: 0,
                    rejectedRequisitions: 0
                }
            };
            
            // Filter data based on period
            const endDate = new Date();
            const startDate = new Date();
            
            if (period === '7') {
                startDate.setDate(endDate.getDate() - 7);
            } else if (period === '14') {
                startDate.setDate(endDate.getDate() - 14);
            } else if (period === '30') {
                startDate.setDate(endDate.getDate() - 30);
            }
            
            // Filter transactions
            if (type === 'all' || type === 'normal') {
                reportData.transactions = demoData.transactions.filter(tx => {
                    const txDate = new Date(tx.date);
                    const matchesPeriod = txDate >= startDate && txDate <= endDate;
                    const matchesDept = department === 'all' || tx.department === department;
                    return matchesPeriod && matchesDept && tx.type === 'out';
                });
            }
            
            // Filter requisitions
            if (type === 'all' || type === 'requisition') {
                reportData.requisitions = demoData.requisitions.filter(req => {
                    const reqDate = new Date(req.createdAt);
                    return reqDate >= startDate && reqDate <= endDate;
                });
            }
            
            // Calculate summary
            reportData.summary.totalUsage = reportData.transactions.reduce((sum, tx) => sum + tx.quantity, 0) +
                                          reportData.requisitions.filter(r => r.status === 'approved').reduce((sum, req) => sum + req.totalQuantity, 0);
            
            reportData.summary.totalValue = reportData.transactions.reduce((sum, tx) => sum + tx.totalPrice, 0) +
                                          reportData.requisitions.filter(r => r.status === 'approved').reduce((sum, req) => sum + req.totalValue, 0);
            
            reportData.summary.avgDaily = reportData.summary.totalUsage / parseInt(period);
            reportData.summary.totalRequisitions = reportData.requisitions.length;
            reportData.summary.approvedRequisitions = reportData.requisitions.filter(r => r.status === 'approved').length;
            reportData.summary.rejectedRequisitions = reportData.requisitions.filter(r => r.status === 'rejected').length;
            
            // Display results
            displayReportResults(reportData, period, department, type);
        }

        function displayReportResults(data, period, department, type) {
            const container = document.getElementById('reportResults');
            const content = document.getElementById('reportContent');
            
            const departmentText = department === 'all' ? 'ทุกแผนก' : department === 'farm' ? 'ฟาร์มโคนม' : 'ผลิตน้ำเชื้อ';
            const typeText = type === 'all' ? 'ทั้งหมด' : type === 'normal' ? 'บันทึกปกติ' : 'ใบเบิก TMR';
            
            content.innerHTML = `
                <div class="alert alert-info">
                    <strong>📊 รายงานการใช้งานวัตถุดิบ</strong><br>
                    ช่วงเวลา: ${period} วันล่าสุด | แผนก: ${departmentText} | ประเภท: ${typeText}
                </div>
                
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card blue">
                        <div class="stat-number">${data.summary.totalUsage.toLocaleString()}</div>
                        <div class="stat-label">รวมการใช้งาน (กก.)</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-number">${data.summary.totalValue.toLocaleString()}</div>
                        <div class="stat-label">มูลค่ารวม (บาท)</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-number">${data.summary.avgDaily.toFixed(1)}</div>
                        <div class="stat-label">เฉลี่ยต่อวัน (กก.)</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-number">${data.summary.totalRequisitions}</div>
                        <div class="stat-label">ใบเบิก TMR</div>
                    </div>
                </div>
                
                ${data.summary.totalRequisitions > 0 ? `
                    <h5 style="margin-bottom: 15px;">📋 สถิติใบเบิก TMR</h5>
                    <div class="stats-grid" style="margin-bottom: 30px;">
                        <div class="stat-card green">
                            <div class="stat-number">${data.summary.approvedRequisitions}</div>
                            <div class="stat-label">อนุมัติแล้ว</div>
                        </div>
                        <div class="stat-card red">
                            <div class="stat-number">${data.summary.rejectedRequisitions}</div>
                            <div class="stat-label">ไม่อนุมัติ</div>
                        </div>
                        <div class="stat-card blue">
                            <div class="stat-number">${data.summary.totalRequisitions - data.summary.approvedRequisitions - data.summary.rejectedRequisitions}</div>
                            <div class="stat-label">รออนุมัติ</div>
                        </div>
                    </div>
                ` : ''}
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="exportReportToExcel()">📊 Export รายงานเป็น Excel</button>
                </div>
            `;
            
            container.style.display = 'block';
        }

        // Chart Functions
        function populateChartItemsList() {
            const select = document.getElementById('chartItem');
            if (!select) return;
            
            // Clear existing options except the first two
            while (select.children.length > 2) {
                select.removeChild(select.lastChild);
            }
            
            // Add farm items
            if (currentUser.role !== 'breeding') {
                const farmGroup = document.createElement('optgroup');
                farmGroup.label = '🌾 ฟาร์มโคนม';
                Object.entries(demoData.items.farm).forEach(([code, item]) => {
                    const option = document.createElement('option');
                    option.value = `farm:${code}`;
                    option.textContent = `${item.name} (${code})`;
                    farmGroup.appendChild(option);
                });
                select.appendChild(farmGroup);
            }
            
            // Add breeding items
            if (currentUser.role !== 'farm') {
                const breedingGroup = document.createElement('optgroup');
                breedingGroup.label = '🐂 ผลิตน้ำเชื้อ';
                Object.entries(demoData.items.breeding).forEach(([code, item]) => {
                    const option = document.createElement('option');
                    option.value = `breeding:${code}`;
                    option.textContent = `${item.name} (${code})`;
                    breedingGroup.appendChild(option);
                });
                select.appendChild(breedingGroup);
            }
        }

        function calculateChartData() {
            const itemValue = document.getElementById('chartItem').value;
            const period = document.getElementById('chartPeriod').value;
            const dataType = document.getElementById('chartData').value;
            
            let chartData = {
                labels: [],
                datasets: [],
                itemName: '',
                statistics: {
                    total: 0,
                    average: 0,
                    max: 0,
                    min: 0
                }
            };
            
            if (!itemValue) return chartData;
            
            // Generate time periods
            const now = new Date();
            const periods = [];
            
            if (period === 'weekly') {
                // Last 12 weeks
                for (let i = 11; i >= 0; i--) {
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - (i * 7) - now.getDay());
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    periods.push({
                        label: `สัปดาห์ที่ ${Math.ceil((now - weekStart) / (7 * 24 * 60 * 60 * 1000))}`,
                        start: weekStart,
                        end: weekEnd
                    });
                }
            } else if (period === 'monthly') {
                // Last 12 months
                for (let i = 11; i >= 0; i--) {
                    const monthStart = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const monthEnd = new Date(now.getFullYear(), now.getMonth() - i + 1, 0);
                    periods.push({
                        label: monthStart.toLocaleDateString('th-TH', { year: 'numeric', month: 'short' }),
                        start: monthStart,
                        end: monthEnd
                    });
                }
            } else if (period === 'yearly') {
                // Last 5 years
                for (let i = 4; i >= 0; i--) {
                    const yearStart = new Date(now.getFullYear() - i, 0, 1);
                    const yearEnd = new Date(now.getFullYear() - i, 11, 31);
                    periods.push({
                        label: `${now.getFullYear() - i}`,
                        start: yearStart,
                        end: yearEnd
                    });
                }
            }
            
            chartData.labels = periods.map(p => p.label);
            
            if (itemValue === 'all') {
                // Top 5 most used items
                const itemUsage = {};
                
                // Calculate usage for all items
                Object.entries(demoData.items.farm).concat(Object.entries(demoData.items.breeding)).forEach(([code, item]) => {
                    const dept = demoData.items.farm[code] ? 'farm' : 'breeding';
                    itemUsage[`${dept}:${code}`] = {
                        name: item.name,
                        usage: 0
                    };
                });
                
                // Sum up usage from transactions and requisitions
                demoData.transactions.filter(tx => tx.type === 'out').forEach(tx => {
                    const key = `${tx.department}:${tx.itemCode}`;
                    if (itemUsage[key]) {
                        itemUsage[key].usage += tx.quantity;
                    }
                });
                
                demoData.requisitions.filter(req => req.status === 'approved').forEach(req => {
                    req.items.forEach(item => {
                        const key = `farm:${item.code}`;
                        if (itemUsage[key]) {
                            itemUsage[key].usage += item.quantity;
                        }
                    });
                });
                
                // Get top 5
                const topItems = Object.entries(itemUsage)
                    .sort(([,a], [,b]) => b.usage - a.usage)
                    .slice(0, 5);
                
                topItems.forEach(([itemKey, item], index) => {
                    const periodData = periods.map(period => {
                        let usage = 0;
                        
                        // Calculate usage for this period
                        demoData.transactions.filter(tx => {
                            const txDate = new Date(tx.date);
                            return tx.type === 'out' && 
                                   `${tx.department}:${tx.itemCode}` === itemKey &&
                                   txDate >= period.start && txDate <= period.end;
                        }).forEach(tx => usage += tx.quantity);
                        
                        demoData.requisitions.filter(req => {
                            const reqDate = new Date(req.createdAt);
                            return req.status === 'approved' &&
                                   reqDate >= period.start && reqDate <= period.end;
                        }).forEach(req => {
                            req.items.filter(reqItem => `farm:${reqItem.code}` === itemKey)
                                     .forEach(reqItem => usage += reqItem.quantity);
                        });
                        
                        return usage;
                    });
                    
                    chartData.datasets.push({
                        label: item.name,
                        data: periodData,
                        borderColor: chartColors[index],
                        backgroundColor: chartColors[index] + '20',
                        fill: false
                    });
                });
                
                chartData.itemName = 'รายการ Top 5';
            } else {
                // Single item
                const [dept, code] = itemValue.split(':');
                const item = demoData.items[dept][code];
                chartData.itemName = item.name;
                
                const periodData = periods.map(period => {
                    let incoming = 0;
                    let outgoing = 0;
                    let stockAtEnd = 0;
                    
                    // Calculate data for this period
                    demoData.transactions.filter(tx => {
                        const txDate = new Date(tx.date);
                        return tx.itemCode === code && 
                               tx.department === dept &&
                               txDate >= period.start && txDate <= period.end;
                    }).forEach(tx => {
                        if (tx.type === 'in') {
                            incoming += tx.quantity;
                        } else {
                            outgoing += tx.quantity;
                        }
                    });
                    
                    // Add requisition data (only for farm items)
                    if (dept === 'farm') {
                        demoData.requisitions.filter(req => {
                            const reqDate = new Date(req.createdAt);
                            return req.status === 'approved' &&
                                   reqDate >= period.start && reqDate <= period.end;
                        }).forEach(req => {
                            req.items.filter(reqItem => reqItem.code === code)
                                     .forEach(reqItem => outgoing += reqItem.quantity);
                        });
                    }
                    
                    // Stock at end of period (current stock for now - simplified)
                    stockAtEnd = item.stock;
                    
                    switch (dataType) {
                        case 'incoming': return incoming;
                        case 'usage': return outgoing;
                        case 'stock': return stockAtEnd;
                        case 'both': return { incoming, outgoing };
                        default: return outgoing;
                    }
                });
                
                if (dataType === 'both') {
                    chartData.datasets = [
                        {
                            label: 'รับเข้า',
                            data: periodData.map(d => d.incoming),
                            borderColor: '#28a745',
                            backgroundColor: '#28a74520',
                            fill: false
                        },
                        {
                            label: 'จ่ายออก',
                            data: periodData.map(d => d.outgoing),
                            borderColor: '#dc3545',
                            backgroundColor: '#dc354520',
                            fill: false
                        }
                    ];
                } else {
                    chartData.datasets = [{
                        label: getDataTypeLabel(dataType),
                        data: periodData,
                        borderColor: chartColors[0],
                        backgroundColor: chartColors[0] + '20',
                        fill: dataType === 'stock'
                    }];
                }
                
                // Calculate statistics
                const flatData = dataType === 'both' ? 
                    periodData.map(d => d.outgoing) : periodData;
                
                chartData.statistics.total = flatData.reduce((sum, val) => sum + val, 0);
                chartData.statistics.average = chartData.statistics.total / flatData.length;
                chartData.statistics.max = Math.max(...flatData);
                chartData.statistics.min = Math.min(...flatData);
            }
            
            return chartData;
        }

        function getDataTypeLabel(dataType) {
            switch (dataType) {
                case 'incoming': return 'รับเข้า (กก.)';
                case 'usage': return 'การใช้งาน (กก.)';
                case 'stock': return 'สต๊อกคงเหลือ (กก.)';
                default: return 'ข้อมูล (กก.)';
            }
        }

        function updateChart() {
            const canvas = document.getElementById('materialChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const chartType = document.getElementById('chartType').value;
            const chartData = calculateChartData();
            
            // Clear previous chart
            if (materialChart) {
                materialChart.destroy();
            }
            
            if (chartData.datasets.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('กรุณาเลือกรายการวัตถุดิบ', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Draw chart manually (simplified implementation)
            drawSimpleChart(ctx, chartData, chartType);
            
            // Update statistics
            updateChartStatistics(chartData);
            
            // Update legend
            updateChartLegend(chartData);
            
            // Update trend analysis
            updateTrendAnalysis(chartData);
        }

        function drawSimpleChart(ctx, data, type) {
            const canvas = ctx.canvas;
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;
            
            ctx.clearRect(0, 0, width, height);
            
            const padding = { top: 40, right: 40, bottom: 80, left: 80 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            if (data.datasets.length === 0) return;
            
            // Calculate scales
            const maxValue = Math.max(...data.datasets.flatMap(d => d.data));
            const minValue = Math.min(...data.datasets.flatMap(d => d.data));
            const valueRange = maxValue - minValue || 1;
            
            // Draw axes
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            
            // Y-axis
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top);
            ctx.lineTo(padding.left, height - padding.bottom);
            ctx.stroke();
            
            // X-axis
            ctx.beginPath();
            ctx.moveTo(padding.left, height - padding.bottom);
            ctx.lineTo(width - padding.right, height - padding.bottom);
            ctx.stroke();
            
            // Draw grid lines and labels
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            
            // Y-axis labels
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (chartHeight * i / 5);
                const value = maxValue - (valueRange * i / 5);
                
                ctx.fillText(Math.round(value).toLocaleString(), padding.left - 10, y + 4);
                
                if (i > 0 && i < 5) {
                    ctx.strokeStyle = '#f0f0f0';
                    ctx.beginPath();
                    ctx.moveTo(padding.left, y);
                    ctx.lineTo(width - padding.right, y);
                    ctx.stroke();
                }
            }
            
            // X-axis labels
            ctx.textAlign = 'center';
            data.labels.forEach((label, index) => {
                const x = padding.left + (chartWidth * (index + 0.5) / data.labels.length);
                ctx.fillText(label, x, height - padding.bottom + 20);
            });
            
            // Draw datasets
            data.datasets.forEach((dataset, datasetIndex) => {
                const color = dataset.borderColor || chartColors[datasetIndex];
                
                if (type === 'line' || type === 'area') {
                    // Line chart
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    
                    dataset.data.forEach((value, index) => {
                        const x = padding.left + (chartWidth * (index + 0.5) / data.labels.length);
                        const y = padding.top + chartHeight - ((value - minValue) / valueRange * chartHeight);
                        
                        if (index === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    
                    ctx.stroke();
                    
                    // Area fill
                    if (type === 'area') {
                        ctx.fillStyle = color + '20';
                        ctx.lineTo(padding.left + chartWidth, height - padding.bottom);
                        ctx.lineTo(padding.left, height - padding.bottom);
                        ctx.closePath();
                        ctx.fill();
                    }
                    
                    // Data points
                    ctx.fillStyle = color;
                    dataset.data.forEach((value, index) => {
                        const x = padding.left + (chartWidth * (index + 0.5) / data.labels.length);
                        const y = padding.top + chartHeight - ((value - minValue) / valueRange * chartHeight);
                        
                        ctx.beginPath();
                        ctx.arc(x, y, 4, 0, 2 * Math.PI);
                        ctx.fill();
                    });
                    
                } else if (type === 'bar') {
                    // Bar chart
                    const barWidth = chartWidth / data.labels.length * 0.8 / data.datasets.length;
                    const barSpacing = chartWidth / data.labels.length * 0.2;
                    
                    ctx.fillStyle = color;
                    
                    dataset.data.forEach((value, index) => {
                        const barHeight = ((value - minValue) / valueRange) * chartHeight;
                        const x = padding.left + (chartWidth * index / data.labels.length) + 
                                 barSpacing / 2 + (barWidth * datasetIndex);
                        const y = height - padding.bottom - barHeight;
                        
                        ctx.fillRect(x, y, barWidth, barHeight);
                    });
                }
            });
            
            // Title
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`การเคลื่อนไหววัตถุดิบ: ${data.itemName}`, width / 2, 25);
        }

        function updateChartStatistics(data) {
            const statsContainer = document.getElementById('chartStats');
            if (!statsContainer) return;
            
            if (data.datasets.length === 0) {
                statsContainer.style.display = 'none';
                return;
            }
            
            document.getElementById('chartTotalUsage').textContent = data.statistics.total.toLocaleString();
            document.getElementById('chartAvgUsage').textContent = data.statistics.average.toFixed(1);
            document.getElementById('chartMaxUsage').textContent = data.statistics.max.toLocaleString();
            document.getElementById('chartMinUsage').textContent = data.statistics.min.toLocaleString();
            
            statsContainer.style.display = 'block';
        }

        function updateChartLegend(data) {
            const legend = document.getElementById('chartLegend');
            if (!legend) return;
            
            if (data.datasets.length === 0) {
                legend.innerHTML = '';
                return;
            }
            
            let html = '<div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">';
            data.datasets.forEach((dataset, index) => {
                const color = dataset.borderColor || chartColors[index];
                html += `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background: ${color}; border-radius: 3px;"></div>
                        <span style="font-weight: 500;">${dataset.label}</span>
                    </div>
                `;
            });
            html += '</div>';
            
            legend.innerHTML = html;
        }

        function updateTrendAnalysis(data) {
            const container = document.getElementById('trendAnalysis');
            if (!container || data.datasets.length === 0) return;
            
            // Simple trend analysis
            const firstDataset = data.datasets[0];
            const values = firstDataset.data;
            
            if (values.length < 2) {
                container.innerHTML = '<div class="alert alert-info">ข้อมูลไม่เพียงพอสำหรับการวิเคราะห์แนวโน้ม</div>';
                return;
            }
            
            // Calculate trend
            const firstValue = values[0];
            const lastValue = values[values.length - 1];
            const trend = lastValue - firstValue;
            const trendPercent = firstValue !== 0 ? (trend / firstValue * 100) : 0;
            
            // Moving average
            const movingAvg = values.reduce((sum, val) => sum + val, 0) / values.length;
            
            // Volatility (standard deviation)
            const variance = values.reduce((sum, val) => sum + Math.pow(val - movingAvg, 2), 0) / values.length;
            const volatility = Math.sqrt(variance);
            
            let trendIcon, trendColor, trendText;
            if (trend > 0) {
                trendIcon = '📈';
                trendColor = '#28a745';
                trendText = 'เพิ่มขึ้น';
            } else if (trend < 0) {
                trendIcon = '📉';
                trendColor = '#dc3545';
                trendText = 'ลดลง';
            } else {
                trendIcon = '➡️';
                trendColor = '#6c757d';
                trendText = 'คงที่';
            }
            
            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div style="color: ${trendColor}; font-size: 2rem; margin-bottom: 10px;">${trendIcon}</div>
                        <div style="font-weight: bold; color: ${trendColor};">${trendText}</div>
                        <div style="color: #666; font-size: 0.9rem;">${Math.abs(trendPercent).toFixed(1)}%</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-number">${movingAvg.toFixed(1)}</div>
                        <div class="stat-label">ค่าเฉลี่ย (กก.)</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-number">${volatility.toFixed(1)}</div>
                        <div class="stat-label">ความผันผวน</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-number">${((lastValue / movingAvg - 1) * 100).toFixed(1)}%</div>
                        <div class="stat-label">เทียบกับค่าเฉลี่ย</div>
                    </div>
                </div>
                
                <div class="alert alert-${trend > 0 ? 'success' : trend < 0 ? 'warning' : 'info'}" style="margin-top: 20px;">
                    <strong>📊 การวิเคราะห์:</strong>
                    การใช้งาน${data.itemName} มีแนวโน้ม${trendText} ${Math.abs(trendPercent).toFixed(1)}% 
                    ${volatility > movingAvg * 0.3 ? 'มีความผันผวนสูง' : 'ค่อนข้างคงที่'}
                    ${lastValue > movingAvg * 1.2 ? ' ปัจจุบันการใช้งานสูงกว่าปกติ' : 
                      lastValue < movingAvg * 0.8 ? ' ปัจจุบันการใช้งานต่ำกว่าปกติ' : ' การใช้งานปกติ'}
                </div>
            `;
        }

        function exportChart() {
            const canvas = document.getElementById('materialChart');
            if (!canvas) return;
            
            try {
                const link = document.createElement('a');
                link.download = `material-chart-${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                showNotification('ส่งออกกราฟเป็น PNG เรียบร้อย', 'success');
            } catch (error) {
                showNotification('เกิดข้อผิดพลาดในการส่งออกกราฟ', 'error');
            }
        }

        function showChartData() {
            const chartData = calculateChartData();
            if (chartData.datasets.length === 0) {
                showNotification('กรุณาเลือกรายการวัตถุดิบก่อน', 'warning');
                return;
            }
            
            let tableHtml = `
                <div class="modal" style="display: flex;">
                    <div class="modal-content">
                        <h3>📋 ข้อมูลกราห: ${chartData.itemName}</h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ช่วงเวลา</th>
                                        ${chartData.datasets.map(d => `<th>${d.label}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            chartData.labels.forEach((label, index) => {
                tableHtml += `<tr><td><strong>${label}</strong></td>`;
                chartData.datasets.forEach(dataset => {
                    tableHtml += `<td>${dataset.data[index]?.toLocaleString() || '0'}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            tableHtml += `
                                </tbody>
                            </table>
                        </div>
                        <div class="modal-buttons">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">❌ ปิด</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', tableHtml);
        }

        function exportReportToExcel() {
            try {
                const workbook = XLSX.utils.book_new();
                const today = new Date().toLocaleDateString('th-TH');
                
                // Summary report
                const summaryData = [];
                summaryData.push(['รายงานสรุปการใช้งานวัตถุดิบ - SmartStock อ.ส.ค.', '', '', '', '']);
                summaryData.push(['วันที่สร้างรายงาน:', today, '', '', '']);
                summaryData.push(['', '', '', '', '']);
                summaryData.push(['หัวข้อ', 'จำนวน', 'หน่วย', '', '']);
                
                const summary = {
                    totalUsage: demoData.transactions.filter(tx => tx.type === 'out').reduce((sum, tx) => sum + tx.quantity, 0) +
                               demoData.requisitions.filter(r => r.status === 'approved').reduce((sum, req) => sum + req.totalQuantity, 0),
                    totalValue: demoData.transactions.filter(tx => tx.type === 'out').reduce((sum, tx) => sum + tx.totalPrice, 0) +
                               demoData.requisitions.filter(r => r.status === 'approved').reduce((sum, req) => sum + req.totalValue, 0),
                    totalRequisitions: demoData.requisitions.length,
                    approvedRequisitions: demoData.requisitions.filter(r => r.status === 'approved').length,
                    rejectedRequisitions: demoData.requisitions.filter(r => r.status === 'rejected').length
                };
                
                summaryData.push(['การใช้งานรวม', summary.totalUsage.toFixed(2), 'กิโลกรัม', '', '']);
                summaryData.push(['มูลค่ารวม', summary.totalValue.toFixed(2), 'บาท', '', '']);
                summaryData.push(['ใบเบิก TMR ทั้งหมด', summary.totalRequisitions, 'ใบ', '', '']);
                summaryData.push(['ใบเบิกที่อนุมัติ', summary.approvedRequisitions, 'ใบ', '', '']);
                summaryData.push(['ใบเบิกที่ไม่อนุมัติ', summary.rejectedRequisitions, 'ใบ', '', '']);
                
                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(workbook, summarySheet, 'สรุปรายงาน');
                
                // Chart data export
                const chartData = calculateChartData();
                if (chartData.datasets.length > 0) {
                    const chartExportData = [];
                    chartExportData.push(['กราฟการเคลื่อนไหววัตถุดิบ: ' + chartData.itemName, '', '', '']);
                    chartExportData.push(['วันที่สร้าง:', today, '', '']);
                    chartExportData.push(['', '', '', '']);
                    
                    // Header
                    const header = ['ช่วงเวลา'];
                    chartData.datasets.forEach(dataset => header.push(dataset.label));
                    chartExportData.push(header);
                    
                    // Data rows
                    chartData.labels.forEach((label, index) => {
                        const row = [label];
                        chartData.datasets.forEach(dataset => {
                            row.push(dataset.data[index] || 0);
                        });
                        chartExportData.push(row);
                    });
                    
                    const chartSheet = XLSX.utils.aoa_to_sheet(chartExportData);
                    XLSX.utils.book_append_sheet(workbook, chartSheet, 'ข้อมูลกราฟ');
                }
                
                const fileName = `SmartStock-Analysis-Report-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);
                showNotification('ส่งออกรายงานการวิเคราะห์ Excel เรียบร้อย', 'success');
            } catch (error) {
                console.error('Export report error:', error);
                showNotification('เกิดข้อผิดพลาดในการส่งออกรายงาน', 'error');
            }
        }

        // Alerts Functions
        function updateAlertsContent() {
            const container = document.getElementById('alertsContent');
            if (!container) return;
            
            let alerts = [];
            const settings = demoData.settings;
            
            // Check expired items
            Object.entries(demoData.items.farm).concat(Object.entries(demoData.items.breeding)).forEach(([code, item]) => {
                const expiryStatus = getExpiryStatus(item.expiryDate, settings.expiryDays);
                
                if (expiryStatus.status === 'expired') {
                    alerts.push({
                        level: 'danger',
                        icon: '🚫',
                        title: 'หมดอายุแล้ว',
                        message: `${item.name} (${code}) หมดอายุแล้ว`,
                        priority: 1
                    });
                } else if (expiryStatus.status === 'expiring') {
                    alerts.push({
                        level: 'warning',
                        icon: '⚠️',
                        title: 'ใกล้หมดอายุ',
                        message: `${item.name} (${code}) ${expiryStatus.message}`,
                        priority: 2
                    });
                }
                
                // Check low stock
                const lowStockThreshold = item.reorderPoint * (settings.lowStockPercent / 100);
                if (item.stock === 0) {
                    alerts.push({
                        level: 'danger',
                        icon: '📦',
                        title: 'สต๊อกหมด',
                        message: `${item.name} (${code}) สต๊อกหมด - ต้องสั่งซื้อทันที`,
                        priority: 1
                    });
                } else if (item.stock <= lowStockThreshold) {
                    alerts.push({
                        level: 'warning',
                        icon: '📉',
                        title: 'สต๊อกต่ำ',
                        message: `${item.name} (${code}) สต๊อกต่ำ (${item.stock.toLocaleString()} กก.)`,
                        priority: 2
                    });
                }
            });
            
            // Check pending requisitions
            const pendingReqs = demoData.requisitions.filter(req => req.status === 'pending');
            const overdueReqs = pendingReqs.filter(req => {
                const hoursDiff = (new Date() - new Date(req.createdAt)) / (1000 * 60 * 60);
                return hoursDiff > settings.requisitionHours;
            });
            
            if (overdueReqs.length > 0) {
                alerts.push({
                    level: 'danger',
                    icon: '⏰',
                    title: 'ใบเบิกรออนุมัติเกินเวลา',
                    message: `มีใบเบิก ${overdueReqs.length} ใบ รออนุมัติเกิน ${settings.requisitionHours} ชั่วโมง`,
                    priority: 1
                });
            } else if (pendingReqs.length > 0) {
                alerts.push({
                    level: 'warning',
                    icon: '📋',
                    title: 'ใบเบิกรออนุมัติ',
                    message: `มีใบเบิก ${pendingReqs.length} ใบ รออนุมัติ`,
                    priority: 2
                });
            }
            
            // Sort by priority and display
            alerts.sort((a, b) => a.priority - b.priority);
            
            let html = '';
            if (alerts.length === 0) {
                html = '<div class="alert alert-success"><strong>✅ ทุกอย่างปกติ:</strong> ไม่มีการแจ้งเตือนในขณะนี้</div>';
            } else {
                alerts.forEach(alert => {
                    html += `
                        <div class="alert alert-${alert.level}">
                            <strong>${alert.icon} ${alert.title}:</strong> ${alert.message}
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        function saveAlertSettings() {
            const lowStockPercent = parseInt(document.getElementById('lowStockPercent').value);
            const expiryDays = parseInt(document.getElementById('expiryDays').value);
            const requisitionHours = parseInt(document.getElementById('requisitionHours').value);
            
            if (lowStockPercent < 0 || lowStockPercent > 100) {
                showNotification('เปอร์เซ็นต์สต๊อกต่ำต้องอยู่ระหว่าง 0-100', 'error');
                return;
            }
            
            if (expiryDays < 1 || expiryDays > 365) {
                showNotification('จำนวนวันแจ้งเตือนต้องอยู่ระหว่าง 1-365', 'error');
                return;
            }
            
            if (requisitionHours < 1 || requisitionHours > 24) {
                showNotification('จำนวนชั่วโมงแจ้งเตือนต้องอยู่ระหว่าง 1-24', 'error');
                return;
            }
            
            demoData.settings.lowStockPercent = lowStockPercent;
            demoData.settings.expiryDays = expiryDays;
            demoData.settings.requisitionHours = requisitionHours;
            
            updateAlertsContent();
            updateStats();
            updateInventoryTables();
            
            showNotification('บันทึกการตั้งค่าการแจ้งเตือนเรียบร้อย', 'success');
        }

        // Management Functions
        function loadItemsList() {
            const container = document.getElementById('itemsList');
            if (!container) return;
            
            const farmItems = currentUser.role === 'breeding' ? {} : demoData.items.farm;
            const breedingItems = currentUser.role === 'farm' ? {} : demoData.items.breeding;
            
            let allItems = [];
            
            Object.entries(farmItems).forEach(([code, item]) => {
                allItems.push({ code, ...item, department: 'farm', departmentText: 'ฟาร์มโคนม' });
            });
            
            Object.entries(breedingItems).forEach(([code, item]) => {
                allItems.push({ code, ...item, department: 'breeding', departmentText: 'ผลิตน้ำเชื้อ' });
            });
            
            // Apply filters and sorting
            allItems = filterAndSortItems(allItems);
            
            if (allItems.length === 0) {
                container.innerHTML = '<div class="alert alert-info">ไม่พบรายการที่ตรงกับการกรอง</div>';
                return;
            }
            
            let html = '';
            allItems.forEach(item => {
                const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                const totalValue = item.stock * item.pricePerKg;
                
                html += `
                    <div class="item-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h5 style="margin: 0; color: #2c3e50;">${item.name}</h5>
                                <p style="color: #666; margin: 5px 0;">${item.code} • ${item.departmentText}</p>
                            </div>
                            <span class="status-badge ${expiryStatus.statusClass}">${expiryStatus.message}</span>
                        </div>
                        
                        <div class="form-grid" style="margin-bottom: 15px;">
                            <div>
                                <small style="color: #666;">สต๊อกคงเหลือ</small>
                                <div style="font-weight: bold; font-size: 1.2rem;">${item.stock.toLocaleString()} กก.</div>
                            </div>
                            <div>
                                <small style="color: #666;">ราคา/กก.</small>
                                <div style="font-weight: bold; font-size: 1.2rem;">${item.pricePerKg.toFixed(2)} บาท</div>
                            </div>
                            <div>
                                <small style="color: #666;">มูลค่ารวม</small>
                                <div style="font-weight: bold; font-size: 1.2rem; color: #27ae60;">${totalValue.toLocaleString()} บาท</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <small style="color: #666;">บรรจุภัณฑ์:</small> ${item.packaging || '-'}<br>
                            <small style="color: #666;">โปรตีน:</small> ${item.protein || '-'} | 
                            <small style="color: #666;">ไขมัน:</small> ${item.fat || '-'}
                        </div>
                        
                        <div>
                            <button class="btn btn-warning btn-sm" onclick="editItem('${item.code}', '${item.department}')">✏️ แก้ไข</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteItem('${item.code}', '${item.department}')" ${item.stock > 0 ? 'disabled title="ไม่สามารถลบรายการที่มีสต๊อกคงเหลือ"' : ''}>🗑️ ลบ</button>
                            <button class="btn btn-info btn-sm" onclick="showItemDetails('${item.code}', '${item.department}')">ℹ️ รายละเอียด</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function filterAndSortItems(items) {
            const department = document.getElementById('filterDepartment')?.value || 'all';
            const sortBy = document.getElementById('sortItems')?.value || 'name';
            
            // Filter by department
            if (department !== 'all') {
                items = items.filter(item => item.department === department);
            }
            
            // Sort items
            items.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name, 'th');
                    case 'name-desc':
                        return b.name.localeCompare(a.name, 'th');
                    case 'department':
                        return a.department.localeCompare(b.department);
                    case 'stock':
                        return b.stock - a.stock;
                    case 'price':
                        return b.pricePerKg - a.pricePerKg;
                    default:
                        return 0;
                }
            });
            
            return items;
        }

        function sortItemsList() {
            loadItemsList();
        }

        function filterItemsList() {
            loadItemsList();
        }

        function refreshItems() {
            loadItemsList();
            showNotification('รีเฟรชรายการเรียบร้อย', 'success');
        }

        function showAddItemModal() {
            currentEditingItem = null;
            document.getElementById('itemModalTitle').textContent = '📦 เพิ่มรายการวัตถุดิบใหม่';
            clearItemForm();
            document.getElementById('itemModal').classList.add('show');
        }

        function editItem(code, department) {
            currentEditingItem = { code, department };
            const item = demoData.items[department][code];
            
            document.getElementById('itemModalTitle').textContent = '📦 แก้ไขรายการวัตถุดิบ';
            
            // Fill form with current data
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemDepartment').value = department;
            document.getElementById('itemReorderPoint').value = item.reorderPoint;
            document.getElementById('itemExpiryDate').value = item.expiryDate;
            document.getElementById('itemPackaging').value = item.packaging || '';
            document.getElementById('itemProtein').value = item.protein || '';
            document.getElementById('itemFat').value = item.fat || '';
            document.getElementById('itemMoisture').value = item.moisture || '';
            document.getElementById('itemFiber').value = item.fiber || '';
            document.getElementById('itemQuality').value = item.quality || '';
            document.getElementById('itemNotes').value = item.notes || '';
            
            document.getElementById('itemModal').classList.add('show');
        }

        function deleteItem(code, department) {
            const item = demoData.items[department][code];
            
            if (item.stock > 0) {
                showNotification('ไม่สามารถลบรายการที่มีสต๊อกคงเหลือ', 'error');
                return;
            }
            
            if (confirm(`คุณต้องการลบรายการ "${item.name}" ใช่หรือไม่?\n\nการลบจะไม่สามารถย้อนกลับได้`)) {
                delete demoData.items[department][code];
                loadItemsList();
                updateStats();
                showNotification(`ลบรายการ "${item.name}" เรียบร้อย`, 'success');
            }
        }

        function saveItem() {
            const name = document.getElementById('itemName').value.trim();
            const department = document.getElementById('itemDepartment').value;
            const reorderPoint = parseInt(document.getElementById('itemReorderPoint').value);
            const expiryDate = document.getElementById('itemExpiryDate').value;
            
            if (!name || !department || !reorderPoint || !expiryDate) {
                showNotification('กรุณากรอกข้อมูลที่จำเป็น (*) ให้ครบถ้วน', 'error');
                return;
            }
            
            if (reorderPoint <= 0) {
                showNotification('จุดสั่งซื้อต้องมากกว่า 0', 'error');
                return;
            }
            
            const itemData = {
                name: name,
                stock: currentEditingItem ? demoData.items[currentEditingItem.department][currentEditingItem.code].stock : 0,
                pricePerKg: currentEditingItem ? demoData.items[currentEditingItem.department][currentEditingItem.code].pricePerKg : 0,
                reorderPoint: reorderPoint,
                expiryDate: expiryDate,
                lastModified: new Date().toISOString(),
                packaging: document.getElementById('itemPackaging').value.trim(),
                protein: document.getElementById('itemProtein').value.trim(),
                fat: document.getElementById('itemFat').value.trim(),
                moisture: document.getElementById('itemMoisture').value.trim(),
                fiber: document.getElementById('itemFiber').value.trim(),
                quality: document.getElementById('itemQuality').value.trim(),
                notes: document.getElementById('itemNotes').value.trim()
            };
            
            if (currentEditingItem) {
                // Update existing item
                const oldName = demoData.items[currentEditingItem.department][currentEditingItem.code].name;
                demoData.items[currentEditingItem.department][currentEditingItem.code] = itemData;
                showNotification(`อัพเดทรายการ "${oldName}" เรียบร้อย`, 'success');
            } else {
                // Add new item
                const newCode = department.toUpperCase().charAt(0) + String(Date.now()).slice(-3);
                demoData.items[department][newCode] = itemData;
                showNotification(`เพิ่มรายการ "${name}" เรียบร้อย (รหัส: ${newCode})`, 'success');
            }
            
            closeItemModal();
            loadItemsList();
            updateStats();
            updateInventoryTables();
        }

        function clearItemForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemDepartment').value = '';
            document.getElementById('itemReorderPoint').value = '';
            document.getElementById('itemExpiryDate').value = '';
            document.getElementById('itemPackaging').value = '';
            document.getElementById('itemProtein').value = '';
            document.getElementById('itemFat').value = '';
            document.getElementById('itemMoisture').value = '';
            document.getElementById('itemFiber').value = '';
            document.getElementById('itemQuality').value = '';
            document.getElementById('itemNotes').value = '';
        }

        function closeItemModal() {
            document.getElementById('itemModal').classList.remove('show');
            currentEditingItem = null;
        }

        // Export Functions
        function exportToExcel() {
            try {
                const workbook = XLSX.utils.book_new();
                const today = new Date().toLocaleDateString('th-TH');
                
                // Stock report
                const stockData = [];
                stockData.push(['รายงานสต๊อกวัตถุดิบ - SmartStock อ.ส.ค.', '', '', '', '', '', '']);
                stockData.push(['วันที่:', today, '', '', '', '', '']);
                stockData.push(['', '', '', '', '', '', '']);
                stockData.push(['รหัส', 'ชื่อวัตถุดิบ', 'แผนก', 'สต๊อก (กก.)', 'ราคา/กก.', 'มูลค่า (บาท)', 'วันหมดอายุ']);
                
                // Add farm items
                Object.entries(demoData.items.farm).forEach(([code, item]) => {
                    const totalValue = item.stock * item.pricePerKg;
                    stockData.push([code, item.name, 'ฟาร์มโคนม', item.stock, item.pricePerKg.toFixed(2), totalValue.toFixed(2), new Date(item.expiryDate).toLocaleDateString('th-TH')]);
                });
                
                // Add breeding items
                Object.entries(demoData.items.breeding).forEach(([code, item]) => {
                    const totalValue = item.stock * item.pricePerKg;
                    stockData.push([code, item.name, 'ผลิตน้ำเชื้อ', item.stock, item.pricePerKg.toFixed(2), totalValue.toFixed(2), new Date(item.expiryDate).toLocaleDateString('th-TH')]);
                });
                
                const stockSheet = XLSX.utils.aoa_to_sheet(stockData);
                XLSX.utils.book_append_sheet(workbook, stockSheet, 'สต๊อกปัจจุบัน');
                
                // Requisitions report
                if (demoData.requisitions.length > 0) {
                    const reqData = [];
                    reqData.push(['รายงานใบเบิก TMR', '', '', '', '', '', '', '']);
                    reqData.push(['วันที่:', today, '', '', '', '', '', '']);
                    reqData.push(['', '', '', '', '', '', '', '']);
                    reqData.push(['รหัสใบเบิก', 'วันที่เบิก', 'กะ', 'ผู้เบิก', 'สถานะ', 'รวมจำนวน (กก.)', 'มูลค่า (บาท)', 'ผู้อนุมัติ']);
                    
                    demoData.requisitions.forEach(req => {
                        const statusText = req.status === 'pending' ? 'รออนุมัติ' : 
                                         req.status === 'approved' ? 'อนุมัติแล้ว' : 'ไม่อนุมัติ';
                        reqData.push([
                            req.id,
                            new Date(req.date).toLocaleDateString('th-TH'),
                            req.shiftText,
                            req.requester,
                            statusText,
                            req.totalQuantity,
                            req.totalValue.toFixed(2),
                            req.approver || '-'
                        ]);
                    });
                    
                    const reqSheet = XLSX.utils.aoa_to_sheet(reqData);
                    XLSX.utils.book_append_sheet(workbook, reqSheet, 'ใบเบิก TMR');
                }
                
                // Transactions report
                if (demoData.transactions.length > 0) {
                    const txData = [];
                    txData.push(['รายงานการรับ-จ่ายวัตถุดิบ', '', '', '', '', '', '', '']);
                    txData.push(['วันที่:', today, '', '', '', '', '', '']);
                    txData.push(['', '', '', '', '', '', '', '']);
                    txData.push(['วันที่', 'เวลา', 'ประเภท', 'รายการ', 'จำนวน (กก.)', 'ราคา/กก.', 'มูลค่า (บาท)', 'ผู้บันทึก']);
                    
                    demoData.transactions.slice(0, 100).forEach(tx => { // Limit to 100 latest transactions
                        const typeText = tx.type === 'in' ? 'รับเข้า' : 'จ่ายออก';
                        txData.push([
                            new Date(tx.date).toLocaleDateString('th-TH'),
                            tx.time,
                            typeText,
                            tx.itemName,
                            tx.quantity,
                            tx.unitPrice.toFixed(2),
                            tx.totalPrice.toFixed(2),
                            tx.recorder
                        ]);
                    });
                    
                    const txSheet = XLSX.utils.aoa_to_sheet(txData);
                    XLSX.utils.book_append_sheet(workbook, txSheet, 'รายการรับ-จ่าย');
                }
                
                const fileName = `SmartStock-Report-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);
                showNotification('ส่งออกไฟล์ Excel เรียบร้อย', 'success');
            } catch (error) {
                console.error('Export Excel error:', error);
                showNotification('เกิดข้อผิดพลาดในการส่งออก Excel', 'error');
            }
        }

        function exportData() {
            try {
                const data = {
                    items: demoData.items,
                    transactions: demoData.transactions,
                    requisitions: demoData.requisitions,
                    settings: demoData.settings,
                    exportDate: new Date().toISOString(),
                    exportedBy: currentUser?.email || 'unknown',
                    version: '3.0'
                };
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `SmartStock-Data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                showNotification('ส่งออกข้อมูลเรียบร้อย', 'success');
            } catch (error) {
                showNotification('เกิดข้อผิดพลาดในการส่งออกข้อมูล', 'error');
            }
        }

        function backupData() {
            try {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const backupData = {
                    ...demoData,
                    backupDate: new Date().toISOString(),
                    backupBy: currentUser?.email || 'unknown',
                    version: '3.0',
                    systemInfo: {
                        userAgent: navigator.userAgent,
                        timestamp: timestamp,
                        totalItems: Object.keys(demoData.items.farm).length + Object.keys(demoData.items.breeding).length,
                        totalTransactions: demoData.transactions.length,
                        totalRequisitions: demoData.requisitions.length
                    }
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `SmartStock-Backup-${timestamp}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`สำรองข้อมูลเรียบร้อย\nไฟล์: SmartStock-Backup-${timestamp}.json`, 'success');
            } catch (error) {
                console.error('Backup error:', error);
                showNotification('เกิดข้อผิดพลาดในการสำรองข้อมูล', 'error');
            }
        }

        function refreshData() {
            updateStats();
            updateInventoryTables();
            if (currentUser) {
                if (currentUser.role === 'tmr') {
                    loadMyRequisitions();
                    if (document.getElementById('requisitionTableBody')) {
                        populateRequisitionTable();
                    }
                } else if (currentUser.role === 'admin' || currentUser.role === 'farm') {
                    loadPendingRequisitions();
                    loadApprovalHistory();
                }
                updateNotificationBadge();
                updateTransactionHistory();
                updateAlertsContent();
                if (document.getElementById('itemsList')) {
                    loadItemsList();
                }
            }
            showNotification('รีเฟรชข้อมูลเรียบร้อย', 'success');
        }

        // Event Listeners for Department and Item Selection
        document.addEventListener('change', function(e) {
            if (e.target.id === 'recordDepartment') {
                updateRecordItemsList();
            }
        });

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 SmartStock System v3.0 with Enhanced TMR Requisition Starting...');
            
            // Clear login fields for security
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            
            showLoginScreen();
            
            // Add sample requisitions for demo
            if (demoData.requisitions.length === 0) {
                const sampleRequisition = {
                    id: 'R' + Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    shift: 'morning',
                    shiftText: 'กะเช้า (05:00-12:00)',
                    requester: 'หน่วยผสม TMR',
                    requesterEmail: 'tmr@dairy.co.th',
                    status: 'pending',
                    items: [
                        { code: 'F002', name: 'อาหารข้น 16%', quantity: 100, pricePerKg: 10.11, availableStock: 9900 },
                        { code: 'F003', name: 'อาหารข้น 20% (ผสม TMR)', quantity: 150, pricePerKg: 11.675, availableStock: 21510 },
                        { code: 'F005', name: 'มันเส้น', quantity: 200, pricePerKg: 8.56, availableStock: 25560 }
                    ],
                    totalQuantity: 450,
                    totalValue: 3763.5,
                    createdAt: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), // 2 hours ago
                    approvedAt: null,
                    approver: null,
                    approverNotes: ''
                };
                demoData.requisitions.push(sampleRequisition);
            }
            
            // Add demo transactions for chart visualization
            if (demoData.transactions.length === 0) {
                const today = new Date();
                const demoTransactions = [];
                
                // Generate sample transactions for the last 6 months
                for (let monthsAgo = 6; monthsAgo >= 0; monthsAgo--) {
                    for (let day = 0; day < 5; day++) { // 5 transactions per month
                        const transactionDate = new Date(today.getFullYear(), today.getMonth() - monthsAgo, Math.floor(Math.random() * 28) + 1);
                        
                        // Random farm item usage
                        const farmItemCodes = Object.keys(demoData.items.farm);
                        const randomFarmCode = farmItemCodes[Math.floor(Math.random() * farmItemCodes.length)];
                        const farmItem = demoData.items.farm[randomFarmCode];
                        
                        // Incoming transaction
                        if (Math.random() > 0.7) { // 30% chance of incoming
                            demoTransactions.push({
                                id: 'T' + Date.now() + Math.random().toString(36).substr(2, 3),
                                date: transactionDate.toISOString().split('T')[0],
                                time: `${String(Math.floor(Math.random() * 12) + 8).padStart(2, '0')}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}`,
                                type: 'in',
                                itemCode: randomFarmCode,
                                itemName: farmItem.name,
                                department: 'farm',
                                quantity: Math.floor(Math.random() * 500) + 100,
                                unitPrice: farmItem.pricePerKg * (0.9 + Math.random() * 0.2), // ±10% price variation
                                totalPrice: 0, // Will be calculated
                                supplier: 'ผู้จำหน่าย ' + String.fromCharCode(65 + Math.floor(Math.random() * 5)),
                                recorder: 'ระบบ Demo',
                                notes: 'ข้อมูล Demo สำหรับทดสอบ',
                                documentRef: 'PO-' + Math.floor(Math.random() * 1000)
                            });
                        }
                        
                        // Outgoing transaction
                        demoTransactions.push({
                            id: 'T' + Date.now() + Math.random().toString(36).substr(2, 3),
                            date: transactionDate.toISOString().split('T')[0],
                            time: `${String(Math.floor(Math.random() * 12) + 8).padStart(2, '0')}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}`,
                            type: 'out',
                            itemCode: randomFarmCode,
                            itemName: farmItem.name,
                            department: 'farm',
                            quantity: Math.floor(Math.random() * 200) + 50,
                            unitPrice: farmItem.pricePerKg,
                            totalPrice: 0, // Will be calculated
                            supplier: 'การใช้งานภายใน',
                            recorder: 'ระบบ Demo',
                            notes: 'การใช้งานปกติ',
                            documentRef: 'USE-' + Math.floor(Math.random() * 1000)
                        });
                        
                        // Breeding item usage (less frequent)
                        if (Math.random() > 0.8) { // 20% chance
                            const breedingItemCodes = Object.keys(demoData.items.breeding);
                            const randomBreedingCode = breedingItemCodes[Math.floor(Math.random() * breedingItemCodes.length)];
                            const breedingItem = demoData.items.breeding[randomBreedingCode];
                            
                            demoTransactions.push({
                                id: 'T' + Date.now() + Math.random().toString(36).substr(2, 3),
                                date: transactionDate.toISOString().split('T')[0],
                                time: `${String(Math.floor(Math.random() * 12) + 8).padStart(2, '0')}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}`,
                                type: 'out',
                                itemCode: randomBreedingCode,
                                itemName: breedingItem.name,
                                department: 'breeding',
                                quantity: Math.floor(Math.random() * 50) + 10,
                                unitPrice: breedingItem.pricePerKg,
                                totalPrice: 0, // Will be calculated
                                supplier: 'การใช้งานภายใน',
                                recorder: 'ระบบ Demo',
                                notes: 'การใช้งานแผนกผลิตน้ำเชื้อ',
                                documentRef: 'USE-' + Math.floor(Math.random() * 1000)
                            });
                        }
                    }
                }
                
                // Calculate total prices
                demoTransactions.forEach(tx => {
                    tx.totalPrice = tx.quantity * tx.unitPrice;
                });
                
                demoData.transactions = demoTransactions;
            }
            
            // Initialize alert settings
            if (document.getElementById('lowStockPercent')) {
                document.getElementById('lowStockPercent').value = demoData.settings.lowStockPercent;
                document.getElementById('expiryDays').value = demoData.settings.expiryDays;
                document.getElementById('requisitionHours').value = demoData.settings.requisitionHours;
            }
        });

        // Event Listeners
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                if (document.getElementById('loginScreen').style.display !== 'none') {
                    doLogin();
                }
            }
            if (event.key === 'Escape') {
                closeRequisitionModal();
                closeItemModal();
            }
        });

        // Modal click outside to close
        document.getElementById('requisitionModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeRequisitionModal();
            }
        });

        document.getElementById('itemModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeItemModal();
            }
        });

    </script>
</body>
</html>