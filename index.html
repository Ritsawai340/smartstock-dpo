<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartStock อ.ส.ค. - ระบบจัดการสต๊อกวัตถุดิบอาหารโคนมอัจฉริยะ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; overflow-x: hidden; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); padding: 50px; border-radius: 25px; box-shadow: 0 25px 80px rgba(0,0,0,0.2); width: 100%; max-width: 450px; text-align: center; border: 1px solid rgba(255,255,255,0.3); animation: slideInUp 0.8s ease-out; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .login-logo { font-size: 5rem; margin-bottom: 25px; animation: float 3s ease-in-out infinite; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.2)); }
        .login-title { font-size: 2.2rem; margin-bottom: 15px; color: #2c3e50; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .login-subtitle { color: #7f8c8d; margin-bottom: 35px; font-size: 1.1rem; font-weight: 500; }
        .form-group { margin-bottom: 25px; text-align: left; }
        label { display: block; margin-bottom: 10px; font-weight: 700; color: #2c3e50; font-size: 1rem; }
        input, select, textarea { width: 100%; padding: 15px 20px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 1.05rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15); transform: translateY(-2px); }
        .btn { display: inline-block; padding: 15px 30px; border: none; border-radius: 12px; cursor: pointer; font-size: 1.05rem; font-weight: 700; text-decoration: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); margin: 5px; position: relative; overflow: hidden; text-transform: uppercase; letter-spacing: 1px; }
        .btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); transition: left 0.5s; }
        .btn:hover::before { left: 100%; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; box-shadow: 0 10px 30px rgba(108, 117, 125, 0.3); }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; box-shadow: 0 10px 30px rgba(220, 53, 69, 0.3); }
        .btn-warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529; box-shadow: 0 10px 30px rgba(255, 193, 7, 0.3); }
        .btn-info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; box-shadow: 0 10px 30px rgba(23, 162, 184, 0.3); }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(0,0,0,0.2); }
        .btn:active { transform: translateY(-1px); }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; min-width: 80px; height: 36px; display: flex; align-items: center; justify-content: center; }
        .header { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 25px; border-radius: 20px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; box-shadow: 0 15px 50px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); position: relative; overflow: hidden; }
        .header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #667eea, #764ba2, #667eea); background-size: 200% 100%; animation: shimmer 3s ease-in-out infinite; }
        .header h1 { color: #2c3e50; font-size: 2.2rem; margin-bottom: 5px; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header p { color: #7f8c8d; font-size: 1rem; font-weight: 500; }
        .user-info { display: flex; align-items: center; gap: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 12px 20px; border-radius: 30px; border: 1px solid rgba(0,0,0,0.05); }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .nav-tabs { display: flex; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 20px; padding: 8px; margin-bottom: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow-x: auto; border: 1px solid rgba(255,255,255,0.3); }
        .nav-tab { flex: 1; padding: 15px 20px; text-align: center; background: transparent; border: none; border-radius: 12px; cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); font-size: 1rem; font-weight: 600; white-space: nowrap; min-width: 140px; position: relative; overflow: hidden; }
        .nav-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transform: translateY(-3px); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); }
        .nav-tab:hover:not(.active) { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 20px; padding: 30px; margin-bottom: 25px; box-shadow: 0 15px 50px rgba(0,0,0,0.08); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(255,255,255,0.3); position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #667eea, #764ba2, #667eea); background-size: 200% 100%; animation: shimmer 3s ease-in-out infinite; }
        .card:hover { transform: translateY(-8px); box-shadow: 0 25px 80px rgba(0,0,0,0.15); }
        .card h3 { color: #2c3e50; margin-bottom: 25px; font-size: 1.6rem; font-weight: 700; background: linear-gradient(135deg, #2c3e50 0%, #667eea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 25px; }
        .stat-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 15px 50px rgba(0,0,0,0.08); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; }
        .stat-card.green::before { background: linear-gradient(90deg, #27ae60, #2ecc71); }
        .stat-card.blue::before { background: linear-gradient(90deg, #3498db, #2980b9); }
        .stat-card.orange::before { background: linear-gradient(90deg, #f39c12, #e67e22); }
        .stat-card.red::before { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .stat-card.purple::before { background: linear-gradient(90deg, #9b59b6, #8e44ad); }
        .stat-card:hover { transform: translateY(-10px) scale(1.02); box-shadow: 0 25px 80px rgba(0,0,0,0.15); }
        .stat-number { font-size: 3rem; font-weight: 800; margin-bottom: 12px; background: linear-gradient(135deg, #2c3e50 0%, #667eea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: pulse 2s ease-in-out infinite; }
        .stat-label { font-weight: 600; color: #7f8c8d; font-size: 1.1rem; }
        .quick-actions { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 25px; }
        .content-section { display: none; animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .content-section.active { display: block; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .hide { display: none !important; }
        .notification { position: fixed; top: 25px; right: 25px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 20px 25px; border-radius: 15px; box-shadow: 0 15px 50px rgba(0,0,0,0.2); z-index: 10000; transform: translateX(400px); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); max-width: 350px; border: 1px solid rgba(255,255,255,0.3); }
        .notification.show { transform: translateX(0); }
        .notification.success { border-left: 6px solid #28a745; }
        .notification.error { border-left: 6px solid #dc3545; }
        .notification.warning { border-left: 6px solid #ffc107; }
        .notification.info { border-left: 6px solid #17a2b8; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 40px; border-radius: 20px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.3); animation: scaleIn 0.3s ease-out; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        .modal h3 { color: #2c3e50; margin-bottom: 25px; font-size: 1.8rem; font-weight: 700; text-align: center; background: linear-gradient(135deg, #2c3e50 0%, #667eea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .modal-buttons { display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px; flex-wrap: wrap; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .alert { padding: 20px 25px; border-radius: 15px; margin-bottom: 25px; border-left: 6px solid; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .alert-success { background: rgba(212, 237, 218, 0.9); border-color: #28a745; color: #155724; }
        .alert-warning { background: rgba(255, 243, 205, 0.9); border-color: #ffc107; color: #856404; }
        .alert-danger { background: rgba(248, 215, 218, 0.9); border-color: #dc3545; color: #721c24; }
        .alert-info { background: rgba(209, 236, 241, 0.9); border-color: #17a2b8; color: #0c5460; }
        .table-container { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 15px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); margin-bottom: 25px; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 18px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .table th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; font-size: 0.95rem; }
        .table tr:hover { background: rgba(102, 126, 234, 0.05); transform: scale(1.01); transition: all 0.3s ease; }
        .status-badge { padding: 8px 16px; border-radius: 25px; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .status-normal { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; border: 1px solid #b8dacc; }
        .status-warning { background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); color: #856404; border: 1px solid #f5c842; }
        .status-danger { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); color: #721c24; border: 1px solid #f1aeb5; }
        .status-pending { background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); color: #0c5460; border: 1px solid #b8daff; }
        .status-approved { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; border: 1px solid #b8dacc; }
        .status-rejected { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); color: #721c24; border: 1px solid #f1aeb5; }

        /* TMR Requisition Styles */
        .requisition-form { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 20px; padding: 30px; margin-bottom: 25px; border: 2px solid rgba(102, 126, 234, 0.2); }
        .requisition-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; }
        .shift-buttons { display: flex; gap: 15px; margin-bottom: 20px; }
        .shift-btn { padding: 12px 25px; border: 2px solid #667eea; border-radius: 12px; background: white; color: #667eea; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        .shift-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .shift-btn:hover:not(.active) { background: rgba(102, 126, 234, 0.1); }
        .requisition-items { background: white; border-radius: 15px; padding: 25px; }
        .requisition-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 5px solid #17a2b8; }
        .requisition-card.pending { border-left-color: #ffc107; }
        .requisition-card.approved { border-left-color: #28a745; }
        .requisition-card.rejected { border-left-color: #dc3545; }
        .requisition-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .summary-item { padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; text-align: center; }
        .summary-value { font-size: 1.2rem; font-weight: bold; color: #2c3e50; }
        .summary-label { font-size: 0.9rem; color: #666; }
        .notification-badge { position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        @media (max-width: 768px) { 
            .container { padding: 15px; } 
            .header { flex-direction: column; text-align: center; padding: 20px; } 
            .header h1 { font-size: 1.8rem; } 
            .nav-tabs { flex-direction: column; gap: 5px; } 
            .nav-tab { padding: 15px 20px; margin-bottom: 0; } 
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; } 
            .quick-actions { justify-content: center; } 
            .table-container { overflow-x: auto; } 
            .table { min-width: 600px; } 
            .table th, .table td { padding: 12px 10px; font-size: 0.9rem; } 
            .form-grid { grid-template-columns: 1fr; } 
            .requisition-header { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">🐄</div>
            <h2 class="login-title">SmartStock อ.ส.ค.</h2>
            <p class="login-subtitle">ระบบจัดการสต๊อกวัตถุดิบอาหารโคนมอัจฉริยะ<br>องค์การส่งเสริมกิจการโคนมแห่งประเทศไทย</p>
            
            <div class="form-group">
                <label>อีเมล</label>
                <input type="email" id="loginEmail" placeholder="example@dairy.co.th" required>
            </div>
            <div class="form-group">
                <label>รหัสผ่าน</label>
                <input type="password" id="loginPassword" placeholder="กรุณากรอกรหัสผ่าน" required>
            </div>
            <div class="form-group">
                <button class="btn btn-primary" onclick="doLogin()" style="width: 100%;">
                    🔐 เข้าสู่ระบบ
                </button>
            </div>



            <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%); padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px solid rgba(255,193,7,0.3); text-align: center;">
                <div style="font-size: 0.9rem; color: #e65100; margin-bottom: 5px;">
                    <strong>🔒 ข้อมูลความปลอดภัย</strong>
                </div>
                <div style="color: #bf360c; font-size: 0.8rem; line-height: 1.4;">
                    กรุณาอย่าแบ่งปันข้อมูลการเข้าสู่ระบบให้ผู้อื่น<br>
                    และออกจากระบบทุกครั้งหลังใช้งานเสร็จ
                </div>
            </div>

            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); padding: 20px; border-radius: 15px; margin-top: 25px; border: 1px solid rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 1.2rem; margin-bottom: 10px;">📞 ช่วยเหลือและสนับสนุน</div>
                <div style="color: #555; font-size: 0.95rem; line-height: 1.5;">
                    <strong>หากมีปัญหาในการใช้งาน หรือต้องการปรึกษาเพิ่มเติม</strong><br>
                    กรุณาติดต่อ: <strong style="color: #1976d2;">แผนกวิชาการโคนม</strong><br>
                    <small style="color: #666;">ฝ่ายวิจัยและพัฒนาการเลี้ยงโคนม</small><br><br>
                    <small style="color: #888; font-style: italic;">
                        💡 สำหรับการเข้าสู่ระบบ กรุณาใช้บัญชีที่ได้รับจากหน่วยงาน
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="container hide" id="mainApp">
        <div class="header">
            <div>
                <h1>🚀 SmartStock อ.ส.ค.</h1>
                <p>ระบบจัดการสต๊อกวัตถุดิบอาหารโคนมอัจฉริยะ</p>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <span id="userName">Admin</span>
                <div style="position: relative;">
                    <button class="btn btn-warning" id="notificationBtn" onclick="showNotifications()" style="position: relative;">
                        🔔 แจ้งเตือน
                    </button>
                    <span class="notification-badge hide" id="notificationBadge">0</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">🚪 ออกจากระบบ</button>
            </div>
        </div>

        <div class="nav-tabs" id="mainNavigation">
            <button class="nav-tab active" onclick="showSection('dashboard')">📊 ภาพรวม</button>
            <button class="nav-tab" onclick="showSection('inventory')">📦 สต๊อก</button>
            <button class="nav-tab" onclick="showSection('record')">📝 บันทึก</button>
            <button class="nav-tab" onclick="showSection('requisition')" id="requisitionTab" style="display: none;">📋 ใบเบิก TMR</button>
            <button class="nav-tab" onclick="showSection('approval')" id="approvalTab" style="display: none;">✅ อนุมัติ</button>
            <button class="nav-tab" onclick="showSection('reports')">📈 รายงาน</button>
            <button class="nav-tab" onclick="showSection('alerts')">🚨 แจ้งเตือน</button>
            <button class="nav-tab" onclick="showSection('management')">⚙️ จัดการรายการ</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card green">
                    <div class="stat-number" id="totalItems">13</div>
                    <div class="stat-label">รายการทั้งหมด</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-number" id="totalValue">0</div>
                    <div class="stat-label">มูลค่ารวม (บาท)</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-number" id="lowStock">0</div>
                    <div class="stat-label">สต๊อกต่ำ</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-number" id="pendingRequisitions">0</div>
                    <div class="stat-label">ใบเบิกรออนุมัติ</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-number" id="expiredItems">0</div>
                    <div class="stat-label">หมดอายุแล้ว</div>
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="refreshData()">🔄 รีเฟรชข้อมูล</button>
                <button class="btn btn-success" onclick="exportToExcel()">📊 Export Excel</button>
                <button class="btn btn-secondary" onclick="exportData()">📄 Export JSON</button>
                <button class="btn btn-info" onclick="backupData()">💾 สำรองข้อมูล</button>
            </div>

            <div class="card">
                <h3>📊 สรุปมูลค่าสต๊อกตามแผนก</h3>
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-number" id="farmValue">0</div>
                        <div class="stat-label">ฟาร์มโคนม (บาท)</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-number" id="breedingValue">0</div>
                        <div class="stat-label">ผลิตน้ำเชื้อ (บาท)</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>🔄 กิจกรรมล่าสุด</h3>
                <div id="recentActivities">
                    <p style="color: #7f8c8d; font-style: italic;">ยังไม่มีกิจกรรม</p>
                </div>
            </div>
        </div>

        <!-- Inventory Section -->
        <div id="inventory" class="content-section">
            <div class="card">
                <h3>🌾 สต๊อกวัตถุดิบแผนกฟาร์มโคนม</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>รายการ</th>
                                <th>คงเหลือ (กก.)</th>
                                <th>ราคา/กก.</th>
                                <th>มูลค่า (บาท)</th>
                                <th>วันหมดอายุ</th>
                                <th>สถานะ</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="farmInventoryTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">กำลังโหลดข้อมูล...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>🐂 สต๊อกอาหารแผนกผลิตน้ำเชื้อ</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>รายการ</th>
                                <th>คงเหลือ (กก.)</th>
                                <th>ราคา/กก.</th>
                                <th>มูลค่า (บาท)</th>
                                <th>วันหมดอายุ</th>
                                <th>สถานะ</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="breedingInventoryTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">กำลังโหลดข้อมูล...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Record Section -->
        <div id="record" class="content-section">
            <div class="card">
                <h3>📝 บันทึกการรับ-จ่ายวัตถุดิบ (Admin/Manager)</h3>
                <div class="alert alert-info">
                    <strong>ℹ️ หมายเหตุ:</strong> 
                    สำหรับการเบิกใช้ TMR ประจำวัน กรุณาใช้ระบบ "ใบเบิก TMR" เพื่อความสะดวกและการควบคุมที่ดีกว่า
                </div>
                <p style="color: #666; margin-bottom: 20px;">
                    หน้านี้สำหรับการบันทึกการรับเข้าวัตถุดิบใหม่ หรือการจ่ายออกพิเศษที่ไม่ใช่การเบิก TMR ปกติ
                </p>
            </div>
        </div>

        <!-- TMR Requisition Section -->
        <div id="requisition" class="content-section">
            <div class="card">
                <h3>📋 ใบเบิกวัตถุดิบ TMR</h3>
                <div class="requisition-form">
                    <div class="requisition-header">
                        <div>
                            <h4 style="margin: 0; color: #2c3e50;">🌾 สร้างใบเบิกใหม่</h4>
                            <p style="color: #666; margin: 5px 0 0 0; font-size: 1.1rem;">เลือกกะ วันที่ และรายการวัตถุดิบที่ต้องการเบิก</p>
                        </div>
                        <div>
                            <button class="btn btn-success" onclick="submitRequisition()" style="font-size: 1.2rem; padding: 18px 35px;">
                                📤 ส่งใบเบิก
                            </button>
                            <button class="btn btn-secondary" onclick="clearRequisition()">🗑️ ล้างข้อมูล</button>
                        </div>
                    </div>

                    <div class="form-grid" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label>วันที่</label>
                            <input type="date" id="requisitionDate" required style="font-size: 1.1rem;">
                        </div>
                        <div class="form-group">
                            <label>กะการทำงาน</label>
                            <div class="shift-buttons">
                                <button type="button" class="shift-btn active" onclick="selectShift('morning')" id="morningShift">
                                    🌅 กะเช้า (05:00-12:00)
                                </button>
                                <button type="button" class="shift-btn" onclick="selectShift('afternoon')" id="afternoonShift">
                                    🌇 กะบ่าย (13:00-20:00)
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="requisition-items">
                        <h5 style="margin-bottom: 20px; color: #2c3e50;">🌾 เลือกวัตถุดิบที่ต้องการเบิก</h5>
                        <p style="color: #666; margin-bottom: 20px; font-size: 1.1rem;">
                            ✅ <strong>ติ๊กเลือกรายการ</strong> และ <strong>ใส่จำนวนที่ต้องการ</strong> (หน่วย: กิโลกรัม)
                        </p>
                        
                        <div class="table-container" style="margin-bottom: 20px;">
                            <table class="table" id="requisitionItemsTable">
                                <thead>
                                    <tr>
                                        <th style="width: 60px; text-align: center;">เลือก</th>
                                        <th>รายการวัตถุดิบ</th>
                                        <th style="width: 150px; text-align: center;">สต๊อกคงเหลือ (กก.)</th>
                                        <th style="width: 150px; text-align: center;">จำนวนที่เบิก (กก.)</th>
                                        <th style="width: 120px; text-align: center;">ราคา/กก.</th>
                                        <th style="width: 150px; text-align: center;">มูลค่า (บาท)</th>
                                    </tr>
                                </thead>
                                <tbody id="requisitionTableBody">
                                    <!-- Items will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                            <button class="btn btn-warning" onclick="selectAllItems()" style="font-size: 1.1rem; padding: 15px 25px;">
                                ☑️ เลือกทั้งหมด
                            </button>
                            <button class="btn btn-secondary" onclick="clearAllSelections()" style="font-size: 1.1rem; padding: 15px 25px;">
                                ❌ ยกเลิกการเลือก
                            </button>
                        </div>
                    </div>

                    <div class="requisition-summary" id="requisitionSummary" style="margin-top: 20px; display: none;">
                        <div class="summary-item">
                            <div class="summary-value" id="totalItems">0</div>
                            <div class="summary-label">รายการ</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="totalQuantity">0</div>
                            <div class="summary-label">รวม (กก.)</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="estimatedValue">0</div>
                            <div class="summary-label">มูลค่าประมาณ (บาท)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Requisitions -->
            <div class="card">
                <h3>📄 ใบเบิกของฉัน</h3>
                <div id="myRequisitions">
                    <div class="alert alert-info">
                        <strong>ℹ️ ข้อมูล:</strong> ยังไม่มีใบเบิกในระบบ
                    </div>
                </div>
            </div>
        </div>

        <!-- Approval Section -->
        <div id="approval" class="content-section">
            <div class="card">
                <h3>✅ อนุมัติใบเบิก TMR</h3>
                <div class="pending-requisitions">
                    <h4 style="color: #2c3e50; margin-bottom: 20px;">📋 ใบเบิกรออนุมัติ</h4>
                    <div id="pendingRequisitionsList">
                        <div class="alert alert-info">
                            <strong>ℹ️ ข้อมูล:</strong> ไม่มีใบเบิกรออนุมัติในขณะนี้
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h4 style="color: #2c3e50; margin-bottom: 20px;">📚 ประวัติการอนุมัติ</h4>
                    <div id="approvalHistory">
                        <div class="alert alert-info">
                            <strong>ℹ️ ข้อมูล:</strong> ยังไม่มีประวัติการอนุมัติ
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports" class="content-section">
            <div class="card">
                <h3>📈 รายงานการใช้งานวัตถุดิบ</h3>
                <div class="alert alert-info">
                    <strong>ℹ️ คำแนะนำ:</strong> รายงานในส่วนนี้จะแสดงข้อมูลทั้งการบันทึกปกติและการเบิกผ่านระบบใบเบิก TMR
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div id="alerts" class="content-section">
            <div class="card">
                <h3>🚨 การแจ้งเตือนสำคัญ</h3>
                <div id="alertsContent">
                    <div class="alert alert-info">
                        <strong>ℹ️ สถานะ:</strong> ระบบพร้อมใช้งาน ข้อมูลถูกอัพเดทแบบ Real-time
                    </div>
                </div>
            </div>
        </div>

        <!-- Management Section -->
        <div id="management" class="content-section">
            <div class="card">
                <h3>⚙️ จัดการรายการอาหาร/วัตถุดิบ</h3>
                <div class="alert alert-info">
                    <strong>ℹ️ ข้อมูล:</strong> ฟีเจอร์จัดการรายการยังคงเหมือนเดิม
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <!-- Requisition Detail Modal -->
    <div class="modal" id="requisitionModal">
        <div class="modal-content">
            <h3 id="requisitionModalTitle">📋 รายละเอียดใบเบิก</h3>
            <div id="requisitionModalContent"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeRequisitionModal()">❌ ปิด</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let currentShift = 'morning';

        // Enhanced Login Data with TMR operator
        const users = {
            'admin@dairy.co.th': { name: 'ผู้บริหาร', password: 'admin123', role: 'admin', department: 'all' },
            'farm@dairy.co.th': { name: 'แผนกฟาร์มโคนม', password: 'farm123', role: 'farm', department: 'farm' },
            'breeding@dairy.co.th': { name: 'แผนกผลิตน้ำเชื้อและพิสูจน์พันธุ์', password: 'breed123', role: 'breeding', department: 'breeding' },
            'tmr@dairy.co.th': { name: 'หน่วยผสม TMR', password: 'tmr123', role: 'tmr', department: 'farm' }
        };

        // Enhanced Demo Data with requisitions
        const demoData = {
            items: {
                farm: {
                    'F001': { name: 'อาหารลูกโค CP 973', stock: 840, pricePerKg: 19.00, reorderPoint: 500, expiryDate: '2026-12-31', lastModified: new Date().toISOString(), notes: 'อาหารลูกโค คุณภาพสูง' },
                    'F002': { name: 'อาหารข้น 16%', stock: 9900, pricePerKg: 10.11, reorderPoint: 1000, expiryDate: '2026-06-30', lastModified: new Date().toISOString(), notes: 'อาหารข้นโปรตีน 16%' },
                    'F003': { name: 'อาหารข้น 20% (ผสม TMR)', stock: 21510, pricePerKg: 11.675, reorderPoint: 800, expiryDate: '2026-06-30', lastModified: new Date().toISOString(), notes: 'อาหารข้นโปรตีน 20% สำหรับผสม TMR' },
                    'F004': { name: 'กากถั่วเหลือง', stock: 4600, pricePerKg: 18.00, reorderPoint: 1000, expiryDate: '2025-12-31', lastModified: new Date().toISOString(), notes: 'กากถั่วเหลือง คุณภาพดี' },
                    'F005': { name: 'มันเส้น', stock: 25560, pricePerKg: 8.56, reorderPoint: 2000, expiryDate: '2025-12-31', lastModified: new Date().toISOString(), notes: 'มันเส้น แห้งดี' },
                    'F006': { name: 'MC Miner', stock: 475, pricePerKg: 350.00, reorderPoint: 200, expiryDate: '2027-12-31', lastModified: new Date().toISOString(), notes: 'แร่ธาตุผสม MC Miner' },
                    'F007': { name: 'ไขมันผง', stock: 1100, pricePerKg: 55.00, reorderPoint: 100, expiryDate: '2026-03-31', lastModified: new Date().toISOString(), notes: 'ไขมันผง คุณภาพสูง' },
                    'F008': { name: 'แร่ธาตุ', stock: 425, pricePerKg: 9.42, reorderPoint: 200, expiryDate: '2027-12-31', lastModified: new Date().toISOString(), notes: 'แร่ธาตุผสม' },
                    'F009': { name: 'พรีมิกซ์', stock: 640, pricePerKg: 47.88, reorderPoint: 50, expiryDate: '2026-12-31', lastModified: new Date().toISOString(), notes: 'วิตามินและแร่ธาตุผสม' }
                },
                breeding: {
                    'B001': { name: 'อาหารข้น 16%', stock: 7170, pricePerKg: 14.17, reorderPoint: 500, expiryDate: '2026-06-30', lastModified: new Date().toISOString(), notes: 'อาหารข้นสำหรับโคพันธุ์' },
                    'B002': { name: 'แร่ธาตุ', stock: 50, pricePerKg: 10.90, reorderPoint: 100, expiryDate: '2027-12-31', lastModified: new Date().toISOString(), notes: 'แร่ธาตุสำหรับโคพันธุ์' },
                    'B003': { name: 'พรีมิกซ์', stock: 210, pricePerKg: 95.76, reorderPoint: 25, expiryDate: '2026-12-31', lastModified: new Date().toISOString(), notes: 'วิตามินและแร่ธาตุสำหรับโคพันธุ์' }
                }
            },
            transactions: [],
            requisitions: [],
            settings: { lowStockPercent: 20, expiryDays: 7, alertEmail: 'admin@dairy.co.th' }
        };

        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type} show`;
            notification.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center;"><span><strong>${message}</strong></span><button onclick="hideNotification()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">×</button></div>`;
            setTimeout(() => hideNotification(), 5000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        function generateId() {
            return 'R' + Date.now() + Math.random().toString(36).substr(2, 5);
        }

        // Login Functions
        function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showNotification('กรุณากรอกอีเมลและรหัสผ่าน', 'error');
                return;
            }
            
            const user = users[email];
            if (user && user.password === password) {
                currentUser = {
                    name: user.name,
                    email: email,
                    role: user.role,
                    department: user.department,
                    lastLogin: new Date().toISOString()
                };
                
                showNotification('เข้าสู่ระบบสำเร็จ!', 'success');
                document.getElementById('loginPassword').value = '';
                showMainApp();
            } else {
                showNotification('อีเมลหรือรหัสผ่านไม่ถูกต้อง', 'error');
                document.getElementById('loginPassword').value = '';
            }
        }

        function logout() {
            if (confirm('คุณต้องการออกจากระบบใช่หรือไม่?')) {
                currentUser = null;
                showLoginScreen();
                showNotification('ออกจากระบบเรียบร้อย', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        }

        // App Functions
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.add('hide');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hide');
            
            if (currentUser) {
                document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
                document.getElementById('userName').textContent = currentUser.name;
                setupNavigationByRole();
                setupCurrentDateTime();
                updateStats();
                updateInventoryTables();
                loadRequisitions();
                updateNotificationBadge();
            }
        }

        function setupNavigationByRole() {
            const requisitionTab = document.getElementById('requisitionTab');
            const approvalTab = document.getElementById('approvalTab');
            
            if (currentUser.role === 'tmr') {
                // TMR operator can only see requisition tab
                requisitionTab.style.display = 'block';
                approvalTab.style.display = 'none';
                // Hide other tabs except dashboard
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    if (tab.id !== 'requisitionTab' && !tab.onclick.toString().includes('dashboard')) {
                        tab.style.display = 'none';
                    }
                });
            } else if (currentUser.role === 'admin' || currentUser.role === 'farm') {
                // Admin and farm managers can see approval tab
                requisitionTab.style.display = 'none';
                approvalTab.style.display = 'block';
            } else {
                // Others don't see these tabs
                requisitionTab.style.display = 'none';
                approvalTab.style.display = 'none';
            }
        }

        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');

            if (sectionName === 'requisition') {
                setupRequisitionForm();
                loadMyRequisitions();
            } else if (sectionName === 'approval') {
                loadPendingRequisitions();
                loadApprovalHistory();
            } else if (sectionName === 'inventory') {
                updateInventoryTables();
            }
        }

        function setupCurrentDateTime() {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            document.getElementById('requisitionDate').value = dateStr;
        }

        // TMR Requisition Functions
        function setupRequisitionForm() {
            populateRequisitionTable();
            clearRequisition();
        }

        function populateRequisitionTable() {
            const tbody = document.getElementById('requisitionTableBody');
            tbody.innerHTML = '';
            
            // Get all farm items
            const farmItems = demoData.items.farm || {};
            
            Object.entries(farmItems).forEach(([code, item]) => {
                const row = document.createElement('tr');
                row.style.backgroundColor = 'rgba(255,255,255,0.8)';
                
                const stockStatus = item.stock === 0 ? 
                    '<span style="color: #dc3545; font-weight: bold;">❌ หมด</span>' : 
                    `<span style="color: #28a745; font-weight: bold;">${item.stock.toLocaleString()}</span>`;
                
                row.innerHTML = `
                    <td style="text-align: center;">
                        <input type="checkbox" id="item_${code}" onchange="onItemCheck('${code}')" 
                               style="transform: scale(1.5); cursor: pointer;" 
                               ${item.stock === 0 ? 'disabled' : ''}>
                    </td>
                    <td>
                        <div style="font-weight: bold; font-size: 1.1rem; color: #2c3e50;">${item.name}</div>
                        <div style="color: #666; font-size: 0.9rem;">รหัส: ${code}</div>
                        ${item.stock <= item.reorderPoint * 0.2 ? '<div style="color: #ffc107; font-size: 0.8rem;">⚠️ สต๊อกต่ำ</div>' : ''}
                    </td>
                    <td style="text-align: center; font-size: 1.1rem;">
                        ${stockStatus}
                    </td>
                    <td style="text-align: center;">
                        <input type="number" id="qty_${code}" 
                               min="0" max="${item.stock}" step="0.1" 
                               placeholder="0" 
                               style="width: 100%; padding: 10px; font-size: 1.1rem; text-align: center; border: 2px solid #e9ecef; border-radius: 8px; font-weight: bold;"
                               onchange="onQuantityChange('${code}')"
                               oninput="onQuantityChange('${code}')"
                               ${item.stock === 0 ? 'disabled' : ''}>
                    </td>
                    <td style="text-align: center; font-size: 1rem; color: #666;">
                        ${item.pricePerKg.toFixed(2)}
                    </td>
                    <td style="text-align: center;">
                        <div id="value_${code}" style="font-weight: bold; font-size: 1.1rem; color: #27ae60;">0</div>
                    </td>
                `;
                
                // Add hover effect
                row.addEventListener('mouseenter', function() {
                    if (item.stock > 0) {
                        this.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
                        this.style.transform = 'scale(1.01)';
                        this.style.transition = 'all 0.2s ease';
                    }
                });
                
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'rgba(255,255,255,0.8)';
                    this.style.transform = 'scale(1)';
                });
                
                tbody.appendChild(row);
            });
        }

        function onItemCheck(code) {
            const checkbox = document.getElementById(`item_${code}`);
            const quantityInput = document.getElementById(`qty_${code}`);
            
            if (checkbox.checked) {
                quantityInput.style.borderColor = '#667eea';
                quantityInput.style.backgroundColor = '#f8f9ff';
                quantityInput.focus();
            } else {
                quantityInput.style.borderColor = '#e9ecef';
                quantityInput.style.backgroundColor = 'white';
                quantityInput.value = '';
                onQuantityChange(code);
            }
            
            updateRequisitionSummary();
        }

        function onQuantityChange(code) {
            const checkbox = document.getElementById(`item_${code}`);
            const quantityInput = document.getElementById(`qty_${code}`);
            const valueDiv = document.getElementById(`value_${code}`);
            const item = demoData.items.farm[code];
            
            let quantity = parseFloat(quantityInput.value) || 0;
            
            // Validate quantity
            if (quantity > item.stock) {
                quantity = item.stock;
                quantityInput.value = quantity;
                showNotification(`จำนวนเกินสต๊อกที่มี (${item.name}: คงเหลือ ${item.stock.toLocaleString()} กก.)`, 'warning');
            }
            
            if (quantity < 0) {
                quantity = 0;
                quantityInput.value = '';
            }
            
            // Auto check/uncheck based on quantity
            if (quantity > 0) {
                checkbox.checked = true;
                quantityInput.style.borderColor = '#667eea';
                quantityInput.style.backgroundColor = '#f8f9ff';
            } else {
                checkbox.checked = false;
                quantityInput.style.borderColor = '#e9ecef';
                quantityInput.style.backgroundColor = 'white';
            }
            
            // Calculate value
            const value = quantity * item.pricePerKg;
            valueDiv.textContent = value > 0 ? value.toLocaleString() : '0';
            
            updateRequisitionSummary();
        }

        function selectAllItems() {
            const farmItems = demoData.items.farm || {};
            let selectedCount = 0;
            
            Object.keys(farmItems).forEach(code => {
                const item = farmItems[code];
                if (item.stock > 0) {
                    const checkbox = document.getElementById(`item_${code}`);
                    const quantityInput = document.getElementById(`qty_${code}`);
                    
                    checkbox.checked = true;
                    quantityInput.style.borderColor = '#667eea';
                    quantityInput.style.backgroundColor = '#f8f9ff';
                    
                    // Set a default quantity if not already set
                    if (!quantityInput.value) {
                        const defaultQty = Math.min(10, Math.floor(item.stock * 0.1)); // 10% of stock or 10kg, whichever is less
                        if (defaultQty > 0) {
                            quantityInput.value = defaultQty;
                            onQuantityChange(code);
                        }
                    }
                    selectedCount++;
                }
            });
            
            updateRequisitionSummary();
            showNotification(`เลือกรายการทั้งหมด ${selectedCount} รายการแล้ว`, 'info');
        }

        function clearAllSelections() {
            const farmItems = demoData.items.farm || {};
            
            Object.keys(farmItems).forEach(code => {
                const checkbox = document.getElementById(`item_${code}`);
                const quantityInput = document.getElementById(`qty_${code}`);
                const valueDiv = document.getElementById(`value_${code}`);
                
                checkbox.checked = false;
                quantityInput.value = '';
                quantityInput.style.borderColor = '#e9ecef';
                quantityInput.style.backgroundColor = 'white';
                valueDiv.textContent = '0';
            });
            
            updateRequisitionSummary();
            showNotification('ยกเลิกการเลือกทั้งหมดแล้ว', 'info');
        }

        function updateRequisitionSummary() {
            const farmItems = demoData.items.farm || {};
            let totalItems = 0;
            let totalQuantity = 0;
            let totalValue = 0;
            
            Object.keys(farmItems).forEach(code => {
                const checkbox = document.getElementById(`item_${code}`);
                const quantityInput = document.getElementById(`qty_${code}`);
                
                if (checkbox && checkbox.checked) {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    if (quantity > 0) {
                        totalItems++;
                        totalQuantity += quantity;
                        totalValue += quantity * farmItems[code].pricePerKg;
                    }
                }
            });
            
            const summary = document.getElementById('requisitionSummary');
            if (totalItems > 0) {
                document.getElementById('totalItems').textContent = totalItems;
                document.getElementById('totalQuantity').textContent = totalQuantity.toLocaleString();
                document.getElementById('estimatedValue').textContent = totalValue.toLocaleString();
                summary.style.display = 'block';
            } else {
                summary.style.display = 'none';
            }
        }

        function selectShift(shift) {
            currentShift = shift;
            document.getElementById('morningShift').classList.toggle('active', shift === 'morning');
            document.getElementById('afternoonShift').classList.toggle('active', shift === 'afternoon');
        }

        function clearRequisition() {
            clearAllSelections();
            currentShift = 'morning';
            selectShift('morning');
            showNotification('ล้างข้อมูลใบเบิกแล้ว', 'info');
        }

        function submitRequisition() {
            const date = document.getElementById('requisitionDate').value;
            if (!date) {
                showNotification('กรุณาเลือกวันที่', 'error');
                return;
            }
            
            // Collect selected items from table
            const selectedItems = [];
            const farmItems = demoData.items.farm || {};
            
            Object.keys(farmItems).forEach(code => {
                const checkbox = document.getElementById(`item_${code}`);
                const quantityInput = document.getElementById(`qty_${code}`);
                
                if (checkbox && checkbox.checked) {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    if (quantity > 0) {
                        const item = farmItems[code];
                        selectedItems.push({
                            code: code,
                            name: item.name,
                            quantity: quantity,
                            pricePerKg: item.pricePerKg,
                            availableStock: item.stock
                        });
                    }
                }
            });
            
            if (selectedItems.length === 0) {
                showNotification('กรุณาเลือกวัตถุดิบและระบุจำนวนก่อนส่งใบเบิก', 'error');
                return;
            }
            
            // Check stock availability again
            for (const reqItem of selectedItems) {
                const currentStock = demoData.items.farm[reqItem.code].stock;
                if (reqItem.quantity > currentStock) {
                    showNotification(`${reqItem.name} มีสต๊อกไม่เพียงพอ (คงเหลือ: ${currentStock.toLocaleString()} กก.)`, 'error');
                    return;
                }
            }
            
            const requisition = {
                id: generateId(),
                date: date,
                shift: currentShift,
                shiftText: currentShift === 'morning' ? 'กะเช้า (05:00-12:00)' : 'กะบ่าย (13:00-20:00)',
                requester: currentUser.name,
                requesterEmail: currentUser.email,
                status: 'pending',
                items: selectedItems,
                totalQuantity: selectedItems.reduce((sum, item) => sum + item.quantity, 0),
                totalValue: selectedItems.reduce((sum, item) => sum + (item.quantity * item.pricePerKg), 0),
                createdAt: new Date().toISOString(),
                approvedAt: null,
                approver: null,
                approverNotes: ''
            };
            
            demoData.requisitions.push(requisition);
            
            clearRequisition();
            loadMyRequisitions();
            updateStats();
            updateNotificationBadge();
            
            showNotification(`✅ ส่งใบเบิก ${requisition.id} เรียบร้อย\n\n📋 รายการ: ${selectedItems.length} รายการ\n📦 รวม: ${requisition.totalQuantity.toLocaleString()} กก.\n💰 มูลค่า: ${requisition.totalValue.toLocaleString()} บาท\n\n⏳ รอการอนุมัติจากผู้บริหาร`, 'success');
        }

        function loadMyRequisitions() {
            const container = document.getElementById('myRequisitions');
            const myRequisitions = demoData.requisitions.filter(req => req.requesterEmail === currentUser.email);
            
            if (myRequisitions.length === 0) {
                container.innerHTML = '<div class="alert alert-info"><strong>ℹ️ ข้อมูล:</strong> ยังไม่มีใบเบิกในระบบ</div>';
                return;
            }
            
            let html = '';
            myRequisitions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(req => {
                const statusClass = req.status === 'pending' ? 'pending' : 
                                  req.status === 'approved' ? 'approved' : 'rejected';
                const statusText = req.status === 'pending' ? 'รออนุมัติ' : 
                                 req.status === 'approved' ? 'อนุมัติแล้ว' : 'ไม่อนุมัติ';
                
                html += `
                    <div class="requisition-card ${statusClass}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h5 style="margin: 0; color: #2c3e50;">ใบเบิก ${req.id}</h5>
                                <p style="margin: 5px 0; color: #666;">
                                    ${new Date(req.date).toLocaleDateString('th-TH')} - ${req.shiftText}
                                </p>
                            </div>
                            <span class="status-badge status-${statusClass}">${statusText}</span>
                        </div>
                        
                        <div class="requisition-summary">
                            <div class="summary-item">
                                <div class="summary-value">${req.items.length}</div>
                                <div class="summary-label">รายการ</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value">${req.totalQuantity.toLocaleString()}</div>
                                <div class="summary-label">รวม (กก.)</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value">${req.totalValue.toLocaleString()}</div>
                                <div class="summary-label">มูลค่า (บาท)</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-info btn-sm" onclick="viewRequisitionDetails('${req.id}')">
                                👁️ ดูรายละเอียด
                            </button>
                            ${req.status === 'pending' ? `<button class="btn btn-danger btn-sm" onclick="cancelRequisition('${req.id}')">❌ ยกเลิก</button>` : ''}
                        </div>
                        
                        ${req.status === 'approved' && req.approver ? `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(40, 167, 69, 0.1); border-radius: 8px;">
                                <small><strong>อนุมัติโดย:</strong> ${req.approver} 
                                เมื่อ ${new Date(req.approvedAt).toLocaleDateString('th-TH')} ${new Date(req.approvedAt).toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'})}</small>
                            </div>
                        ` : ''}
                        
                        ${req.status === 'rejected' && req.approverNotes ? `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(220, 53, 69, 0.1); border-radius: 8px;">
                                <small><strong>หมายเหตุ:</strong> ${req.approverNotes}</small>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function loadPendingRequisitions() {
            const container = document.getElementById('pendingRequisitionsList');
            const pendingReqs = demoData.requisitions.filter(req => req.status === 'pending');
            
            if (pendingReqs.length === 0) {
                container.innerHTML = '<div class="alert alert-info"><strong>ℹ️ ข้อมูล:</strong> ไม่มีใบเบิกรออนุมัติในขณะนี้</div>';
                return;
            }
            
            let html = '';
            pendingReqs.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)).forEach(req => {
                html += `
                    <div class="requisition-card pending">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h5 style="margin: 0; color: #2c3e50;">ใบเบิก ${req.id}</h5>
                                <p style="margin: 5px 0; color: #666;">
                                    ${new Date(req.date).toLocaleDateString('th-TH')} - ${req.shiftText}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>ผู้เบิก:</strong> ${req.requester} | 
                                    <strong>ส่งเมื่อ:</strong> ${new Date(req.createdAt).toLocaleDateString('th-TH')} ${new Date(req.createdAt).toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'})}
                                </p>
                            </div>
                            <span class="status-badge status-pending">รออนุมัติ</span>
                        </div>
                        
                        <div class="requisition-summary">
                            <div class="summary-item">
                                <div class="summary-value">${req.items.length}</div>
                                <div class="summary-label">รายการ</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value">${req.totalQuantity.toLocaleString()}</div>
                                <div class="summary-label">รวม (กก.)</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value">${req.totalValue.toLocaleString()}</div>
                                <div class="summary-label">มูลค่า (บาท)</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-info btn-sm" onclick="viewRequisitionDetails('${req.id}')">
                                👁️ ดูรายละเอียด
                            </button>
                            <button class="btn btn-success btn-sm" onclick="approveRequisition('${req.id}')">
                                ✅ อนุมัติ
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="rejectRequisition('${req.id}')">
                                ❌ ไม่อนุมัติ
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function loadApprovalHistory() {
            const container = document.getElementById('approvalHistory');
            const processedReqs = demoData.requisitions.filter(req => req.status !== 'pending');
            
            if (processedReqs.length === 0) {
                container.innerHTML = '<div class="alert alert-info"><strong>ℹ️ ข้อมูล:</strong> ยังไม่มีประวัติการอนุมัติ</div>';
                return;
            }
            
            let html = '';
            processedReqs.sort((a, b) => new Date(b.approvedAt) - new Date(a.approvedAt)).forEach(req => {
                const statusClass = req.status === 'approved' ? 'approved' : 'rejected';
                const statusText = req.status === 'approved' ? 'อนุมัติแล้ว' : 'ไม่อนุมัติ';
                
                html += `
                    <div class="requisition-card ${statusClass}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h5 style="margin: 0; color: #2c3e50;">ใบเบิก ${req.id}</h5>
                                <p style="margin: 5px 0; color: #666;">
                                    ${new Date(req.date).toLocaleDateString('th-TH')} - ${req.shiftText}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>ผู้เบิก:</strong> ${req.requester} | 
                                    <strong>อนุมัติโดย:</strong> ${req.approver} |
                                    <strong>เมื่อ:</strong> ${new Date(req.approvedAt).toLocaleDateString('th-TH')} ${new Date(req.approvedAt).toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'})}
                                </p>
                            </div>
                            <span class="status-badge status-${statusClass}">${statusText}</span>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-info btn-sm" onclick="viewRequisitionDetails('${req.id}')">
                                👁️ ดูรายละเอียด
                            </button>
                        </div>
                        
                        ${req.approverNotes ? `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(108, 117, 125, 0.1); border-radius: 8px;">
                                <small><strong>หมายเหตุ:</strong> ${req.approverNotes}</small>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function approveRequisition(reqId) {
            const req = demoData.requisitions.find(r => r.id === reqId);
            if (!req) return;
            
            // Check stock availability before approval
            const unavailableItems = [];
            for (const item of req.items) {
                const currentStock = demoData.items.farm[item.code].stock;
                if (item.quantity > currentStock) {
                    unavailableItems.push(`${item.name} (ต้องการ: ${item.quantity.toLocaleString()} กก., คงเหลือ: ${currentStock.toLocaleString()} กก.)`);
                }
            }
            
            if (unavailableItems.length > 0) {
                showNotification(`ไม่สามารถอนุมัติได้ สต๊อกไม่เพียงพอ:\n${unavailableItems.join('\n')}`, 'error');
                return;
            }
            
            if (confirm(`คุณต้องการอนุมัติใบเบิก ${reqId} ใช่หรือไม่?\n\nเมื่ออนุมัติแล้ว ระบบจะตัดยอดสต๊อกทันที`)) {
                // Update requisition status
                req.status = 'approved';
                req.approvedAt = new Date().toISOString();
                req.approver = currentUser.name;
                
                // Deduct stock
                req.items.forEach(item => {
                    demoData.items.farm[item.code].stock -= item.quantity;
                    
                    // Add transaction record
                    const transaction = {
                        id: 'T' + Date.now() + Math.random().toString(36).substr(2, 3),
                        date: new Date().toISOString().split('T')[0],
                        time: new Date().toTimeString().slice(0, 5),
                        type: 'out',
                        itemCode: item.code,
                        itemName: item.name,
                        department: 'farm',
                        quantity: item.quantity,
                        unitPrice: item.pricePerKg,
                        totalPrice: item.quantity * item.pricePerKg,
                        supplier: 'เบิกใช้ TMR',
                        recorder: currentUser.name,
                        notes: `ใบเบิก ${reqId} (${req.shiftText})`,
                        documentRef: reqId,
                        requisitionId: reqId
                    };
                    demoData.transactions.push(transaction);
                });
                
                loadPendingRequisitions();
                loadApprovalHistory();
                updateStats();
                updateInventoryTables();
                updateNotificationBadge();
                
                showNotification(`อนุมัติใบเบิก ${reqId} เรียบร้อย และตัดยอดสต๊อกแล้ว`, 'success');
            }
        }

        function rejectRequisition(reqId) {
            const notes = prompt(`กรุณาระบุเหตุผลในการไม่อนุมัติใบเบิก ${reqId}:`);
            if (notes === null) return; // User cancelled
            
            const req = demoData.requisitions.find(r => r.id === reqId);
            if (!req) return;
            
            req.status = 'rejected';
            req.approvedAt = new Date().toISOString();
            req.approver = currentUser.name;
            req.approverNotes = notes || 'ไม่ได้ระบุเหตุผล';
            
            loadPendingRequisitions();
            loadApprovalHistory();
            updateStats();
            updateNotificationBadge();
            
            showNotification(`ไม่อนุมัติใบเบิก ${reqId} แล้ว`, 'info');
        }

        function cancelRequisition(reqId) {
            if (confirm(`คุณต้องการยกเลิกใบเบิก ${reqId} ใช่หรือไม่?`)) {
                const index = demoData.requisitions.findIndex(r => r.id === reqId);
                if (index >= 0) {
                    demoData.requisitions.splice(index, 1);
                    loadMyRequisitions();
                    updateStats();
                    updateNotificationBadge();
                    showNotification(`ยกเลิกใบเบิก ${reqId} แล้ว`, 'info');
                }
            }
        }

        function viewRequisitionDetails(reqId) {
            const req = demoData.requisitions.find(r => r.id === reqId);
            if (!req) return;
            
            document.getElementById('requisitionModalTitle').textContent = `📋 รายละเอียดใบเบิก ${req.id}`;
            
            const statusClass = req.status === 'pending' ? 'pending' : 
                              req.status === 'approved' ? 'approved' : 'rejected';
            const statusText = req.status === 'pending' ? 'รออนุมัติ' : 
                             req.status === 'approved' ? 'อนุมัติแล้ว' : 'ไม่อนุมัติ';
            
            let itemsHtml = '';
            req.items.forEach(item => {
                const itemValue = item.quantity * item.pricePerKg;
                itemsHtml += `
                    <tr>
                        <td><strong>${item.name}</strong></td>
                        <td style="text-align: right;">${item.quantity.toLocaleString()}</td>
                        <td style="text-align: right;">${item.pricePerKg.toFixed(2)}</td>
                        <td style="text-align: right;"><strong>${itemValue.toLocaleString()}</strong></td>
                    </tr>
                `;
            });
            
            const content = `
                <div style="margin-bottom: 25px;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>รหัสใบเบิก</label>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;"><strong>${req.id}</strong></div>
                        </div>
                        <div class="form-group">
                            <label>สถานะ</label>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                <span class="status-badge status-${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>วันที่เบิก</label>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">${new Date(req.date).toLocaleDateString('th-TH')}</div>
                        </div>
                        <div class="form-group">
                            <label>กะการทำงาน</label>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">${req.shiftText}</div>
                        </div>
                        <div class="form-group">
                            <label>ผู้เบิก</label>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">${req.requester}</div>
                        </div>
                        <div class="form-group">
                            <label>วันเวลาที่ส่งใบเบิก</label>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                ${new Date(req.createdAt).toLocaleDateString('th-TH')} 
                                ${new Date(req.createdAt).toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'})}
                            </div>
                        </div>
                    </div>
                    
                    ${req.status !== 'pending' ? `
                        <div class="form-grid">
                            <div class="form-group">
                                <label>ผู้อนุมัติ</label>
                                <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">${req.approver || '-'}</div>
                            </div>
                            <div class="form-group">
                                <label>วันเวลาอนุมัติ</label>
                                <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                    ${req.approvedAt ? new Date(req.approvedAt).toLocaleDateString('th-TH') + ' ' + new Date(req.approvedAt).toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'}) : '-'}
                                </div>
                            </div>
                        </div>
                        
                        ${req.approverNotes ? `
                            <div class="form-group">
                                <label>หมายเหตุ</label>
                                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ffc107;">
                                    ${req.approverNotes}
                                </div>
                            </div>
                        ` : ''}
                    ` : ''}
                </div>
                
                <h5 style="margin-bottom: 15px; color: #2c3e50;">รายการวัตถุดิบที่เบิก</h5>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>รายการ</th>
                                <th style="text-align: right;">ราคา/กก.</th>
                                <th style="text-align: right;">มูลค่า (บาท)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                            <tr style="background: rgba(102, 126, 234, 0.1); font-weight: bold;">
                                <td><strong>รวมทั้งหมด</strong></td>
                                <td style="text-align: right;"><strong>${req.totalQuantity.toLocaleString()}</strong></td>
                                <td style="text-align: right;">-</td>
                                <td style="text-align: right;"><strong>${req.totalValue.toLocaleString()}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('requisitionModalContent').innerHTML = content;
            document.getElementById('requisitionModal').classList.add('show');
        }

        function closeRequisitionModal() {
            document.getElementById('requisitionModal').classList.remove('show');
        }

        function showNotifications() {
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'farm')) {
                showSection('approval');
                // Find and click the approval tab
                document.querySelector('[onclick="showSection(\'approval\')"]').click();
            }
        }

        // Updated Stats Functions
        function updateStats() {
            const totalItems = Object.keys(demoData.items.farm).length + Object.keys(demoData.items.breeding).length;
            let totalValue = 0;
            let farmValue = 0;
            let breedingValue = 0;
            let lowStock = 0;
            let expiredItems = 0;
            
            // Calculate farm values
            Object.values(demoData.items.farm).forEach(item => {
                const value = item.stock * item.pricePerKg;
                farmValue += value;
                totalValue += value;
                const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                if (item.stock <= lowStockThreshold) {
                    lowStock++;
                }
                const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                if (expiryStatus.status === 'expired') {
                    expiredItems++;
                }
            });
            
            // Calculate breeding values
            Object.values(demoData.items.breeding).forEach(item => {
                const value = item.stock * item.pricePerKg;
                breedingValue += value;
                totalValue += value;
                const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                if (item.stock <= lowStockThreshold) {
                    lowStock++;
                }
                const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                if (expiryStatus.status === 'expired') {
                    expiredItems++;
                }
            });
            
            // Count pending requisitions
            const pendingReqs = demoData.requisitions.filter(req => req.status === 'pending').length;
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalValue').textContent = totalValue.toLocaleString('th-TH', { maximumFractionDigits: 0 });
            document.getElementById('farmValue').textContent = farmValue.toLocaleString('th-TH', { maximumFractionDigits: 0 });
            document.getElementById('breedingValue').textContent = breedingValue.toLocaleString('th-TH', { maximumFractionDigits: 0 });
            document.getElementById('lowStock').textContent = lowStock;
            document.getElementById('pendingRequisitions').textContent = pendingReqs;
            document.getElementById('expiredItems').textContent = expiredItems;
            
            updateRecentActivities();
        }

        function updateNotificationBadge() {
            const pendingReqs = demoData.requisitions.filter(req => req.status === 'pending').length;
            const badge = document.getElementById('notificationBadge');
            
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'farm')) {
                if (pendingReqs > 0) {
                    badge.textContent = pendingReqs;
                    badge.classList.remove('hide');
                } else {
                    badge.classList.add('hide');
                }
            } else {
                badge.classList.add('hide');
            }
        }

        // Utility Functions
        function getExpiryStatus(expiryDate, expiryDays = 7) {
            const today = new Date();
            const expiry = new Date(expiryDate);
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return { status: 'expired', statusClass: 'status-expired', message: 'หมดอายุแล้ว' };
            } else if (diffDays <= expiryDays) {
                return { status: 'expiring', statusClass: 'status-danger', message: `เหลือ ${diffDays} วัน` };
            } else if (diffDays <= expiryDays * 2) {
                return { status: 'warning', statusClass: 'status-warning', message: `เหลือ ${diffDays} วัน` };
            } else {
                return { status: 'normal', statusClass: 'status-normal', message: `เหลือ ${diffDays} วัน` };
            }
        }

        function updateInventoryTables() {
            updateInventoryTable('farm', 'farmInventoryTable');
            updateInventoryTable('breeding', 'breedingInventoryTable');
        }

        function updateInventoryTable(department, tableId) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';
            const items = demoData.items[department] || {};
            
            if (Object.keys(items).length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #7f8c8d; font-style: italic;">ยังไม่มีรายการวัตถุดิบ</td></tr>';
                return;
            }
            
            Object.entries(items).forEach(([code, item]) => {
                const row = document.createElement('tr');
                const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                let stockStatus, stockStatusClass;
                
                if (item.stock === 0) {
                    stockStatus = 'หมด';
                    stockStatusClass = 'status-danger';
                } else if (item.stock <= lowStockThreshold) {
                    stockStatus = 'ต่ำ';
                    stockStatusClass = 'status-warning';
                } else {
                    stockStatus = 'ปกติ';
                    stockStatusClass = 'status-normal';
                }

                const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                let finalStatus, finalStatusClass;
                if (expiryStatus.status === 'expired') {
                    finalStatus = 'หมดอายุ';
                    finalStatusClass = 'status-expired';
                } else if (expiryStatus.status === 'expiring') {
                    finalStatus = `หมดอายุ ${expiryStatus.message}`;
                    finalStatusClass = 'status-danger';
                } else if (stockStatus === 'หมด') {
                    finalStatus = stockStatus;
                    finalStatusClass = stockStatusClass;
                } else if (stockStatus === 'ต่ำ') {
                    finalStatus = `สต๊อกต่ำ`;
                    finalStatusClass = stockStatusClass;
                } else {
                    finalStatus = 'ปกติ';
                    finalStatusClass = 'status-normal';
                }
                
                const totalValue = item.stock * item.pricePerKg;
                const expiryDate = new Date(item.expiryDate).toLocaleDateString('th-TH');
                
                row.innerHTML = `
                    <td>
                        <strong>${item.name}</strong><br>
                        <small style="color: #666;">${code}</small>
                    </td>
                    <td><strong>${item.stock.toLocaleString()}</strong></td>
                    <td>${item.pricePerKg.toFixed(2)}</td>
                    <td><strong style="color: #27ae60;">${totalValue.toLocaleString('th-TH', { maximumFractionDigits: 0 })}</strong></td>
                    <td>${expiryDate}</td>
                    <td><span class="status-badge ${finalStatusClass}">${finalStatus}</span></td>
                    <td style="text-align: center;">
                        <button class="btn btn-info btn-sm" onclick="showItemDetails('${code}', '${department}')" title="ดูรายละเอียด">
                            ℹ️ รายละเอียด
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function showItemDetails(code, department) {
            const item = demoData.items[department][code];
            if (!item) return;
            
            showNotification(`รายละเอียด ${item.name}: สต๊อก ${item.stock.toLocaleString()} กก., ราคา ${item.pricePerKg.toFixed(2)} บาท/กก.`, 'info');
        }

        function loadRequisitions() {
            // Load requisitions from storage if available
            if (currentUser) {
                updateNotificationBadge();
            }
        }

        // Recent Activities
        function updateRecentActivities() {
            const container = document.getElementById('recentActivities');
            const recentReqs = demoData.requisitions
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 5);
            
            if (recentReqs.length === 0) {
                container.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">ยังไม่มีกิจกรรม</p>';
                return;
            }
            
            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            recentReqs.forEach(req => {
                const timeAgo = getTimeAgo(req.createdAt);
                const statusText = req.status === 'pending' ? 'รออนุมัติ' : 
                                 req.status === 'approved' ? 'อนุมัติแล้ว' : 'ไม่อนุมัติ';
                const statusColor = req.status === 'pending' ? '#ffc107' : 
                                   req.status === 'approved' ? '#28a745' : '#dc3545';
                
                html += `
                    <div style="padding: 15px; border-left: 4px solid ${statusColor}; margin-bottom: 15px; background: rgba(0,0,0,0.02); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong>ใบเบิก ${req.id}</strong><br>
                                <small style="color: #666;">โดย ${req.requester} • ${req.totalQuantity.toLocaleString()} กก. • ${timeAgo}</small>
                            </div>
                            <span style="color: ${statusColor}; font-weight: bold; font-size: 0.9rem;">${statusText}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function getTimeAgo(dateString) {
            const now = new Date();
            const past = new Date(dateString);
            const diffInSeconds = Math.floor((now - past) / 1000);
            
            if (diffInSeconds < 60) {
                return 'เมื่อสักครู่';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes} นาทีที่แล้ว`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours} ชั่วโมงที่แล้ว`;
            } else {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days} วันที่แล้ว`;
            }
        }

        // Export Functions
        function exportToExcel() {
            try {
                const workbook = XLSX.utils.book_new();
                const today = new Date().toLocaleDateString('th-TH');
                
                // Stock report
                const stockData = [];
                stockData.push(['รายงานสต๊อกวัตถุดิบ - SmartStock อ.ส.ค.', '', '', '', '', '']);
                stockData.push(['วันที่:', today, '', '', '', '']);
                stockData.push(['', '', '', '', '', '']);
                stockData.push(['รหัส', 'ชื่อวัตถุดิบ', 'แผนก', 'สต๊อก (กก.)', 'ราคา/กก.', 'มูลค่า (บาท)']);
                
                // Add farm items
                Object.entries(demoData.items.farm).forEach(([code, item]) => {
                    const totalValue = item.stock * item.pricePerKg;
                    stockData.push([code, item.name, 'ฟาร์มโคนม', item.stock, item.pricePerKg.toFixed(2), totalValue.toFixed(2)]);
                });
                
                // Add breeding items
                Object.entries(demoData.items.breeding).forEach(([code, item]) => {
                    const totalValue = item.stock * item.pricePerKg;
                    stockData.push([code, item.name, 'ผลิตน้ำเชื้อ', item.stock, item.pricePerKg.toFixed(2), totalValue.toFixed(2)]);
                });
                
                const stockSheet = XLSX.utils.aoa_to_sheet(stockData);
                XLSX.utils.book_append_sheet(workbook, stockSheet, 'สต๊อกปัจจุบัน');
                
                // Requisitions report
                if (demoData.requisitions.length > 0) {
                    const reqData = [];
                    reqData.push(['รายงานใบเบิก TMR', '', '', '', '', '', '']);
                    reqData.push(['วันที่:', today, '', '', '', '', '']);
                    reqData.push(['', '', '', '', '', '', '']);
                    reqData.push(['รหัสใบเบิก', 'วันที่เบิก', 'กะ', 'ผู้เบิก', 'สถานะ', 'รวมจำนวน (กก.)', 'มูลค่า (บาท)']);
                    
                    demoData.requisitions.forEach(req => {
                        const statusText = req.status === 'pending' ? 'รออนุมัติ' : 
                                         req.status === 'approved' ? 'อนุมัติแล้ว' : 'ไม่อนุมัติ';
                        reqData.push([
                            req.id,
                            new Date(req.date).toLocaleDateString('th-TH'),
                            req.shiftText,
                            req.requester,
                            statusText,
                            req.totalQuantity,
                            req.totalValue.toFixed(2)
                        ]);
                    });
                    
                    const reqSheet = XLSX.utils.aoa_to_sheet(reqData);
                    XLSX.utils.book_append_sheet(workbook, reqSheet, 'ใบเบิก TMR');
                }
                
                const fileName = `SmartStock-Report-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);
                showNotification('ส่งออกไฟล์ Excel เรียบร้อย', 'success');
            } catch (error) {
                console.error('Export Excel error:', error);
                showNotification('เกิดข้อผิดพลาดในการส่งออก Excel', 'error');
            }
        }

        function exportData() {
            try {
                const data = {
                    items: demoData.items,
                    transactions: demoData.transactions,
                    requisitions: demoData.requisitions,
                    settings: demoData.settings,
                    exportDate: new Date().toISOString(),
                    version: '3.0'
                };
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `SmartStock-Data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                showNotification('ส่งออกข้อมูลเรียบร้อย', 'success');
            } catch (error) {
                showNotification('เกิดข้อผิดพลาดในการส่งออกข้อมูล', 'error');
            }
        }

        function backupData() {
            try {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const backupData = {
                    ...demoData,
                    backupDate: new Date().toISOString(),
                    backupBy: currentUser?.email || 'unknown',
                    version: '3.0',
                    systemInfo: {
                        userAgent: navigator.userAgent,
                        timestamp: timestamp,
                        totalItems: Object.keys(demoData.items.farm).length + Object.keys(demoData.items.breeding).length,
                        totalTransactions: demoData.transactions.length,
                        totalRequisitions: demoData.requisitions.length
                    }
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `SmartStock-Backup-${timestamp}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`สำรองข้อมูลเรียบร้อย\nไฟล์: SmartStock-Backup-${timestamp}.json`, 'success');
            } catch (error) {
                console.error('Backup error:', error);
                showNotification('เกิดข้อผิดพลาดในการสำรองข้อมูล', 'error');
            }
        }

        function refreshData() {
            updateStats();
            updateInventoryTables();
            if (currentUser) {
                if (currentUser.role === 'tmr') {
                    loadMyRequisitions();
                } else if (currentUser.role === 'admin' || currentUser.role === 'farm') {
                    loadPendingRequisitions();
                    loadApprovalHistory();
                }
                updateNotificationBadge();
            }
            showNotification('รีเฟรชข้อมูลเรียบร้อย', 'success');
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 SmartStock System with Enhanced TMR Requisition Starting...');
            
            // Clear login fields for security
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            
            showLoginScreen();
            
            // Add sample requisitions for demo
            if (demoData.requisitions.length === 0) {
                // Add demo requisition data
                const sampleRequisition = {
                    id: 'R' + Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    shift: 'morning',
                    shiftText: 'กะเช้า (05:00-12:00)',
                    requester: 'หน่วยผสม TMR',
                    requesterEmail: 'tmr@dairy.co.th',
                    status: 'pending',
                    items: [
                        { code: 'F002', name: 'อาหารข้น 16%', quantity: 100, pricePerKg: 10.11, availableStock: 9900 },
                        { code: 'F003', name: 'อาหารข้น 20% (ผสม TMR)', quantity: 150, pricePerKg: 11.675, availableStock: 21510 },
                        { code: 'F005', name: 'มันเส้น', quantity: 200, pricePerKg: 8.56, availableStock: 25560 }
                    ],
                    totalQuantity: 450,
                    totalValue: 450 * 10, // Approximate
                    createdAt: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), // 2 hours ago
                    approvedAt: null,
                    approver: null,
                    approverNotes: ''
                };
                demoData.requisitions.push(sampleRequisition);
            }
        });

        // Event Listeners
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
                doLogin();
            }
            if (event.key === 'Escape') {
                closeRequisitionModal();
            }
        });

        document.getElementById('requisitionModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeRequisitionModal();
            }
        });

    </script>
</body>
</html>;">จำนวน (กก.)</th>
                                <th style="text-align: right
