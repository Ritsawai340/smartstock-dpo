<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartStock ‡∏≠.‡∏™.‡∏Ñ. - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÇ‡∏Ñ‡∏ô‡∏°‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</title>
    
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 50px;
            border-radius: 25px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 450px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.3);
            animation: slideInUp 0.8s ease-out;
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .login-logo {
            font-size: 5rem;
            margin-bottom: 25px;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.2));
        }

        .login-title {
            font-size: 2.2rem;
            margin-bottom: 15px;
            color: #2c3e50;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-subtitle {
            color: #7f8c8d;
            margin-bottom: 35px;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: #2c3e50;
            font-size: 1rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1.05rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .btn {
            display: inline-block;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.05rem;
            font-weight: 700;
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 5px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(108, 117, 125, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(220, 53, 69, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
            box-shadow: 0 10px 30px rgba(255, 193, 7, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(23, 162, 184, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        /* Button Group Styles */
        .btn-group {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn-group .btn {
            margin: 0;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn-group .btn:hover {
            transform: translateY(-2px) scale(1.05);
            z-index: 2;
            position: relative;
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 0.75rem;
            min-width: 50px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 15px 50px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.2rem;
            margin-bottom: 5px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1rem;
            font-weight: 500;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px 20px;
            border-radius: 30px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-tabs {
            display: flex;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 8px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow-x: auto;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            font-weight: 600;
            white-space: nowrap;
            min-width: 140px;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .nav-tab:hover:not(.active) {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 80px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.6rem;
            font-weight: 700;
            background: linear-gradient(135deg, #2c3e50 0%, #667eea 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 15px 50px rgba(0,0,0,0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
        }

        .stat-card.green::before { background: linear-gradient(90deg, #27ae60, #2ecc71); }
        .stat-card.blue::before { background: linear-gradient(90deg, #3498db, #2980b9); }
        .stat-card.orange::before { background: linear-gradient(90deg, #f39c12, #e67e22); }
        .stat-card.red::before { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .stat-card.purple::before { background: linear-gradient(90deg, #9b59b6, #8e44ad); }

        .stat-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 25px 80px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #2c3e50 0%, #667eea 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2s ease-in-out infinite;
        }

        .stat-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        .quick-action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255,255,255,0.9);
            color: #495057;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .quick-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .department-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .dept-card {
            flex: 1;
            min-width: 250px;
            padding: 25px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px solid transparent;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .dept-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .dept-card:hover::before {
            transform: scaleX(1);
        }

        .dept-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }

        .dept-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
        }

        .dept-card.selected::before {
            transform: scaleX(1);
            background: rgba(255,255,255,0.3);
        }

        .dept-icon {
            font-size: 3.5rem;
            margin-bottom: 15px;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1));
        }

        .table-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 18px;
            text-align: left;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.95rem;
        }

        .table tr:hover {
            background: rgba(102, 126, 234, 0.05);
            transform: scale(1.01);
            transition: all 0.3s ease;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .status-normal { 
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); 
            color: #155724; 
            border: 1px solid #b8dacc;
        }
        .status-warning { 
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); 
            color: #856404; 
            border: 1px solid #f5c842;
        }
        .status-danger { 
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); 
            color: #721c24; 
            border: 1px solid #f1aeb5;
        }
        .status-expired {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            border: 1px solid #6c757d;
        }

        .content-section {
            display: none;
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }

        .hide {
            display: none !important;
        }

        .debug-panel {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #2ecc71;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 20px 25px;
            border-radius: 15px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
            z-index: 10000;
            transform: translateX(400px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 350px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { border-left: 6px solid #28a745; }
        .notification.error { border-left: 6px solid #dc3545; }
        .notification.warning { border-left: 6px solid #ffc107; }
        .notification.info { border-left: 6px solid #17a2b8; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.3);
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal h3 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            background: linear-gradient(135deg, #2c3e50 0%, #667eea 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .expiry-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 12px;
            margin-top: 10px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .expiry-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border: 1px solid #f5c842;
        }

        .expiry-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 1px solid #f1aeb5;
        }

        .alert {
            padding: 20px 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 6px solid;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .alert-success {
            background: rgba(212, 237, 218, 0.9);
            border-color: #28a745;
            color: #155724;
        }

        .alert-warning {
            background: rgba(255, 243, 205, 0.9);
            border-color: #ffc107;
            color: #856404;
        }

        .alert-danger {
            background: rgba(248, 215, 218, 0.9);
            border-color: #dc3545;
            color: #721c24;
        }

        .alert-info {
            background: rgba(209, 236, 241, 0.9);
            border-color: #17a2b8;
            color: #0c5460;
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header { 
                flex-direction: column; 
                text-align: center; 
                padding: 20px;
            }
            .header h1 { font-size: 1.8rem; }
            .nav-tabs { 
                flex-direction: column; 
                gap: 5px;
            }
            .nav-tab {
                padding: 15px 20px;
                margin-bottom: 0;
            }
            .stats-grid { 
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
                gap: 20px;
            }
            .department-selector { flex-direction: column; }
            .quick-actions { justify-content: center; }
            .table-container { overflow-x: auto; }
            .table { min-width: 600px; }
            .table th,
            .table td {
                padding: 12px 10px;
                font-size: 0.9rem;
            }
            .form-grid { grid-template-columns: 1fr; }
            
            /* Mobile Button Adjustments */
            .btn-group {
                flex-direction: column;
                gap: 3px;
                width: 100%;
            }
            
            .btn-group .btn {
                width: 100%;
                min-width: unset;
                font-size: 0.7rem;
                padding: 4px 8px;
                height: 28px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">üêÑ</div>
            <h2 class="login-title">SmartStock ‡∏≠.‡∏™.‡∏Ñ.</h2>
            <p class="login-subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÇ‡∏Ñ‡∏ô‡∏°‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞<br>‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏ô‡∏°‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢</p>
            
            <div class="form-group">
                <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                <input type="email" id="loginEmail" value="admin@dairy.co.th" placeholder="example@dairy.co.th">
            </div>
            <div class="form-group">
                <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                <input type="password" id="loginPassword" value="admin123" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="form-group">
                <button class="btn btn-primary" onclick="doLogin()" style="width: 100%;">
                    üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>

            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); padding: 20px; border-radius: 15px; margin-top: 25px; border: 1px solid rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 1.2rem; margin-bottom: 10px;">üìû ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô</div>
                <div style="color: #555; font-size: 0.95rem; line-height: 1.5;">
                    <strong>‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</strong><br>
                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: <strong style="color: #1976d2;">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏ô‡∏°</strong><br>
                    <small style="color: #666;">‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÇ‡∏Ñ‡∏ô‡∏°</small>
                </div>
            </div>
            
            <div id="debugInfo" class="debug-panel hide">
                <div style="color: #ecf0f1; margin-bottom: 10px; font-weight: bold;">üîß Debug Console:</div>
                <div id="debugLog"></div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="container hide" id="mainApp">
        <div class="header">
            <div>
                <h1>üöÄ SmartStock ‡∏≠.‡∏™.‡∏Ñ.</h1>
                <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÇ‡∏Ñ‡∏ô‡∏°‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</p>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <span id="userName">Admin</span>
                <button class="btn btn-danger" onclick="logout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('dashboard')">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
            <button class="nav-tab" onclick="showSection('inventory')">üì¶ ‡∏™‡∏ï‡πä‡∏≠‡∏Å</button>
            <button class="nav-tab" onclick="showSection('record')">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="nav-tab" onclick="showSection('reports')">üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
            <button class="nav-tab" onclick="showSection('alerts')">üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
            <button class="nav-tab" onclick="showSection('management')">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card green">
                    <div class="stat-number" id="totalItems">10</div>
                    <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-number" id="totalValue">0</div>
                    <div class="stat-label">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-number" id="lowStock">0</div>
                    <div class="stat-label">‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡πà‡∏≥</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-number" id="expiringSoon">0</div>
                    <div class="stat-label">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-number" id="expiredItems">0</div>
                    <div class="stat-label">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</div>
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="refreshData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button class="btn btn-success" onclick="exportToExcel()">üìä Export Excel</button>
                <button class="btn btn-secondary" onclick="exportData()">üìÑ Export JSON</button>
                <button class="btn btn-info" onclick="backupData()">üíæ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button class="btn btn-warning" onclick="showItemModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
            </div>

            <div class="card">
                <h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å</h3>
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-number" id="farmValue">0</div>
                        <div class="stat-label">‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÇ‡∏Ñ‡∏ô‡∏° (‡∏ö‡∏≤‡∏ó)</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-number" id="breedingValue">0</div>
                        <div class="stat-label">‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ (‡∏ö‡∏≤‡∏ó)</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üîÑ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                <div id="recentActivities">
                    <p style="color: #7f8c8d; font-style: italic;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
                </div>
            </div>
        </div>

        <!-- Inventory Section -->
        <div id="inventory" class="content-section">
            <div class="card">
                <h3>üåæ ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÇ‡∏Ñ‡∏ô‡∏°</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏Å‡∏Å.)</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏Å‡∏Å.</th>
                                <th>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ (‡∏ö‡∏≤‡∏ó)</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="farmInventoryTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>üêÇ ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏Å‡∏Å.)</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏Å‡∏Å.</th>
                                <th>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ (‡∏ö‡∏≤‡∏ó)</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="breedingInventoryTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Record Section -->
        <div id="record" class="content-section">
            <div class="department-selector" id="departmentSelector">
                <div class="dept-card selected" onclick="selectDepartment('farm')" id="deptFarm">
                    <div class="dept-icon">üåæ</div>
                    <h4>‡πÅ‡∏ú‡∏ô‡∏Å‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÇ‡∏Ñ‡∏ô‡∏°</h4>
                    <p>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ú‡∏™‡∏° TMR</p>
                </div>
                <div class="dept-card" onclick="selectDepartment('breeding')" id="deptBreeding">
                    <div class="dept-icon">üêÇ</div>
                    <h4>‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</h4>
                    <p>‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡πâ‡∏ô‡πÇ‡∏Ñ‡∏ô‡∏°</p>
                </div>
            </div>

            <div class="card">
                <h3 id="recordTitle">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö-‡∏à‡πà‡∏≤‡∏¢‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
                <form onsubmit="submitRecord(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="date" id="recordDate" required>
                        </div>
                        <div class="form-group">
                            <label>‡πÄ‡∏ß‡∏•‡∏≤</label>
                            <input type="time" id="recordTime" required>
                        </div>
                        <div class="form-group">
                            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                            <select id="transactionType" required onchange="toggleFormFields()">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                                <option value="in">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</option>
                                <option value="out">‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                            <select id="itemSelect" required onchange="calculateAutoPrice()">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°)</label>
                            <input type="number" id="quantity" step="0.1" min="0" required onchange="calculateAutoPrice()">
                        </div>
                        <div class="form-group price-input-group">
                            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="totalPrice" step="0.01" min="0" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°" onchange="calculatePricePerKg()">
                            <small style="color: #666;">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</small>
                        </div>
                        <div class="form-group price-input-group">
                            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏° (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="unitPrice" step="0.01" min="0" onchange="calculateTotalPrice()">
                            <small style="color: #666;">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ</small>
                        </div>
                        <div class="form-group supplier-group">
                            <label>‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <input type="text" id="supplier" required>
                        </div>
                        <div class="form-group">
                            <label>‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
                            <input type="text" id="recorder" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea id="notes" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
                    </div>

                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">üîÑ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports" class="content-section">
            <div class="card">
                <h3>üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
                
                <div class="form-grid" style="margin-bottom: 25px;">
                    <div class="form-group">
                        <label>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
                        <select id="reportPeriod">
                            <option value="7">7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                            <option value="14">14 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                            <option value="30">30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
                        <select id="reportDepartment">
                            <option value="all">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                            <option value="farm">‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÇ‡∏Ñ‡∏ô‡∏°</option>
                            <option value="breeding">‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="generateUsageReport()">üîç ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                    </div>
                </div>

                <div id="reportResults">
                    <div class="alert alert-info">
                        <strong>‚ÑπÔ∏è ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üö® ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</h3>
                
                <div class="form-grid" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (%)</label>
                        <input type="number" id="anomalyThreshold" value="30" min="10" max="100" placeholder="30">
                        <small style="color: #666;">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</small>
                    </div>
                    <div class="form-group">
                        <label>‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</label>
                        <select id="compareInterval">
                            <option value="daily">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                            <option value="weekly">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                            <option value="monthly">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-warning" onclick="detectAnomalies()">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</button>
                    </div>
                </div>

                <div id="anomalyResults">
                    <div class="alert alert-info">
                        <strong>‚ÑπÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥:</strong> 
                        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏î‡∏•‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°</h3>
                <div id="overallStats">
                    <div class="stats-grid">
                        <div class="stat-card blue">
                            <div class="stat-number" id="totalTransactions">0</div>
                            <div class="stat-label">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        <div class="stat-card green">
                            <div class="stat-number" id="avgDailyUsage">0</div>
                            <div class="stat-label">‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô (‡∏Å‡∏Å.)</div>
                        </div>
                        <div class="stat-card orange">
                            <div class="stat-number" id="peakUsageDay">-</div>
                            <div class="stat-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
                        </div>
                        <div class="stat-card purple">
                            <div class="stat-number" id="mostUsedItem">-</div>
                            <div class="stat-label">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div id="alerts" class="content-section">
            <div class="card">
                <h3>üö® ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h3>
                <div id="alertsContent">
                    <div class="alert alert-info">
                        <strong>‚ÑπÔ∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÅ‡∏ö‡∏ö Real-time
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ (%)</label>
                        <input type="number" id="lowStockPercent" value="20" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏ß‡∏±‡∏ô)</label>
                        <input type="number" id="expiryDays" value="7" min="1" max="30">
                    </div>
                    <div class="form-group">
                        <label>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô Email</label>
                        <input type="email" id="alertEmail" placeholder="admin@dairy.co.th">
                    </div>
                </div>
                <button class="btn btn-success" onclick="saveAlertSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
            </div>
        </div>

        <!-- Management Section -->
        <div id="management" class="content-section">
            <div class="card">
                <h3>‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
                        <p style="color: #7f8c8d;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</p>
                    </div>
                    <button class="btn btn-primary" onclick="showItemModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
                </div>

                <!-- Sorting Controls -->
                <div class="form-grid" style="margin-bottom: 25px; background: rgba(255,255,255,0.7); padding: 20px; border-radius: 15px;">
                    <div class="form-group">
                        <label>‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°</label>
                        <select id="sortBy" onchange="sortManagementTable()">
                            <option value="name">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (A-Z)</option>
                            <option value="name_desc">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Z-A)</option>
                            <option value="department">‡πÅ‡∏ú‡∏ô‡∏Å</option>
                            <option value="stock_desc">‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏°‡∏≤‡∏Å ‚Üí ‡∏ô‡πâ‡∏≠‡∏¢</option>
                            <option value="stock_asc">‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‚Üí ‡∏°‡∏≤‡∏Å</option>
                            <option value="price_desc">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á ‚Üí ‡∏ï‡πà‡∏≥</option>
                            <option value="price_asc">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥ ‚Üí ‡∏™‡∏π‡∏á</option>
                            <option value="expiry_asc">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡πá‡∏ß ‚Üí ‡∏ä‡πâ‡∏≤</option>
                            <option value="expiry_desc">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏ä‡πâ‡∏≤ ‚Üí ‡πÄ‡∏£‡πá‡∏ß</option>
                            <option value="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô ‚Üí ‡∏õ‡∏Å‡∏ï‡∏¥)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å</label>
                        <select id="filterDepartment" onchange="sortManagementTable()">
                            <option value="all">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                            <option value="farm">‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÇ‡∏Ñ‡∏ô‡∏°</option>
                            <option value="breeding">‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                        <select id="filterStatus" onchange="sortManagementTable()">
                            <option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                            <option value="normal">‡∏õ‡∏Å‡∏ï‡∏¥</option>
                            <option value="warning">‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</option>
                            <option value="danger">‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</option>
                            <option value="expired">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                                <th>‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å‡∏Å.)</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏Å‡∏Å.</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="managementTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Item Management Modal -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <h3 id="modalTitle">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏´‡∏°‡πà</h3>
            <form id="itemForm" onsubmit="saveItem(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                        <input type="text" id="itemName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î‡∏ö‡∏î">
                    </div>
                    <div class="form-group">
                        <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
                        <select id="itemDepartment" required>
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                            <option value="farm">‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÇ‡∏Ñ‡∏ô‡∏° (TMR)</option>
                            <option value="breeding">‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‡∏à‡∏∏‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏Å‡∏Å.)</label>
                        <input type="number" id="itemReorder" step="0.1" min="0" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 100">
                        <small style="color: #666;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡πà‡∏≥</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</label>
                    <input type="text" id="itemPackaging" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏£‡∏£‡∏à‡∏∏ 30 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö">
                </div>

                <div class="form-group">
                    <label>‡∏Ñ‡∏∏‡∏ì‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÄ‡∏â‡∏û‡∏≤‡∏∞</label>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô (%)</label>
                            <input type="text" id="itemProtein" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 16%">
                        </div>
                        <div class="form-group">
                            <label>‡πÑ‡∏Ç‡∏°‡∏±‡∏ô (%)</label>
                            <input type="text" id="itemFat" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 3%">
                        </div>
                        <div class="form-group">
                            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)</label>
                            <input type="text" id="itemMoisture" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 13%">
                        </div>
                        <div class="form-group">
                            <label>‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡πÉ‡∏¢ (%)</label>
                            <input type="text" id="itemFiber" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 14%">
                        </div>
                        <div class="form-group">
                            <label>‡∏Å‡∏≤‡∏Å/‡πÄ‡∏ñ‡πâ‡∏≤ (%)</label>
                            <input type="text" id="itemAsh" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 9%">
                        </div>
                        <div class="form-group">
                            <label>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                            <input type="text" id="itemOther" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡∏π‡πÄ‡∏£‡∏µ‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 2%">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</label>
                    <textarea id="itemCondition" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏¥‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏à‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡πÅ‡∏Ç‡πá‡∏á"></textarea>
                </div>
                
                <div class="form-group">
                    <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea id="itemNotes" rows="3" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢, ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©"></textarea>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeItemModal()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-primary" id="saveItemBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Item Details Modal -->
    <div class="modal" id="itemDetailsModal">
        <div class="modal-content">
            <h3 id="detailsModalTitle">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
            <div id="itemDetailsContent">
                <!-- Content will be filled by JavaScript -->
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeItemDetailsModal()">‚ùå ‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let currentDepartment = 'farm';
        let editingItemId = null;

        // ===== LOGIN DATA =====
        const users = {
            'admin@dairy.co.th': { name: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', password: 'admin123', role: 'admin', department: 'all' },
            'farm@dairy.co.th': { name: '‡πÅ‡∏ú‡∏ô‡∏Å‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÇ‡∏Ñ‡∏ô‡∏°', password: 'farm123', role: 'farm', department: 'farm' },
            'breeding@dairy.co.th': { name: '‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå', password: 'breed123', role: 'breeding', department: 'breeding' }
        };

        // ===== DEMO DATA WITH PREDEFINED ITEMS =====
        const demoData = {
            items: {
                farm: {
                    'F001': {
                        name: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡∏π‡∏Å‡πÇ‡∏Ñ CP 973',
                        stock: 840,
                        pricePerKg: 19.00,
                        reorderPoint: 500,
                        expiryDate: '2026-12-31',
                        lastModified: new Date().toISOString(),
                        notes: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡∏π‡∏Å‡πÇ‡∏Ñ ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á',
                        specifications: {
                            packaging: '‡∏ñ‡∏∏‡∏á‡∏•‡∏∞ 10 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°',
                            fat: '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 3%',
                            ash: '‡∏Å‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 9%',
                            moisture: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 13%',
                            protein: '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 20%',
                            condition: '‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏¥‡πà‡∏ô'
                        },
                        batches: [{
                            quantity: 840,
                            unitPrice: 19.00,
                            expiryDate: '2026-12-31',
                            dateReceived: '2025-07-01T00:00:00.000Z',
                            batchId: '1719792000000'
                        }]
                    },
                    'F002': {
                        name: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡πâ‡∏ô 16%',
                        stock: 9900,
                        pricePerKg: 10.11,
                        reorderPoint: 1000,
                        expiryDate: '2026-06-30',
                        lastModified: new Date().toISOString(),
                        notes: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡πâ‡∏ô‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô 16%',
                        specifications: {
                            packaging: '‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏£‡∏£‡∏à‡∏∏ 30 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö',
                            protein: '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 16',
                            fat: '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 3',
                            fiber: '‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡πÉ‡∏¢‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 14',
                            moisture: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 13',
                            urea: '‡∏¢‡∏π‡πÄ‡∏£‡∏µ‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 2'
                        },
                        batches: [{
                            quantity: 9900,
                            unitPrice: 10.11,
                            expiryDate: '2026-06-30',
                            dateReceived: '2025-07-01T00:00:00.000Z',
                            batchId: '1719792000001'
                        }]
                    },
                    'F003': {
                        name: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡πâ‡∏ô 20% (‡∏ú‡∏™‡∏° TMR)',
                        stock: 21510,
                        pricePerKg: 11.675,
                        reorderPoint: 800,
                        expiryDate: '2026-06-30',
                        lastModified: new Date().toISOString(),
                        notes: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡πâ‡∏ô‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô 20% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏™‡∏° TMR',
                        specifications: {
                            packaging: '‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏£‡∏£‡∏à‡∏∏ 30 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö',
                            protein: '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 20',
                            fat: '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 3',
                            fiber: '‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡πÉ‡∏¢‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 14',
                            moisture: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 13'
                        },
                        batches: [{
                            quantity: 21510,
                            unitPrice: 11.675,
                            expiryDate: '2026-06-30',
                            dateReceived: '2025-07-01T00:00:00.000Z',
                            batchId: '1719792000002'
                        }]
                    },
                    'F004': {
                        name: '‡∏Å‡∏≤‡∏Å‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á',
                        stock: 4600,
                        pricePerKg: 18.00,
                        reorderPoint: 1000,
                        expiryDate: '2025-12-31',
                        lastModified: new Date().toISOString(),
                        notes: '‡∏Å‡∏≤‡∏Å‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏î‡∏µ',
                        specifications: {
                            packaging: '‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏£‡∏£‡∏à‡∏∏ 50 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö',
                            condition: '‡πÑ‡∏°‡πà‡∏à‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡πÅ‡∏Ç‡πá‡∏á ‡∏°‡∏µ‡∏™‡∏µ‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥',
                            moisture: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 12.5%',
                            protein: '‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 45%',
                            ash: '‡∏°‡∏µ‡∏Å‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 4.5%',
                            fat: '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 2.5%'
                        },
                        batches: [{
                            quantity: 4600,
                            unitPrice: 18.00,
                            expiryDate: '2025-12-31',
                            dateReceived: '2025-07-01T00:00:00.000Z',
                            batchId: '1719792000003'
                        }]
                    },
                    'F005': {
                        name: '‡∏°‡∏±‡∏ô‡πÄ‡∏™‡πâ‡∏ô',
                        stock: 25560,
                        pricePerKg: 8.56,
                        reorderPoint: 2000,
                        expiryDate: '2025-12-31',
                        lastModified: new Date().toISOString(),
                        notes: '‡∏°‡∏±‡∏ô‡πÄ‡∏™‡πâ‡∏ô ‡πÅ‡∏´‡πâ‡∏á‡∏î‡∏µ',
                        specifications: {
                            packaging: '‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏£‡∏£‡∏à‡∏∏ 60 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö',
                            moisture: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10%',
                            fiber: '‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡πÉ‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3.70%',
                            protein: '‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 2.5%',
                            ash: '‡πÄ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3.70%',
                            condition: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏≠‡∏°‡∏õ‡∏ô ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏∂‡πà‡∏á‡πÅ‡∏î‡∏î‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß 3-4 ‡πÅ‡∏î‡∏î'
                        },
                        batches: [{
                            quantity: 25560,
                            unitPrice: 8.56,
                            expiryDate: '2025-12-31',
                            dateReceived: '2025-07-01T00:00:00.000Z',
                            batchId: '1719792000004'
                        }]
                    },
                    'F006': {
                        name: 'MC Miner',
                        stock: 475,
                        pricePerKg: 350.00,
                        reorderPoint: 200,
                        expiryDate: '2027-12-31',
                        lastModified: new Date().toISOString(),
                        notes: '‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏‡∏ú‡∏™‡∏° MC Miner',
                        specifications: {
                            packaging: '‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏£‡∏£‡∏à‡∏∏ 25 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö'
                        },
                        batches: [{
                            quantity: 475,
                            unitPrice: 350.00,
                            expiryDate: '2027-12-31',
                            dateReceived: '2025-07-01T00:00:00.000Z',
                            batchId: '1719792000005'
                        }]
                    },
                    'F007': {
                        name: '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ú‡∏á',
                        stock: 1100,
                        pricePerKg: 55.00,
                        reorderPoint: 100,
                        expiryDate: '2026-03-31',
                        lastModified: new Date().toISOString(),
                        notes: '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ú‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á',
                        specifications: {
                            packaging: '‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö‡∏•‡∏∞ 25 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°',
                            fat: '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 84%',
                            ash: '‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 16%',
                            moisture: '‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 5%',
                            calcium: '‡πÅ‡∏Ñ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 9%'
                        },
                        batches: [{
                            quantity: 1100,
                            unitPrice: 55.00,
                            expiryDate: '2026-03-31',
                            dateReceived: '2025-07-01T00:00:00.000Z',
                            batchId: '1719792000006'
                        }]
                    },
                    'F008': {
                        name: '‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏',
                        stock: 425,
                        pricePerKg: 9.42,
                        reorderPoint: 200,
                        expiryDate: '2027-12-31',
                        lastModified: new Date().toISOString(),
                        notes: '‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏‡∏ú‡∏™‡∏°',
                        specifications: {
                            packaging: '‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö‡∏•‡∏∞ 25 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°'
                        },
                        batches: [{
                            quantity: 425,
                            unitPrice: 9.42,
                            expiryDate: '2027-12-31',
                            dateReceived: '2025-07-01T00:00:00.000Z',
                            batchId: '1719792000007'
                        }]
                    },
                    'F009': {
                        name: '‡∏û‡∏£‡∏µ‡∏°‡∏¥‡∏Å‡∏ã‡πå',
                        stock: 640,
                        pricePerKg: 47.88,
                        reorderPoint: 50,
                        expiryDate: '2026-12-31',
                        lastModified: new Date().toISOString(),
                        notes: '‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏‡∏ú‡∏™‡∏°',
                        specifications: {
                            packaging: '‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö‡∏•‡∏∞ 10 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°'
                        },
                        batches: [{
                            quantity: 640,
                            unitPrice: 47.88,
                            expiryDate: '2026-12-31',
                            dateReceived: '2025-07-01T00:00:00.000Z',
                            batchId: '1719792000008'
                        }]
                    },
                    'F010': {
                        name: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡πâ‡∏ô 20% (‡∏Ñ‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡πÇ‡∏Ñ)',
                        stock: 0,
                        pricePerKg: 11.675,
                        reorderPoint: 500,
                        expiryDate: '2026-06-30',
                        lastModified: new Date().toISOString(),
                        notes: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡πâ‡∏ô‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô 20% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡πÇ‡∏Ñ',
                        specifications: {
                            packaging: '‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏£‡∏£‡∏à‡∏∏ 30 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö',
                            protein: '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 20',
                            fat: '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 3',
                            fiber: '‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡πÉ‡∏¢‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 14',
                            moisture: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 13'
                        },
                        batches: []
                    }
                },
                breeding: {
                    'B001': {
                        name: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡πâ‡∏ô 16%',
                        stock: 7170,
                        pricePerKg: 14.17,
                        reorderPoint: 500,
                        expiryDate: '2026-06-30',
                        lastModified: new Date().toISOString(),
                        notes: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå',
                        specifications: {
                            packaging: '‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏£‡∏£‡∏à‡∏∏ 30 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö',
                            protein: '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 16',
                            fat: '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 3',
                            fiber: '‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡πÉ‡∏¢‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 14',
                            moisture: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 13',
                            urea: '‡∏¢‡∏π‡πÄ‡∏£‡∏µ‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 2'
                        },
                        batches: [{
                            quantity: 7170,
                            unitPrice: 14.17,
                            expiryDate: '2026-06-30',
                            dateReceived: '2025-07-01T00:00:00.000Z',
                            batchId: '1719792000009'
                        }]
                    },
                    'B002': {
                        name: '‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏',
                        stock: 50,
                        pricePerKg: 10.90,
                        reorderPoint: 100,
                        expiryDate: '2027-12-31',
                        lastModified: new Date().toISOString(),
                        notes: '‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå',
                        specifications: {
                            packaging: '‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö‡∏•‡∏∞ 50 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°'
                        },
                        batches: [{
                            quantity: 50,
                            unitPrice: 10.90,
                            expiryDate: '2027-12-31',
                            dateReceived: '2025-07-01T00:00:00.000Z',
                            batchId: '1719792000010'
                        }]
                    },
                    'B003': {
                        name: '‡∏û‡∏£‡∏µ‡∏°‡∏¥‡∏Å‡∏ã‡πå',
                        stock: 210,
                        pricePerKg: 95.76,
                        reorderPoint: 25,
                        expiryDate: '2026-12-31',
                        lastModified: new Date().toISOString(),
                        notes: '‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå',
                        specifications: {
                            packaging: '‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö‡∏•‡∏∞ 10 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°'
                        },
                        batches: [{
                            quantity: 210,
                            unitPrice: 95.76,
                            expiryDate: '2026-12-31',
                            dateReceived: '2025-07-01T00:00:00.000Z',
                            batchId: '1719792000011'
                        }]
                    }
                }
            },
            transactions: [
                // Transaction records for initial stock (‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤)
                {
                    id: 'INIT_F001',
                    date: '2025-07-01',
                    time: '08:00',
                    type: 'in',
                    itemCode: 'F001',
                    itemName: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡∏π‡∏Å‡πÇ‡∏Ñ CP 973',
                    department: 'farm',
                    quantity: 840,
                    unitPrice: 19.00,
                    totalPrice: 15960,
                    supplier: '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤',
                    recorder: '‡∏£‡∏∞‡∏ö‡∏ö',
                    notes: '‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568',
                    fifoApplied: true,
                    timestamp: '2025-07-01T01:00:00.000Z'
                },
                {
                    id: 'INIT_F002',
                    date: '2025-07-01',
                    time: '08:00',
                    type: 'in',
                    itemCode: 'F002',
                    itemName: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡πâ‡∏ô 16%',
                    department: 'farm',
                    quantity: 9900,
                    unitPrice: 10.11,
                    totalPrice: 100089,
                    supplier: '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤',
                    recorder: '‡∏£‡∏∞‡∏ö‡∏ö',
                    notes: '‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568',
                    fifoApplied: true,
                    timestamp: '2025-07-01T01:00:00.000Z'
                },
                {
                    id: 'INIT_F003',
                    date: '2025-07-01',
                    time: '08:00',
                    type: 'in',
                    itemCode: 'F003',
                    itemName: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡πâ‡∏ô 20% (‡∏ú‡∏™‡∏° TMR)',
                    department: 'farm',
                    quantity: 21510,
                    unitPrice: 11.675,
                    totalPrice: 251129.25,
                    supplier: '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤',
                    recorder: '‡∏£‡∏∞‡∏ö‡∏ö',
                    notes: '‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568',
                    fifoApplied: true,
                    timestamp: '2025-07-01T01:00:00.000Z'
                },
                {
                    id: 'INIT_F004',
                    date: '2025-07-01',
                    time: '08:00',
                    type: 'in',
                    itemCode: 'F004',
                    itemName: '‡∏Å‡∏≤‡∏Å‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á',
                    department: 'farm',
                    quantity: 4600,
                    unitPrice: 18.00,
                    totalPrice: 82800,
                    supplier: '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤',
                    recorder: '‡∏£‡∏∞‡∏ö‡∏ö',
                    notes: '‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568',
                    fifoApplied: true,
                    timestamp: '2025-07-01T01:00:00.000Z'
                },
                {
                    id: 'INIT_F005',
                    date: '2025-07-01',
                    time: '08:00',
                    type: 'in',
                    itemCode: 'F005',
                    itemName: '‡∏°‡∏±‡∏ô‡πÄ‡∏™‡πâ‡∏ô',
                    department: 'farm',
                    quantity: 25560,
                    unitPrice: 8.56,
                    totalPrice: 218793.60,
                    supplier: '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤',
                    recorder: '‡∏£‡∏∞‡∏ö‡∏ö',
                    notes: '‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568',
                    fifoApplied: true,
                    timestamp: '2025-07-01T01:00:00.000Z'
                },
                {
                    id: 'INIT_F006',
                    date: '2025-07-01',
                    time: '08:00',
                    type: 'in',
                    itemCode: 'F006',
                    itemName: 'MC Miner',
                    department: 'farm',
                    quantity: 475,
                    unitPrice: 350.00,
                    totalPrice: 166250,
                    supplier: '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤',
                    recorder: '‡∏£‡∏∞‡∏ö‡∏ö',
                    notes: '‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568',
                    fifoApplied: true,
                    timestamp: '2025-07-01T01:00:00.000Z'
                },
                {
                    id: 'INIT_F007',
                    date: '2025-07-01',
                    time: '08:00',
                    type: 'in',
                    itemCode: 'F007',
                    itemName: '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ú‡∏á',
                    department: 'farm',
                    quantity: 1100,
                    unitPrice: 55.00,
                    totalPrice: 60500,
                    supplier: '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤',
                    recorder: '‡∏£‡∏∞‡∏ö‡∏ö',
                    notes: '‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568',
                    fifoApplied: true,
                    timestamp: '2025-07-01T01:00:00.000Z'
                },
                {
                    id: 'INIT_F008',
                    date: '2025-07-01',
                    time: '08:00',
                    type: 'in',
                    itemCode: 'F008',
                    itemName: '‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏',
                    department: 'farm',
                    quantity: 425,
                    unitPrice: 9.42,
                    totalPrice: 4003.50,
                    supplier: '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤',
                    recorder: '‡∏£‡∏∞‡∏ö‡∏ö',
                    notes: '‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568',
                    fifoApplied: true,
                    timestamp: '2025-07-01T01:00:00.000Z'
                },
                {
                    id: 'INIT_F009',
                    date: '2025-07-01',
                    time: '08:00',
                    type: 'in',
                    itemCode: 'F009',
                    itemName: '‡∏û‡∏£‡∏µ‡∏°‡∏¥‡∏Å‡∏ã‡πå',
                    department: 'farm',
                    quantity: 640,
                    unitPrice: 47.88,
                    totalPrice: 30643.20,
                    supplier: '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤',
                    recorder: '‡∏£‡∏∞‡∏ö‡∏ö',
                    notes: '‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568',
                    fifoApplied: true,
                    timestamp: '2025-07-01T01:00:00.000Z'
                },
                {
                    id: 'INIT_B001',
                    date: '2025-07-01',
                    time: '08:00',
                    type: 'in',
                    itemCode: 'B001',
                    itemName: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡πâ‡∏ô 16%',
                    department: 'breeding',
                    quantity: 7170,
                    unitPrice: 14.17,
                    totalPrice: 101598.90,
                    supplier: '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤',
                    recorder: '‡∏£‡∏∞‡∏ö‡∏ö',
                    notes: '‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568',
                    fifoApplied: true,
                    timestamp: '2025-07-01T01:00:00.000Z'
                },
                {
                    id: 'INIT_B002',
                    date: '2025-07-01',
                    time: '08:00',
                    type: 'in',
                    itemCode: 'B002',
                    itemName: '‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏',
                    department: 'breeding',
                    quantity: 50,
                    unitPrice: 10.90,
                    totalPrice: 545,
                    supplier: '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤',
                    recorder: '‡∏£‡∏∞‡∏ö‡∏ö',
                    notes: '‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568',
                    fifoApplied: true,
                    timestamp: '2025-07-01T01:00:00.000Z'
                },
                {
                    id: 'INIT_B003',
                    date: '2025-07-01',
                    time: '08:00',
                    type: 'in',
                    itemCode: 'B003',
                    itemName: '‡∏û‡∏£‡∏µ‡∏°‡∏¥‡∏Å‡∏ã‡πå',
                    department: 'breeding',
                    quantity: 210,
                    unitPrice: 95.76,
                    totalPrice: 20109.60,
                    supplier: '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤',
                    recorder: '‡∏£‡∏∞‡∏ö‡∏ö',
                    notes: '‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568',
                    fifoApplied: true,
                    timestamp: '2025-07-01T01:00:00.000Z'
                }
            ],
            usageHistory: [],
            settings: { 
                lowStockPercent: 20, 
                expiryDays: 7,
                alertEmail: 'admin@dairy.co.th',
                anomalyThreshold: 30
            }
        };

        // ===== FORM MANAGEMENT FUNCTIONS =====
        function toggleFormFields() {
            const transactionType = document.getElementById('transactionType').value;
            const priceInputGroups = document.querySelectorAll('.price-input-group');
            const supplierGroup = document.querySelector('.supplier-group');
            const totalPriceInput = document.getElementById('totalPrice');
            const unitPriceInput = document.getElementById('unitPrice');
            const supplierInput = document.getElementById('supplier');
            
            if (transactionType === 'out') {
                // ‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å - ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢
                priceInputGroups.forEach(group => {
                    group.style.display = 'none';
                });
                supplierGroup.style.display = 'none';
                
                // ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢
                totalPriceInput.required = false;
                unitPriceInput.required = false;
                supplierInput.required = false;
                
                // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
                totalPriceInput.value = '';
                unitPriceInput.value = '';
                supplierInput.value = '‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                
            } else if (transactionType === 'in') {
                // ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ - ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                priceInputGroups.forEach(group => {
                    group.style.display = 'block';
                });
                supplierGroup.style.display = 'block';
                
                // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢
                supplierInput.required = true;
                supplierInput.value = '';
                
            } else {
                // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó - ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                priceInputGroups.forEach(group => {
                    group.style.display = 'block';
                });
                supplierGroup.style.display = 'block';
                supplierInput.required = true;
            }
        }

        function calculateAutoPrice() {
            const transactionType = document.getElementById('transactionType').value;
            const itemCode = document.getElementById('itemSelect').value;
            const quantity = parseFloat(document.getElementById('quantity').value);
            
            if (transactionType === 'out' && itemCode && quantity > 0) {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å FIFO ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å
                const item = demoData.items[currentDepartment][itemCode];
                if (item && item.batches && item.batches.length > 0) {
                    
                    // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô FIFO
                    let remainingToCalculate = quantity;
                    let totalCost = 0;
                    
                    for (let i = 0; i < item.batches.length && remainingToCalculate > 0; i++) {
                        const batch = item.batches[i];
                        const quantityToTake = Math.min(batch.quantity, remainingToCalculate);
                        
                        totalCost += quantityToTake * batch.unitPrice;
                        remainingToCalculate -= quantityToTake;
                    }
                    
                    const avgPrice = quantity > 0 ? totalCost / quantity : 0;
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå)
                    showCostPreview(totalCost, avgPrice);
                }
            } else {
                hideCostPreview();
            }
        }

        function showCostPreview(totalCost, avgPrice) {
            let preview = document.getElementById('costPreview');
            if (!preview) {
                preview = document.createElement('div');
                preview.id = 'costPreview';
                preview.style.cssText = `
                    margin-top: 10px;
                    padding: 10px;
                    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
                    border-radius: 8px;
                    border: 1px solid rgba(0,0,0,0.1);
                    font-size: 0.9rem;
                `;
                document.getElementById('quantity').parentNode.appendChild(preview);
            }
            
            preview.innerHTML = `
                <div style="color: #1976d2; font-weight: 600;">üí∞ ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô FIFO (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</div>
                <div style="margin-top: 5px;">
                    ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏Å.: <strong>${avgPrice.toFixed(2)} ‡∏ö‡∏≤‡∏ó</strong><br>
                    ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: <strong>${totalCost.toFixed(2)} ‡∏ö‡∏≤‡∏ó</strong>
                </div>
                <small style="color: #666;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</small>
            `;
        }

        function hideCostPreview() {
            const preview = document.getElementById('costPreview');
            if (preview) {
                preview.remove();
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function calculatePackageUnits(stock, packaging) {
            if (!packaging || stock <= 0) return '';
            
            // Extract number from packaging text
            const numbers = packaging.match(/(\d+(?:\.\d+)?)/g);
            if (!numbers || numbers.length === 0) return '';
            
            const packageSize = parseFloat(numbers[0]);
            if (packageSize <= 0) return '';
            
            const units = Math.floor(stock / packageSize);
            const remainder = stock % packageSize;
            
            // Determine unit type from packaging text
            let unitType = '‡∏´‡πà‡∏≠';
            if (packaging.includes('‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö')) unitType = '‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö';
            else if (packaging.includes('‡∏ñ‡∏∏‡∏á')) unitType = '‡∏ñ‡∏∏‡∏á';
            else if (packaging.includes('‡∏Å‡∏•‡πà‡∏≠‡∏á')) unitType = '‡∏Å‡∏•‡πà‡∏≠‡∏á';
            
            if (units > 0 && remainder > 0) {
                return `(${units} ${unitType} + ${remainder.toFixed(1)} ‡∏Å‡∏Å.)`;
            } else if (units > 0) {
                return `(${units} ${unitType})`;
            } else {
                return `(${remainder.toFixed(1)} ‡∏Å‡∏Å.)`;
            }
        }

        // ===== PERMISSION FUNCTIONS =====
        function hasPermission(department) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true;
            return currentUser.department === department;
        }

        function canAccessAllDepartments() {
            return currentUser && currentUser.role === 'admin';
        }

        function getUserDepartments() {
            if (!currentUser) return [];
            if (currentUser.role === 'admin') return ['farm', 'breeding'];
            return [currentUser.department];
        }

        function filterDataByPermission(data) {
            if (canAccessAllDepartments()) return data;
            
            const userDepts = getUserDepartments();
            const filteredData = {};
            
            userDepts.forEach(dept => {
                if (data[dept]) {
                    filteredData[dept] = data[dept];
                }
            });
            
            return filteredData;
        }
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type} show`;
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span><strong>${message}</strong></span>
                    <button onclick="hideNotification()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">√ó</button>
                </div>
            `;
            
            setTimeout(() => hideNotification(), 5000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        function logMessage(message) {
            const debugLog = document.getElementById('debugLog');
            if (debugLog) {
                const time = new Date().toLocaleTimeString();
                debugLog.innerHTML += `[${time}] ${message}<br>`;
                debugLog.scrollTop = debugLog.scrollHeight;
            }
            console.log(message);
        }

        function calculateDaysDifference(dateString) {
            const targetDate = new Date(dateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to start of day
            targetDate.setHours(0, 0, 0, 0);
            
            const diffTime = targetDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function getExpiryStatus(expiryDate, expiryDays = 7) {
            const daysUntilExpiry = calculateDaysDifference(expiryDate);
            
            if (daysUntilExpiry < 0) {
                return { status: 'expired', statusClass: 'status-expired', message: '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß' };
            } else if (daysUntilExpiry <= expiryDays) {
                return { status: 'expiring', statusClass: 'status-danger', message: `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${daysUntilExpiry} ‡∏ß‡∏±‡∏ô` };
            } else if (daysUntilExpiry <= expiryDays * 2) {
                return { status: 'warning', statusClass: 'status-warning', message: `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${daysUntilExpiry} ‡∏ß‡∏±‡∏ô` };
            } else {
                return { status: 'normal', statusClass: 'status-normal', message: `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${daysUntilExpiry} ‡∏ß‡∏±‡∏ô` };
            }
        }

        // ===== LOGIN FUNCTIONS =====
        function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            logMessage('üîë Login attempt: ' + email);
            
            if (!email || !password) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'error');
                return;
            }
            
            const user = users[email];
            if (user && user.password === password) {
                logMessage('‚úÖ Login successful: ' + user.name);
                
                currentUser = {
                    name: user.name,
                    email: email,
                    role: user.role,
                    department: user.department,
                    lastLogin: new Date().toISOString()
                };
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('dairyStockData', JSON.stringify(demoData));
                showNotification('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                showMainApp();
            } else {
                logMessage('‚ùå Login failed');
                showNotification('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            }
        }

        function quickLogin(type) {
            const accounts = {
                'admin': { email: 'admin@dairy.co.th', password: 'admin123' },
                'farm': { email: 'farm@dairy.co.th', password: 'farm123' },
                'breeding': { email: 'breeding@dairy.co.th', password: 'breed123' }
            };
            
            const account = accounts[type];
            if (account) {
                document.getElementById('loginEmail').value = account.email;
                document.getElementById('loginPassword').value = account.password;
                doLogin();
            }
        }

        function showDebug() {
            const debugPanel = document.getElementById('debugInfo');
            debugPanel.classList.toggle('hide');
            
            if (!debugPanel.classList.contains('hide')) {
                logMessage('üîß Debug panel opened');
                logMessage('üë• Available users: ' + Object.keys(users).join(', '));
                logMessage('üì± Current user: ' + (currentUser ? currentUser.name : 'None'));
                logMessage('üíæ LocalStorage: ' + (localStorage ? 'Available' : 'Not available'));
                logMessage('üì¶ Total items: ' + (Object.keys(demoData.items.farm).length + Object.keys(demoData.items.breeding).length));
            }
        }

        function logout() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                showLoginScreen();
                showNotification('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            }
        }

        // ===== APP FUNCTIONS =====
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.add('hide');
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hide');
            
            if (currentUser) {
                document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('recorder').value = currentUser.name;
                
                // ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• nav-tabs ‡∏ï‡∏≤‡∏° role
                setupNavigationByRole();
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏° role
                if (currentUser.role === 'farm') {
                    currentDepartment = 'farm';
                    selectDepartment('farm');
                } else if (currentUser.role === 'breeding') {
                    currentDepartment = 'breeding';
                    selectDepartment('breeding');
                }
            }
            
            setupCurrentDateTime();
            updateStats();
            updateInventoryTables();
            updateItemSelect();
            updateManagementTable();
            generateAlerts();
            loadAlertSettings();
            updateOverallStats();
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
            toggleFormFields();
        }

        function setupNavigationByRole() {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å tab ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å role (admin, farm, breeding)
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.style.display = 'block');
        }

        function showSection(sectionName) {
            // Remove active class from all sections and tabs
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Add active class to selected section and tab
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');

            // Update data when switching to specific sections
            if (sectionName === 'inventory') {
                updateInventoryTables();
            } else if (sectionName === 'management') {
                updateManagementTable();
            } else if (sectionName === 'alerts') {
                generateAlerts();
            } else if (sectionName === 'reports') {
                updateOverallStats();
                setupReportsAccess();
            }
        }

        function setupReportsAccess() {
            const reportDeptSelect = document.getElementById('reportDepartment');
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
            if (reportDeptSelect) {
                reportDeptSelect.innerHTML = '';
                
                if (currentUser.role === 'admin') {
                    reportDeptSelect.innerHTML = `
                        <option value="all">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                        <option value="farm">‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÇ‡∏Ñ‡∏ô‡∏°</option>
                        <option value="breeding">‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</option>
                    `;
                } else if (currentUser.role === 'farm') {
                    reportDeptSelect.innerHTML = '<option value="farm">‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÇ‡∏Ñ‡∏ô‡∏°</option>';
                } else if (currentUser.role === 'breeding') {
                    reportDeptSelect.innerHTML = '<option value="breeding">‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</option>';
                }
            }
        }

        function selectDepartment(dept) {
            currentDepartment = dept;
            
            document.getElementById('deptFarm').classList.toggle('selected', dept === 'farm');
            document.getElementById('deptBreeding').classList.toggle('selected', dept === 'breeding');
            
            const title = dept === 'farm' ? 'üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö-‡∏à‡πà‡∏≤‡∏¢‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö TMR' : 'üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö-‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡πâ‡∏ô';
            document.getElementById('recordTitle').textContent = title;
            
            updateItemSelect();
        }

        function setupCurrentDateTime() {
            const now = new Date();
            document.getElementById('recordDate').value = now.toISOString().split('T')[0];
            document.getElementById('recordTime').value = now.toTimeString().slice(0, 5);
        }

        function updateItemSelect() {
            const select = document.getElementById('itemSelect');
            const items = demoData.items[currentDepartment];
            
            select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>';
            
            Object.entries(items).forEach(([code, item]) => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = item.name;
                option.dataset.pricePerKg = item.pricePerKg;
                select.appendChild(option);
            });
        }

        function updateStats() {
            const filteredItems = filterDataByPermission(demoData.items);
            const allItems = {};
            
            // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á
            Object.values(filteredItems).forEach(deptItems => {
                Object.assign(allItems, deptItems);
            });
            
            const totalItems = Object.keys(allItems).length;
            
            let totalValue = 0;
            let farmValue = 0;
            let breedingValue = 0;
            let lowStock = 0;
            let expiringSoon = 0;
            let expiredItems = 0;
            
            // Calculate farm value and alerts (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)
            if (hasPermission('farm') && demoData.items.farm) {
                Object.values(demoData.items.farm).forEach(item => {
                    const value = item.stock * item.pricePerKg;
                    farmValue += value;
                    totalValue += value;
                    
                    const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                    if (item.stock <= lowStockThreshold) {
                        lowStock++;
                    }

                    const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                    if (expiryStatus.status === 'expired') {
                        expiredItems++;
                    } else if (expiryStatus.status === 'expiring') {
                        expiringSoon++;
                    }
                });
            }
            
            // Calculate breeding value and alerts (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)
            if (hasPermission('breeding') && demoData.items.breeding) {
                Object.values(demoData.items.breeding).forEach(item => {
                    const value = item.stock * item.pricePerKg;
                    breedingValue += value;
                    totalValue += value;
                    
                    const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                    if (item.stock <= lowStockThreshold) {
                        lowStock++;
                    }

                    const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                    if (expiryStatus.status === 'expired') {
                        expiredItems++;
                    } else if (expiryStatus.status === 'expiring') {
                        expiringSoon++;
                    }
                });
            }
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalValue').textContent = totalValue.toLocaleString('th-TH', { maximumFractionDigits: 0 });
            
            // ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô stat cards ‡∏ï‡∏≤‡∏° role
            const farmValueCard = document.getElementById('farmValue').closest('.stat-card');
            const breedingValueCard = document.getElementById('breedingValue').closest('.stat-card');
            
            if (hasPermission('farm')) {
                document.getElementById('farmValue').textContent = farmValue.toLocaleString('th-TH', { maximumFractionDigits: 0 });
                farmValueCard.style.display = 'block';
            } else {
                farmValueCard.style.display = 'none';
            }
            
            if (hasPermission('breeding')) {
                document.getElementById('breedingValue').textContent = breedingValue.toLocaleString('th-TH', { maximumFractionDigits: 0 });
                breedingValueCard.style.display = 'block';
            } else {
                breedingValueCard.style.display = 'none';
            }
            
            document.getElementById('lowStock').textContent = lowStock;
            document.getElementById('expiringSoon').textContent = expiringSoon;
            document.getElementById('expiredItems').textContent = expiredItems;
        }

        function updateInventoryTables() {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            const farmSection = document.querySelector('#inventory .card:first-child');
            const breedingSection = document.querySelector('#inventory .card:last-child');
            
            console.log('Current user:', currentUser);
            console.log('Has farm permission:', hasPermission('farm'));
            console.log('Has breeding permission:', hasPermission('breeding'));
            
            if (hasPermission('farm')) {
                farmSection.style.display = 'block';
                updateInventoryTable('farm', 'farmInventoryTable');
            } else {
                farmSection.style.display = 'none';
            }
            
            if (hasPermission('breeding')) {
                breedingSection.style.display = 'block';
                updateInventoryTable('breeding', 'breedingInventoryTable');
            } else {
                breedingSection.style.display = 'none';
            }
        }

        function updateInventoryTable(department, tableId) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';
            
            const items = demoData.items[department] || {};
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            if (Object.keys(items).length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #7f8c8d; font-style: italic;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö<br><small>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</small></td></tr>';
                return;
            }
            
            Object.entries(items).forEach(([code, item]) => {
                const row = document.createElement('tr');
                
                // Check stock status
                const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                let stockStatus, stockStatusClass;
                
                if (item.stock === 0) {
                    stockStatus = '‡∏´‡∏°‡∏î';
                    stockStatusClass = 'status-danger';
                } else if (item.stock <= lowStockThreshold) {
                    stockStatus = '‡∏ï‡πà‡∏≥';
                    stockStatusClass = 'status-warning';
                } else {
                    stockStatus = '‡∏õ‡∏Å‡∏ï‡∏¥';
                    stockStatusClass = 'status-normal';
                }

                // Check expiry status
                const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                
                // Combined status (prioritize expiry over stock)
                let finalStatus, finalStatusClass;
                if (expiryStatus.status === 'expired') {
                    finalStatus = '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏';
                    finalStatusClass = 'status-expired';
                } else if (expiryStatus.status === 'expiring') {
                    finalStatus = `‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ${expiryStatus.message}`;
                    finalStatusClass = 'status-danger';
                } else if (stockStatus === '‡∏´‡∏°‡∏î') {
                    finalStatus = stockStatus;
                    finalStatusClass = stockStatusClass;
                } else if (stockStatus === '‡∏ï‡πà‡∏≥') {
                    finalStatus = `‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡πà‡∏≥`;
                    finalStatusClass = stockStatusClass;
                } else {
                    finalStatus = '‡∏õ‡∏Å‡∏ï‡∏¥';
                    finalStatusClass = 'status-normal';
                }
                
                const currentPrice = getAveragePrice(code, department);
                const totalValue = item.stock * currentPrice;
                const expiryDate = new Date(item.expiryDate).toLocaleDateString('th-TH');
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                const specs = item.specifications || {};
                const packaging = specs.packaging ? `<br><small style="color: #666;">üì¶ ${specs.packaging}</small>` : '';
                const protein = specs.protein ? `<br><small style="color: #666;">ü•© ${specs.protein}</small>` : '';
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏£‡∏à‡∏∏
                const packageUnits = calculatePackageUnits(item.stock, specs.packaging);
                const stockDisplay = packageUnits ? 
                    `<strong>${item.stock.toLocaleString()}</strong><br><small style="color: #999; font-size: 0.8rem;">${packageUnits}</small>` : 
                    `<strong>${item.stock.toLocaleString()}</strong>`;
                
                row.innerHTML = `
                    <td>
                        <strong>${item.name}</strong><br>
                        <small style="color: #666;">${code}</small>
                        ${packaging}${protein}
                    </td>
                    <td>${stockDisplay}</td>
                    <td>${currentPrice.toFixed(2)}<br><small style="color: #666;">FIFO</small></td>
                    <td><strong style="color: #27ae60;">${totalValue.toLocaleString('th-TH', { maximumFractionDigits: 0 })}</strong></td>
                    <td>${expiryDate}</td>
                    <td><span class="status-badge ${finalStatusClass}">${finalStatus}</span></td>
                    <td style="text-align: center; white-space: nowrap;">
                        <div style="display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-info" style="padding: 6px 10px; font-size: 0.75rem; min-width: 70px;" onclick="showItemDetails('${code}', '${department}')" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                                ‚ÑπÔ∏è ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                            </button>
                            <button class="btn btn-warning" style="padding: 6px 10px; font-size: 0.75rem; min-width: 60px;" onclick="editItem('${code}', '${department}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <button class="btn btn-danger" style="padding: 6px 10px; font-size: 0.75rem; min-width: 50px;" onclick="deleteItem('${code}', '${department}')" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                                üóëÔ∏è ‡∏•‡∏ö
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function sortManagementTable() {
            const sortBy = document.getElementById('sortBy').value;
            const filterDept = document.getElementById('filterDepartment').value;
            const filterStatus = document.getElementById('filterStatus').value;
            
            // Combine items ‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
            let allItems = [];
            
            if (hasPermission('farm') && demoData.items.farm) {
                Object.entries(demoData.items.farm).forEach(([code, item]) => {
                    allItems.push({ ...item, code, department: 'farm', departmentName: '‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÇ‡∏Ñ‡∏ô‡∏°' });
                });
            }
            
            if (hasPermission('breeding') && demoData.items.breeding) {
                Object.entries(demoData.items.breeding).forEach(([code, item]) => {
                    allItems.push({ ...item, code, department: 'breeding', departmentName: '‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏Ø' });
                });
            }
            
            // Filter by department
            if (filterDept !== 'all') {
                allItems = allItems.filter(item => item.department === filterDept);
            }
            
            // Filter by status
            if (filterStatus !== 'all') {
                allItems = allItems.filter(item => {
                    const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                    const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                    
                    let status = 'normal';
                    if (expiryStatus.status === 'expired') {
                        status = 'expired';
                    } else if (expiryStatus.status === 'expiring' || item.stock === 0) {
                        status = 'danger';
                    } else if (expiryStatus.status === 'warning' || item.stock <= lowStockThreshold) {
                        status = 'warning';
                    }
                    
                    return status === filterStatus;
                });
            }
            
            // Sort items
            allItems.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name, 'th');
                    case 'name_desc':
                        return b.name.localeCompare(a.name, 'th');
                    case 'department':
                        return a.departmentName.localeCompare(b.departmentName, 'th');
                    case 'stock_desc':
                        return b.stock - a.stock;
                    case 'stock_asc':
                        return a.stock - b.stock;
                    case 'price_desc':
                        return getAveragePrice(b.code, b.department) - getAveragePrice(a.code, a.department);
                    case 'price_asc':
                        return getAveragePrice(a.code, a.department) - getAveragePrice(b.code, b.department);
                    case 'expiry_asc':
                        return new Date(a.expiryDate) - new Date(b.expiryDate);
                    case 'expiry_desc':
                        return new Date(b.expiryDate) - new Date(a.expiryDate);
                    case 'status':
                        const getStatusPriority = (item) => {
                            const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                            const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                            
                            if (expiryStatus.status === 'expired') return 1;
                            if (expiryStatus.status === 'expiring' || item.stock === 0) return 2;
                            if (expiryStatus.status === 'warning' || item.stock <= lowStockThreshold) return 3;
                            return 4;
                        };
                        return getStatusPriority(a) - getStatusPriority(b);
                    default:
                        return 0;
                }
            });
            
            // Update table
            const tbody = document.getElementById('managementTable');
            tbody.innerHTML = '';
            
            if (allItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>';
                return;
            }
            
            allItems.forEach(item => {
                const row = document.createElement('tr');
                
                // Check both stock and expiry status
                const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                
                let finalStatus, finalStatusClass;
                if (expiryStatus.status === 'expired') {
                    finalStatus = '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏';
                    finalStatusClass = 'status-expired';
                } else if (expiryStatus.status === 'expiring') {
                    finalStatus = `‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ${expiryStatus.message}`;
                    finalStatusClass = 'status-danger';
                } else if (item.stock === 0) {
                    finalStatus = '‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏´‡∏°‡∏î';
                    finalStatusClass = 'status-danger';
                } else if (item.stock <= lowStockThreshold) {
                    finalStatus = '‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡πà‡∏≥';
                    finalStatusClass = 'status-warning';
                } else {
                    finalStatus = '‡∏õ‡∏Å‡∏ï‡∏¥';
                    finalStatusClass = 'status-normal';
                }
                
                const currentPrice = getAveragePrice(item.code, item.department);
                const expiryDate = new Date(item.expiryDate).toLocaleDateString('th-TH');
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏£‡∏à‡∏∏
                const specs = item.specifications || {};
                const packageUnits = calculatePackageUnits(item.stock, specs.packaging);
                const stockDisplay = packageUnits ? 
                    `${item.stock.toLocaleString()}<br><small style="color: #999; font-size: 0.8rem;">${packageUnits}</small>` : 
                    item.stock.toLocaleString();
                
                row.innerHTML = `
                    <td><strong>${item.name}</strong><br><small style="color: #666;">${item.code}</small></td>
                    <td>${item.departmentName}</td>
                    <td>${stockDisplay}</td>
                    <td>${currentPrice.toFixed(2)}</td>
                    <td>${expiryDate}</td>
                    <td><span class="status-badge ${finalStatusClass}">${finalStatus}</span></td>
                    <td style="text-align: center; white-space: nowrap;">
                        <div style="display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-info" style="padding: 6px 10px; font-size: 0.75rem; min-width: 70px;" onclick="showItemDetails('${item.code}', '${item.department}')" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                                ‚ÑπÔ∏è ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                            </button>
                            <button class="btn btn-warning" style="padding: 6px 10px; font-size: 0.75rem; min-width: 60px;" onclick="editItem('${item.code}', '${item.department}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <button class="btn btn-danger" style="padding: 6px 10px; font-size: 0.75rem; min-width: 50px;" onclick="deleteItem('${item.code}', '${item.department}')" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                                üóëÔ∏è ‡∏•‡∏ö
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateManagementTable() {
            // Setup filter options based on permissions
            const filterDeptSelect = document.getElementById('filterDepartment');
            if (filterDeptSelect) {
                filterDeptSelect.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>';
                
                if (hasPermission('farm')) {
                    filterDeptSelect.innerHTML += '<option value="farm">‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÇ‡∏Ñ‡∏ô‡∏°</option>';
                }
                if (hasPermission('breeding')) {
                    filterDeptSelect.innerHTML += '<option value="breeding">‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</option>';
                }
            }
            
            // Call sort function to display data
            sortManagementTable();
        }

        function generateAlerts() {
            const container = document.getElementById('alertsContent');
            const filteredItems = filterDataByPermission(demoData.items);
            const allItems = {};
            
            // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á
            Object.values(filteredItems).forEach(deptItems => {
                Object.assign(allItems, deptItems);
            });
            
            let alerts = [];
            
            // Check for expired and expiring items
            Object.entries(allItems).forEach(([code, item]) => {
                const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                
                if (expiryStatus.status === 'expired') {
                    alerts.push({
                        type: 'danger',
                        message: `${item.name} - ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß (${new Date(item.expiryDate).toLocaleDateString('th-TH')})`
                    });
                } else if (expiryStatus.status === 'expiring') {
                    alerts.push({
                        type: 'warning',
                        message: `${item.name} - ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ${expiryStatus.message} (${new Date(item.expiryDate).toLocaleDateString('th-TH')})`
                    });
                }

                // Check for low stock
                const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                if (item.stock === 0) {
                    alerts.push({
                        type: 'danger',
                        message: `${item.name} - ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏´‡∏°‡∏î (‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)`
                    });
                } else if (item.stock <= lowStockThreshold) {
                    alerts.push({
                        type: 'warning',
                        message: `${item.name} - ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡πà‡∏≥ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${item.stock.toLocaleString()} ‡∏Å‡∏Å.`
                    });
                }
            });
            
            if (alerts.length === 0) {
                container.innerHTML = '<div class="alert alert-success"><strong>‚úÖ ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏Å‡∏ï‡∏¥:</strong> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>';
                return;
            }
            
            const groupedAlerts = alerts.reduce((acc, alert) => {
                if (!acc[alert.type]) acc[alert.type] = [];
                acc[alert.type].push(alert.message);
                return acc;
            }, {});
            
            let alertsHTML = '';
            
            if (groupedAlerts.danger) {
                alertsHTML += `
                    <div class="alert alert-danger">
                        <strong>üö® ‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô:</strong>
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            ${groupedAlerts.danger.map(msg => `<li>${msg}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (groupedAlerts.warning) {
                alertsHTML += `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°:</strong>
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            ${groupedAlerts.warning.map(msg => `<li>${msg}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            container.innerHTML = alertsHTML;
        }

        // ===== ITEM MANAGEMENT FUNCTIONS =====
        function showItemModal() {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
            const userDepts = getUserDepartments();
            if (userDepts.length === 0) {
                showNotification('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà', 'error');
                return;
            }
            
            editingItemId = null;
            document.getElementById('modalTitle').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('saveItemBtn').textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            document.getElementById('itemForm').reset();
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á dropdown ‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå - ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å
            const deptSelect = document.getElementById('itemDepartment');
            deptSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>';
            
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô admin ‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            if (currentUser.role === 'admin') {
                deptSelect.innerHTML += '<option value="farm">‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÇ‡∏Ñ‡∏ô‡∏° (TMR)</option>';
                deptSelect.innerHTML += '<option value="breeding">‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>';
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà admin ‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
                if (currentUser.role === 'farm') {
                    deptSelect.innerHTML += '<option value="farm">‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÇ‡∏Ñ‡∏ô‡∏° (TMR)</option>';
                    deptSelect.value = 'farm'; // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Ñ
                    deptSelect.disabled = true;
                } else if (currentUser.role === 'breeding') {
                    deptSelect.innerHTML += '<option value="breeding">‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>';
                    deptSelect.value = 'breeding'; // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Ñ
                    deptSelect.disabled = true;
                }
            }
            
            document.getElementById('itemModal').classList.add('show');
        }

        function closeItemModal() {
            document.getElementById('itemModal').classList.remove('show');
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î modal
            document.getElementById('itemDepartment').disabled = false;
            
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            document.getElementById('itemForm').reset();
            document.getElementById('itemPackaging').value = '';
            document.getElementById('itemProtein').value = '';
            document.getElementById('itemFat').value = '';
            document.getElementById('itemMoisture').value = '';
            document.getElementById('itemFiber').value = '';
            document.getElementById('itemAsh').value = '';
            document.getElementById('itemOther').value = '';
            document.getElementById('itemCondition').value = '';
            
            editingItemId = null;
        }

        function editItem(code, department) {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç - ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å
            if (!hasPermission(department)) {
                showNotification('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å‡∏ô‡∏µ‡πâ', 'error');
                return;
            }
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà admin ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            if (currentUser.role !== 'admin' && currentUser.department !== department) {
                showNotification('‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                return;
            }
            
            const item = demoData.items[department][code];
            if (!item) return;
            
            editingItemId = code;
            document.getElementById('modalTitle').textContent = `‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${item.name}`;
            document.getElementById('saveItemBtn').textContent = 'üíæ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó';
            
            // Fill form with current data
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemDepartment').value = department;
            document.getElementById('itemReorder').value = item.reorderPoint;
            document.getElementById('itemNotes').value = item.notes || '';
            
            // Fill specifications
            const specs = item.specifications || {};
            document.getElementById('itemPackaging').value = specs.packaging || '';
            document.getElementById('itemProtein').value = specs.protein || '';
            document.getElementById('itemFat').value = specs.fat || '';
            document.getElementById('itemMoisture').value = specs.moisture || '';
            document.getElementById('itemFiber').value = specs.fiber || '';
            document.getElementById('itemAsh').value = specs.ash || '';
            document.getElementById('itemOther').value = specs.other || '';
            document.getElementById('itemCondition').value = specs.condition || '';
            
            // ‡∏•‡πá‡∏≠‡∏Ñ dropdown ‡πÅ‡∏ú‡∏ô‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å)
            const deptSelect = document.getElementById('itemDepartment');
            if (currentUser.role !== 'admin') {
                deptSelect.disabled = true;
            }
            
            document.getElementById('itemModal').classList.add('show');
        }

        function deleteItem(code, department) {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö - ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å
            if (!hasPermission(department)) {
                showNotification('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å‡∏ô‡∏µ‡πâ', 'error');
                return;
            }
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà admin ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            if (currentUser.role !== 'admin' && currentUser.department !== department) {
                showNotification('‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                return;
            }
            
            const item = demoData.items[department][code];
            if (!item) return;
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (item.stock > 0) {
                showNotification(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "${item.name}" ‡πÑ‡∏î‡πâ\n\n‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${item.stock.toLocaleString()} ‡∏Å‡∏Å.\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0`, 'error');
                return;
            }
            
            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "${item.name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`)) {
                delete demoData.items[department][code];
                localStorage.setItem('dairyStockData', JSON.stringify(demoData));
                
                showNotification(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "${item.name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                
                updateStats();
                updateInventoryTables();
                updateManagementTable();
                updateItemSelect();
                generateAlerts();
            }
        }

        function saveItem(event) {
            event.preventDefault();
            
            const name = document.getElementById('itemName').value;
            const department = document.getElementById('itemDepartment').value;
            const reorderPoint = parseFloat(document.getElementById('itemReorder').value);
            const notes = document.getElementById('itemNotes').value;
            
            // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏´‡∏°‡πà
            const packaging = document.getElementById('itemPackaging').value;
            const protein = document.getElementById('itemProtein').value;
            const fat = document.getElementById('itemFat').value;
            const moisture = document.getElementById('itemMoisture').value;
            const fiber = document.getElementById('itemFiber').value;
            const ash = document.getElementById('itemAsh').value;
            const other = document.getElementById('itemOther').value;
            const condition = document.getElementById('itemCondition').value;
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å - ‡∏´‡πâ‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å
            if (!hasPermission(department)) {
                showNotification('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å‡∏ô‡∏µ‡πâ', 'error');
                return;
            }
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà admin ‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            if (currentUser.role !== 'admin' && currentUser.department !== department) {
                showNotification('‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                return;
            }
            
            if (editingItemId) {
                // Update existing item
                const item = demoData.items[department][editingItemId];
                item.name = name;
                item.reorderPoint = reorderPoint;
                item.notes = notes;
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                item.specifications = {
                    packaging: packaging,
                    protein: protein,
                    fat: fat,
                    moisture: moisture,
                    fiber: fiber,
                    ash: ash,
                    other: other,
                    condition: condition
                };
                
                item.lastModified = new Date().toISOString();
                
                showNotification(`‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "${name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
            } else {
                // Add new item
                const existingItems = demoData.items[department] || {};
                const prefix = department === 'farm' ? 'F' : 'B';
                const nextNumber = Object.keys(existingItems).length + 1;
                const newCode = `${prefix}${nextNumber.toString().padStart(3, '0')}`;
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (1 ‡∏õ‡∏µ‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
                const defaultExpiry = new Date();
                defaultExpiry.setFullYear(defaultExpiry.getFullYear() + 1);
                
                demoData.items[department][newCode] = {
                    name: name,
                    stock: 0, // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 0
                    pricePerKg: 0, // ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
                    reorderPoint: reorderPoint,
                    expiryDate: defaultExpiry.toISOString().split('T')[0], // ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                    notes: notes,
                    specifications: {
                        packaging: packaging,
                        protein: protein,
                        fat: fat,
                        moisture: moisture,
                        fiber: fiber,
                        ash: ash,
                        other: other,
                        condition: condition
                    },
                    batches: [],
                    lastModified: new Date().toISOString()
                };
                
                showNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "${name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: 0 ‡∏Å‡∏Å. (‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤)`, 'success');
            }
            
            localStorage.setItem('dairyStockData', JSON.stringify(demoData));
            closeItemModal();
            
            // Update all displays
            updateStats();
            updateInventoryTables();
            updateManagementTable();
            updateItemSelect();
            generateAlerts();
        }

        // ===== FIFO INVENTORY MANAGEMENT =====
        function addToBatch(itemCode, department, quantity, unitPrice, expiryDate) {
            const item = demoData.items[department][itemCode];
            if (!item.batches) {
                item.batches = [];
            }

            item.batches.push({
                quantity: quantity,
                unitPrice: unitPrice,
                expiryDate: expiryDate,
                dateReceived: new Date().toISOString(),
                batchId: Date.now().toString()
            });

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° FIFO (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô-‡∏´‡∏•‡∏±‡∏á)
            item.batches.sort((a, b) => new Date(a.dateReceived) - new Date(b.dateReceived));
        }

        function removeFromBatch(itemCode, department, quantity) {
            const item = demoData.items[department][itemCode];
            if (!item.batches) return { totalCost: 0, avgPrice: 0 };

            let remainingToRemove = quantity;
            let totalCost = 0;
            let totalQuantityRemoved = 0;

            // ‡πÉ‡∏ä‡πâ FIFO - ‡πÄ‡∏≠‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
            for (let i = 0; i < item.batches.length && remainingToRemove > 0; i++) {
                const batch = item.batches[i];
                const quantityToTake = Math.min(batch.quantity, remainingToRemove);
                
                totalCost += quantityToTake * batch.unitPrice;
                totalQuantityRemoved += quantityToTake;
                
                batch.quantity -= quantityToTake;
                remainingToRemove -= quantityToTake;
                
                // ‡∏•‡∏ö batch ‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß
                if (batch.quantity <= 0) {
                    item.batches.splice(i, 1);
                    i--; // ‡∏õ‡∏£‡∏±‡∏ö index ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                }
            }

            const avgPrice = totalQuantityRemoved > 0 ? totalCost / totalQuantityRemoved : 0;
            return { totalCost, avgPrice, quantityRemoved: totalQuantityRemoved };
        }

        function getAveragePrice(itemCode, department) {
            const item = demoData.items[department][itemCode];
            if (!item.batches || item.batches.length === 0) return item.pricePerKg;

            let totalValue = 0;
            let totalQuantity = 0;

            item.batches.forEach(batch => {
                totalValue += batch.quantity * batch.unitPrice;
                totalQuantity += batch.quantity;
            });

            return totalQuantity > 0 ? totalValue / totalQuantity : item.pricePerKg;
        }

        // ===== USAGE TRACKING FUNCTIONS =====
        function showItemDetails(code, department) {
            const item = demoData.items[department][code];
            if (!item) return;

            document.getElementById('detailsModalTitle').textContent = `üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö: ${item.name}`;
            
            const specs = item.specifications || {};
            const batches = item.batches || [];
            
            let detailsHTML = `
                <div class="form-grid" style="margin-bottom: 25px;">
                    <div class="form-group">
                        <label>‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">${code}</div>
                    </div>
                    <div class="form-group">
                        <label>‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;"><strong>${item.stock.toLocaleString()} ‡∏Å‡∏Å.</strong></div>
                    </div>
                    <div class="form-group">
                        <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ FIFO</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;"><strong>${getAveragePrice(code, department).toFixed(2)} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.</strong></div>
                    </div>
                    <div class="form-group">
                        <label>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;"><strong>${(item.stock * getAveragePrice(code, department)).toLocaleString()} ‡∏ö‡∏≤‡∏ó</strong></div>
                    </div>
                </div>

                <h4>üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞</h4>
                <div class="table-container" style="margin-bottom: 25px;">
                    <table class="table">
                        <tbody>
            `;

            if (specs.packaging) detailsHTML += `<tr><td><strong>‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</strong></td><td>${specs.packaging}</td></tr>`;
            if (specs.protein) detailsHTML += `<tr><td><strong>‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</strong></td><td>${specs.protein}</td></tr>`;
            if (specs.fat) detailsHTML += `<tr><td><strong>‡πÑ‡∏Ç‡∏°‡∏±‡∏ô</strong></td><td>${specs.fat}</td></tr>`;
            if (specs.moisture) detailsHTML += `<tr><td><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô</strong></td><td>${specs.moisture}</td></tr>`;
            if (specs.fiber) detailsHTML += `<tr><td><strong>‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡πÉ‡∏¢</strong></td><td>${specs.fiber}</td></tr>`;
            if (specs.ash) detailsHTML += `<tr><td><strong>‡∏Å‡∏≤‡∏Å/‡πÄ‡∏ñ‡πâ‡∏≤</strong></td><td>${specs.ash}</td></tr>`;
            if (specs.other) detailsHTML += `<tr><td><strong>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</strong></td><td>${specs.other}</td></tr>`;
            if (specs.condition) detailsHTML += `<tr><td><strong>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</strong></td><td>${specs.condition}</td></tr>`;

            detailsHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            // ‡πÅ‡∏™‡∏î‡∏á Batch Information (FIFO)
            if (batches.length > 0) {
                detailsHTML += `
                    <h4>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Batch (FIFO)</h4>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th>
                                    <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏Å‡∏Å.)</th>
                                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏Å‡∏Å.</th>
                                    <th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                    <th>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                batches.forEach(batch => {
                    const dateReceived = new Date(batch.dateReceived).toLocaleDateString('th-TH');
                    const expiryDate = new Date(batch.expiryDate).toLocaleDateString('th-TH');
                    const value = batch.quantity * batch.unitPrice;
                    
                    detailsHTML += `
                        <tr>
                            <td>${dateReceived}</td>
                            <td><strong>${batch.quantity.toLocaleString()}</strong></td>
                            <td>${batch.unitPrice.toFixed(2)}</td>
                            <td>${expiryDate}</td>
                            <td><strong>${value.toLocaleString()}</strong></td>
                        </tr>
                    `;
                });

                detailsHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                detailsHTML += `
                    <div class="alert alert-info">
                        <strong>‚ÑπÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Batch:</strong> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö FIFO
                    </div>
                `;
            }

            if (item.notes) {
                detailsHTML += `
                    <h4>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</h4>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
                        ${item.notes}
                    </div>
                `;
            }

            document.getElementById('itemDetailsContent').innerHTML = detailsHTML;
            document.getElementById('itemDetailsModal').classList.add('show');
        }

        function closeItemDetailsModal() {
            document.getElementById('itemDetailsModal').classList.remove('show');
        }

        function recordUsage(itemCode, department, quantity, type) {
            const today = new Date().toISOString().split('T')[0];
            const usage = {
                date: today,
                itemCode: itemCode,
                department: department,
                quantity: Math.abs(quantity),
                type: type, // 'in' ‡∏´‡∏£‡∏∑‡∏≠ 'out'
                timestamp: new Date().toISOString()
            };
            
            if (!demoData.usageHistory) {
                demoData.usageHistory = [];
            }
            
            demoData.usageHistory.push(usage);
            localStorage.setItem('dairyStockData', JSON.stringify(demoData));
        }

        function generateUsageReport() {
            const period = parseInt(document.getElementById('reportPeriod').value);
            const department = document.getElementById('reportDepartment').value;
            const container = document.getElementById('reportResults');
            
            if (!demoData.usageHistory || demoData.usageHistory.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                    </div>
                `;
                return;
            }

            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - period);

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å
            const filteredHistory = demoData.usageHistory.filter(record => {
                const recordDate = new Date(record.date);
                const matchDate = recordDate >= startDate && recordDate <= endDate;
                const matchDept = department === 'all' || record.department === department;
                return matchDate && matchDept && record.type === 'out'; // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å
            });

            if (filteredHistory.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <strong>‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    </div>
                `;
                return;
            }

            // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const dailyUsage = {};
            const itemUsage = {};
            
            filteredHistory.forEach(record => {
                // ‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                if (!dailyUsage[record.date]) {
                    dailyUsage[record.date] = 0;
                }
                dailyUsage[record.date] += record.quantity;
                
                // ‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡πÑ‡∏≠‡πÄ‡∏ó‡∏°
                if (!itemUsage[record.itemCode]) {
                    itemUsage[record.itemCode] = 0;
                }
                itemUsage[record.itemCode] += record.quantity;
            });

            // ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î
            const dailyValues = Object.values(dailyUsage);
            const maxUsage = Math.max(...dailyValues);
            const minUsage = Math.min(...dailyValues);
            const avgUsage = dailyValues.reduce((a, b) => a + b, 0) / dailyValues.length;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
            let reportHTML = `
                <div class="alert alert-success">
                    <strong>‚úÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</strong> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ${period} ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                </div>
                
                <div class="stats-grid" style="margin-bottom: 25px;">
                    <div class="stat-card blue">
                        <div class="stat-number">${avgUsage.toFixed(1)}</div>
                        <div class="stat-label">‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô (‡∏Å‡∏Å.)</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-number">${maxUsage.toFixed(1)}</div>
                        <div class="stat-label">‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î/‡∏ß‡∏±‡∏ô (‡∏Å‡∏Å.)</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-number">${minUsage.toFixed(1)}</div>
                        <div class="stat-label">‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î/‡∏ß‡∏±‡∏ô (‡∏Å‡∏Å.)</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-number">${Object.keys(itemUsage).length}</div>
                        <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</div>
                    </div>
                </div>

                <h4>üìä ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h4>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÉ‡∏ä‡πâ (‡∏Å‡∏Å.)</th>
                                <th>‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
            Object.entries(dailyUsage).sort().forEach(([date, usage]) => {
                const diffPercent = ((usage - avgUsage) / avgUsage * 100);
                let status, statusClass;
                
                if (Math.abs(diffPercent) > 30) {
                    status = diffPercent > 0 ? 'üìà ‡∏™‡∏π‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥' : 'üìâ ‡∏ï‡πà‡∏≥‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
                    statusClass = 'status-warning';
                } else if (Math.abs(diffPercent) > 15) {
                    status = diffPercent > 0 ? '‚ÜóÔ∏è ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥' : '‚ÜòÔ∏è ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥';
                    statusClass = 'status-warning';
                } else {
                    status = '‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥';
                    statusClass = 'status-normal';
                }

                reportHTML += `
                    <tr>
                        <td>${new Date(date).toLocaleDateString('th-TH')}</td>
                        <td><strong>${usage.toFixed(1)}</strong></td>
                        <td>${diffPercent > 0 ? '+' : ''}${diffPercent.toFixed(1)}%</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                    </tr>
                `;
            });

            reportHTML += `
                        </tbody>
                    </table>
                </div>

                <h4>üèÜ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h4>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏° (‡∏Å‡∏Å.)</th>
                                <th>‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            const totalUsage = Object.values(itemUsage).reduce((a, b) => a + b, 0);
            Object.entries(itemUsage)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .forEach(([itemCode, usage]) => {
                    const percent = (usage / totalUsage * 100);
                    const itemName = getItemName(itemCode);
                    
                    reportHTML += `
                        <tr>
                            <td><strong>${itemName}</strong><br><small style="color: #666;">${itemCode}</small></td>
                            <td><strong>${usage.toFixed(1)}</strong></td>
                            <td>${percent.toFixed(1)}%</td>
                        </tr>
                    `;
                });

            reportHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = reportHTML;
        }

        function detectAnomalies() {
            const threshold = parseFloat(document.getElementById('anomalyThreshold').value);
            const interval = document.getElementById('compareInterval').value;
            const container = document.getElementById('anomalyResults');

            if (!demoData.usageHistory || demoData.usageHistory.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                    </div>
                `;
                return;
            }

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            demoData.settings.anomalyThreshold = threshold;
            localStorage.setItem('dairyStockData', JSON.stringify(demoData));

            const anomalies = findUsageAnomalies(threshold, interval);

            if (anomalies.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥:</strong> ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </div>
                `;
                return;
            }

            let anomalyHTML = `
                <div class="alert alert-warning">
                    <strong>üö® ‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥:</strong> ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ${anomalies.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
                                <th>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</th>
                                <th>‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</th>
                                <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            anomalies.forEach(anomaly => {
                const changePercent = anomaly.changePercent;
                let severityClass, severityText;
                
                if (Math.abs(changePercent) > 50) {
                    severityClass = 'status-danger';
                    severityText = 'üî¥ ‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å';
                } else if (Math.abs(changePercent) > 30) {
                    severityClass = 'status-warning';
                    severityText = 'üü° ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
                } else {
                    severityClass = 'status-warning';
                    severityText = 'üü† ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢';
                }

                anomalyHTML += `
                    <tr>
                        <td><strong>${anomaly.itemName}</strong><br><small style="color: #666;">${anomaly.itemCode}</small></td>
                        <td>${new Date(anomaly.date).toLocaleDateString('th-TH')}</td>
                        <td><strong>${anomaly.currentUsage.toFixed(1)} ‡∏Å‡∏Å.</strong></td>
                        <td>${anomaly.previousUsage.toFixed(1)} ‡∏Å‡∏Å.</td>
                        <td>${changePercent > 0 ? '+' : ''}${changePercent.toFixed(1)}%</td>
                        <td><span class="status-badge ${severityClass}">${severityText}</span></td>
                    </tr>
                `;
            });

            anomalyHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = anomalyHTML;
        }

        function findUsageAnomalies(threshold, interval) {
            const anomalies = [];
            const history = demoData.usageHistory.filter(record => record.type === 'out');
            
            if (history.length < 2) return anomalies;

            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° interval
            const groupedData = groupDataByInterval(history, interval);
            
            Object.entries(groupedData).forEach(([itemCode, periods]) => {
                const periodKeys = Object.keys(periods).sort();
                
                for (let i = 1; i < periodKeys.length; i++) {
                    const currentPeriod = periodKeys[i];
                    const previousPeriod = periodKeys[i - 1];
                    
                    const currentUsage = periods[currentPeriod];
                    const previousUsage = periods[previousPeriod];
                    
                    if (previousUsage > 0) {
                        const changePercent = ((currentUsage - previousUsage) / previousUsage) * 100;
                        
                        if (Math.abs(changePercent) > threshold) {
                            anomalies.push({
                                itemCode: itemCode,
                                itemName: getItemName(itemCode),
                                date: currentPeriod,
                                currentUsage: currentUsage,
                                previousUsage: previousUsage,
                                changePercent: changePercent
                            });
                        }
                    }
                }
            });

            return anomalies.sort((a, b) => Math.abs(b.changePercent) - Math.abs(a.changePercent));
        }

        function groupDataByInterval(history, interval) {
            const grouped = {};
            
            history.forEach(record => {
                const date = new Date(record.date);
                let periodKey;
                
                switch (interval) {
                    case 'daily':
                        periodKey = record.date;
                        break;
                    case 'weekly':
                        const weekStart = new Date(date);
                        weekStart.setDate(date.getDate() - date.getDay());
                        periodKey = weekStart.toISOString().split('T')[0];
                        break;
                    case 'monthly':
                        periodKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                        break;
                }
                
                if (!grouped[record.itemCode]) {
                    grouped[record.itemCode] = {};
                }
                
                if (!grouped[record.itemCode][periodKey]) {
                    grouped[record.itemCode][periodKey] = 0;
                }
                
                grouped[record.itemCode][periodKey] += record.quantity;
            });
            
            return grouped;
        }

        function getItemName(itemCode) {
            const allItems = { ...demoData.items.farm, ...demoData.items.breeding };
            return allItems[itemCode] ? allItems[itemCode].name : itemCode;
        }

        function updateOverallStats() {
            if (!demoData.usageHistory) return;
            
            const transactions = demoData.usageHistory.length;
            const outTransactions = demoData.usageHistory.filter(t => t.type === 'out');
            
            if (outTransactions.length === 0) {
                document.getElementById('totalTransactions').textContent = '0';
                document.getElementById('avgDailyUsage').textContent = '0';
                document.getElementById('peakUsageDay').textContent = '-';
                document.getElementById('mostUsedItem').textContent = '-';
                return;
            }

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
            const dailyUsage = {};
            const itemUsage = {};
            
            outTransactions.forEach(record => {
                if (!dailyUsage[record.date]) {
                    dailyUsage[record.date] = 0;
                }
                dailyUsage[record.date] += record.quantity;
                
                if (!itemUsage[record.itemCode]) {
                    itemUsage[record.itemCode] = 0;
                }
                itemUsage[record.itemCode] += record.quantity;
            });

            const dailyValues = Object.values(dailyUsage);
            const avgDaily = dailyValues.reduce((a, b) => a + b, 0) / dailyValues.length;
            
            const peakDay = Object.entries(dailyUsage).reduce((max, [date, usage]) => 
                usage > max.usage ? { date, usage } : max, { date: '', usage: 0 }
            );
            
            const mostUsed = Object.entries(itemUsage).reduce((max, [code, usage]) => 
                usage > max.usage ? { code, usage } : max, { code: '', usage: 0 }
            );

            document.getElementById('totalTransactions').textContent = transactions;
            document.getElementById('avgDailyUsage').textContent = avgDaily.toFixed(1);
            document.getElementById('peakUsageDay').textContent = peakDay.date ? 
                new Date(peakDay.date).toLocaleDateString('th-TH') : '-';
            document.getElementById('mostUsedItem').textContent = mostUsed.code ? 
                getItemName(mostUsed.code) : '-';
        }

        function calculatePricePerKg() {
            const transactionType = document.getElementById('transactionType').value;
            if (transactionType !== 'in') return; // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            
            const quantity = parseFloat(document.getElementById('quantity').value);
            const totalPrice = parseFloat(document.getElementById('totalPrice').value);
            
            if (quantity > 0 && totalPrice > 0) {
                const pricePerKg = totalPrice / quantity;
                document.getElementById('unitPrice').value = pricePerKg.toFixed(2);
            }
        }

        function calculateTotalPrice() {
            const transactionType = document.getElementById('transactionType').value;
            if (transactionType !== 'in') return; // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            
            const quantity = parseFloat(document.getElementById('quantity').value);
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);
            
            if (quantity > 0 && unitPrice > 0) {
                const totalPrice = quantity * unitPrice;
                document.getElementById('totalPrice').value = totalPrice.toFixed(2);
            }
        }

        function submitRecord(event) {
            event.preventDefault();
            
            const transactionType = document.getElementById('transactionType').value;
            const itemCode = document.getElementById('itemSelect').value;
            const quantity = parseFloat(document.getElementById('quantity').value);
            const notes = document.getElementById('notes').value;
            
            if (!itemCode || !quantity) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (!hasPermission(currentDepartment)) {
                showNotification('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å‡∏ô‡∏µ‡πâ', 'error');
                return;
            }

            const item = demoData.items[currentDepartment][itemCode];
            if (!item) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'error');
                return;
            }

            let costPerKg = 0;
            let actualUnitPrice = 0;
            let totalPrice = 0;
            let supplier = '';

            if (transactionType === 'in') {
                // ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å
                const inputTotalPrice = parseFloat(document.getElementById('totalPrice').value) || 0;
                const inputUnitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
                const inputSupplier = document.getElementById('supplier').value;
                
                if (!inputSupplier) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô', 'error');
                    return;
                }
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°
                if (inputTotalPrice > 0) {
                    actualUnitPrice = inputTotalPrice / quantity;
                    totalPrice = inputTotalPrice;
                } else if (inputUnitPrice > 0) {
                    actualUnitPrice = inputUnitPrice;
                    totalPrice = inputUnitPrice * quantity;
                } else {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°', 'error');
                    return;
                }
                
                supplier = inputSupplier;
                costPerKg = actualUnitPrice;
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡∏∞ batch
                item.stock += quantity;
                const expiryDate = item.expiryDate;
                addToBatch(itemCode, currentDepartment, quantity, actualUnitPrice, expiryDate);
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
                item.pricePerKg = getAveragePrice(itemCode, currentDepartment);
                
            } else if (transactionType === 'out') {
                // ‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å - ‡πÉ‡∏ä‡πâ FIFO ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                if (item.stock < quantity) {
                    showNotification(`‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${item.stock} ‡∏Å‡∏Å.)`, 'error');
                    return;
                }
                
                const fifoResult = removeFromBatch(itemCode, currentDepartment, quantity);
                item.stock -= quantity;
                costPerKg = fifoResult.avgPrice;
                totalPrice = quantity * costPerKg;
                supplier = '‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                actualUnitPrice = costPerKg;
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å
                if (item.stock > 0) {
                    item.pricePerKg = getAveragePrice(itemCode, currentDepartment);
                }
            }

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            recordUsage(itemCode, currentDepartment, quantity, transactionType);

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å transaction ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤ FIFO
            const transaction = {
                id: Date.now().toString(),
                date: document.getElementById('recordDate').value,
                time: document.getElementById('recordTime').value,
                type: transactionType,
                itemCode: itemCode,
                itemName: item.name,
                department: currentDepartment,
                quantity: quantity,
                unitPrice: costPerKg, // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏à‡∏£‡∏¥‡∏á (FIFO)
                inputPrice: actualUnitPrice, // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤
                totalPrice: totalPrice,
                supplier: supplier,
                recorder: currentUser.name,
                notes: notes,
                fifoApplied: true,
                timestamp: new Date().toISOString()
            };

            demoData.transactions.push(transaction);
            item.lastModified = new Date().toISOString();
            
            localStorage.setItem('dairyStockData', JSON.stringify(demoData));

            const actionText = transactionType === 'in' ? '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : '‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å';
            let successMessage = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£${actionText} "${item.name}" ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${quantity} ‡∏Å‡∏Å. ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`;
            
            if (transactionType === 'out') {
                successMessage += `\n‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô FIFO: ${costPerKg.toFixed(2)} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.\n‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°: ${totalPrice.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
            } else {
                successMessage += `\n‡∏£‡∏≤‡∏Ñ‡∏≤: ${actualUnitPrice.toFixed(2)} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.\n‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°: ${totalPrice.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
            }
            
            showNotification(successMessage, 'success');
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
            resetForm();
            
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            updateStats();
            updateInventoryTables();
            updateManagementTable();
            generateAlerts();
        }

        function resetForm() {
            document.querySelector('#record form').reset();
            setupCurrentDateTime();
            if (currentUser) {
                document.getElementById('recorder').value = currentUser.name;
            }
            
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
            document.getElementById('totalPrice').value = '';
            document.getElementById('unitPrice').value = '';
            document.getElementById('supplier').value = '';
            
            // ‡∏ã‡πà‡∏≠‡∏ô cost preview
            hideCostPreview();
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï form fields visibility
            toggleFormFields();
        }

        function saveAlertSettings() {
            const lowStockPercent = parseInt(document.getElementById('lowStockPercent').value);
            const expiryDays = parseInt(document.getElementById('expiryDays').value);
            const alertEmail = document.getElementById('alertEmail').value;
            
            demoData.settings.lowStockPercent = lowStockPercent;
            demoData.settings.expiryDays = expiryDays;
            demoData.settings.alertEmail = alertEmail;
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            const anomalyThresholdElement = document.getElementById('anomalyThreshold');
            if (anomalyThresholdElement) {
                demoData.settings.anomalyThreshold = parseInt(anomalyThresholdElement.value);
            }
            
            localStorage.setItem('dairyStockData', JSON.stringify(demoData));
            showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            
            // Regenerate alerts and stats with new settings
            generateAlerts();
            updateStats();
            updateInventoryTables();
            updateManagementTable();
        }

        function loadAlertSettings() {
            if (demoData.settings) {
                document.getElementById('lowStockPercent').value = demoData.settings.lowStockPercent || 20;
                document.getElementById('expiryDays').value = demoData.settings.expiryDays || 7;
                document.getElementById('alertEmail').value = demoData.settings.alertEmail || '';
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
                if (document.getElementById('anomalyThreshold')) {
                    document.getElementById('anomalyThreshold').value = demoData.settings.anomalyThreshold || 30;
                }
            }
        }

        function refreshData() {
            updateStats();
            updateInventoryTables();
            updateManagementTable();
            generateAlerts();
            showNotification('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        }

        function exportToExcel() {
            try {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á workbook ‡πÉ‡∏´‡∏°‡πà
                const workbook = XLSX.utils.book_new();
                const today = new Date().toLocaleDateString('th-TH');
                
                // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                const departments = [];
                if (hasPermission('farm')) departments.push({ key: 'farm', name: '‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÇ‡∏Ñ‡∏ô‡∏°' });
                if (hasPermission('breeding')) departments.push({ key: 'breeding', name: '‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πâ‡∏≠' });
                
                departments.forEach(dept => {
                    const items = demoData.items[dept.key] || {};
                    const worksheetData = [];
                    
                    // Header
                    worksheetData.push([
                        '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö - ' + dept.name,
                        '', '', '', '', '', '', ''
                    ]);
                    worksheetData.push([
                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö: ' + today,
                        '', '', '', '', '', '', ''
                    ]);
                    worksheetData.push([
                        '‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö: _________________________',
                        '', '', '', '', '', '', ''
                    ]);
                    worksheetData.push([]); // Empty row
                    
                    // Table headers
                    worksheetData.push([
                        '‡∏£‡∏´‡∏±‡∏™',
                        '‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö',
                        '‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏Å‡∏Å.)',
                        '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏£‡∏à‡∏∏',
                        '‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏Å‡∏Å.',
                        '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ (‡∏ö‡∏≤‡∏ó)',
                        '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏£‡∏¥‡∏á (‡∏Å‡∏Å.)',
                        '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'
                    ]);
                    
                    let totalSystemStock = 0;
                    let totalValue = 0;
                    
                    // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    Object.entries(items).forEach(([code, item]) => {
                        const specs = item.specifications || {};
                        const packageUnits = calculatePackageUnits(item.stock, specs.packaging);
                        const currentPrice = getAveragePrice(code, dept.key);
                        const value = item.stock * currentPrice;
                        
                        totalSystemStock += item.stock;
                        totalValue += value;
                        
                        worksheetData.push([
                            code,
                            item.name,
                            item.stock,
                            packageUnits || '',
                            currentPrice.toFixed(2),
                            Math.round(value),
                            '', // ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏£‡∏¥‡∏á
                            '' // ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
                        ]);
                    });
                    
                    // Summary
                    worksheetData.push([]); // Empty row
                    worksheetData.push([
                        '‡∏£‡∏ß‡∏°',
                        '',
                        totalSystemStock,
                        '',
                        '',
                        Math.round(totalValue),
                        '',
                        ''
                    ]);
                    
                    worksheetData.push([]); // Empty row
                    worksheetData.push([
                        '‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö:',
                        '', '', '', '', '', '', ''
                    ]);
                    worksheetData.push([
                        '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + Object.keys(items).length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                        '', '', '', '', '', '', ''
                    ]);
                    worksheetData.push([
                        '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ' + Math.round(totalValue).toLocaleString() + ' ‡∏ö‡∏≤‡∏ó',
                        '', '', '', '', '', '', ''
                    ]);
                    worksheetData.push([
                        '‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö: _________________________',
                        '', '', '', '', '', '', ''
                    ]);
                    worksheetData.push([
                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: _________________________',
                        '', '', '', '', '', '', ''
                    ]);
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á worksheet
                    const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                    
                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
                    worksheet['!cols'] = [
                        { width: 8 },   // ‡∏£‡∏´‡∏±‡∏™
                        { width: 25 },  // ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
                        { width: 15 },  // ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                        { width: 15 },  // ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏£‡∏à‡∏∏
                        { width: 12 },  // ‡∏£‡∏≤‡∏Ñ‡∏≤
                        { width: 15 },  // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤
                        { width: 15 },  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏£‡∏¥‡∏á
                        { width: 20 }   // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
                    ];
                    
                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå
                    worksheet['!margins'] = {
                        left: 0.7, right: 0.7, top: 0.75, bottom: 0.75,
                        header: 0.3, footer: 0.3
                    };
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° worksheet ‡πÄ‡∏Ç‡πâ‡∏≤ workbook
                    XLSX.utils.book_append_sheet(workbook, worksheet, dept.name);
                });
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Summary Sheet
                if (departments.length > 1) {
                    const summaryData = [];
                    
                    summaryData.push([
                        '‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å',
                        '', '', ''
                    ]);
                    summaryData.push([
                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ' + today,
                        '', '', ''
                    ]);
                    summaryData.push([]); // Empty row
                    
                    summaryData.push([
                        '‡πÅ‡∏ú‡∏ô‡∏Å',
                        '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                        '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)',
                        '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'
                    ]);
                    
                    let grandTotal = 0;
                    let totalItems = 0;
                    
                    departments.forEach(dept => {
                        const items = demoData.items[dept.key] || {};
                        const itemCount = Object.keys(items).length;
                        let deptValue = 0;
                        
                        Object.entries(items).forEach(([code, item]) => {
                            deptValue += item.stock * getAveragePrice(code, dept.key);
                        });
                        
                        grandTotal += deptValue;
                        totalItems += itemCount;
                        
                        summaryData.push([
                            dept.name,
                            itemCount,
                            Math.round(deptValue),
                            '‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß: ‚òê'
                        ]);
                    });
                    
                    summaryData.push([
                        '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                        totalItems,
                        Math.round(grandTotal),
                        ''
                    ]);
                    
                    const summaryWorksheet = XLSX.utils.aoa_to_sheet(summaryData);
                    summaryWorksheet['!cols'] = [
                        { width: 20 },
                        { width: 15 },
                        { width: 20 },
                        { width: 20 }
                    ];
                    
                    XLSX.utils.book_append_sheet(workbook, summaryWorksheet, '‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°');
                }
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå
                const fileName = `‡∏≠‡∏™‡∏Ñ-‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);
                
                showNotification('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö', 'success');
                
            } catch (error) {
                console.error('Export Excel error:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel', 'error');
            }
        }

        function exportData() {
            try {
                const data = {
                    items: demoData.items,
                    transactions: demoData.transactions,
                    settings: demoData.settings,
                    exportDate: new Date().toISOString(),
                    version: '2.0'
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `‡∏≠‡∏™‡∏Ñ-‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showNotification('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            } catch (error) {
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        }

        function backupData() {
            try {
                const backupData = {
                    ...demoData,
                    backupDate: new Date().toISOString(),
                    backupBy: currentUser?.email || 'unknown'
                };
                
                localStorage.setItem(`dairyBackup_${Date.now()}`, JSON.stringify(backupData));
                showNotification('‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            } catch (error) {
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('üöÄ App starting...');
            
            // Load saved data
            try {
                const savedData = localStorage.getItem('dairyStockData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    Object.assign(demoData, parsedData);
                    logMessage('‚úÖ Loaded saved data');
                }
            } catch (e) {
                logMessage('‚ùå Error loading saved data');
            }
            
            // Check for saved user
            try {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    logMessage('‚úÖ Found saved user: ' + currentUser.name);
                    showMainApp();
                    return;
                }
            } catch (e) {
                logMessage('‚ùå Error loading saved user');
                localStorage.removeItem('currentUser');
            }
            
            // Show login screen
            logMessage('üëã Showing login screen');
            showLoginScreen();
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
                doLogin();
            }
            
            if (event.key === 'Escape') {
                closeItemModal();
            }
        });

        // Close modal when clicking outside
        document.getElementById('itemModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeItemModal();
            }
        });

        document.getElementById('itemDetailsModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeItemDetailsModal();
            }
        });
    </script>
</body>
</html>
