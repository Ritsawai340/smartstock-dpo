<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartStock อ.ส.ค. - ระบบจัดการสต๊อกวัตถุดิบอาหารโคนมอัจฉริยะ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; overflow-x: hidden; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); padding: 50px; border-radius: 25px; box-shadow: 0 25px 80px rgba(0,0,0,0.2); width: 100%; max-width: 450px; text-align: center; border: 1px solid rgba(255,255,255,0.3); animation: slideInUp 0.8s ease-out; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .login-logo { font-size: 5rem; margin-bottom: 25px; animation: float 3s ease-in-out infinite; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.2)); }
        .login-title { font-size: 2.2rem; margin-bottom: 15px; color: #2c3e50; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .login-subtitle { color: #7f8c8d; margin-bottom: 35px; font-size: 1.1rem; font-weight: 500; }
        .form-group { margin-bottom: 25px; text-align: left; }
        label { display: block; margin-bottom: 10px; font-weight: 700; color: #2c3e50; font-size: 1rem; }
        input, select, textarea { width: 100%; padding: 15px 20px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 1.05rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15); transform: translateY(-2px); }
        .btn { display: inline-block; padding: 15px 30px; border: none; border-radius: 12px; cursor: pointer; font-size: 1.05rem; font-weight: 700; text-decoration: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); margin: 5px; position: relative; overflow: hidden; text-transform: uppercase; letter-spacing: 1px; }
        .btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); transition: left 0.5s; }
        .btn:hover::before { left: 100%; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; box-shadow: 0 10px 30px rgba(108, 117, 125, 0.3); }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; box-shadow: 0 10px 30px rgba(220, 53, 69, 0.3); }
        .btn-warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529; box-shadow: 0 10px 30px rgba(255, 193, 7, 0.3); }
        .btn-info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; box-shadow: 0 10px 30px rgba(23, 162, 184, 0.3); }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(0,0,0,0.2); }
        .btn:active { transform: translateY(-1px); }
        .btn-sm { padding: 6px 10px; font-size: 0.75rem; min-width: 50px; height: 32px; display: flex; align-items: center; justify-content: center; }
        .header { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 25px; border-radius: 20px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; box-shadow: 0 15px 50px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); position: relative; overflow: hidden; }
        .header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #667eea, #764ba2, #667eea); background-size: 200% 100%; animation: shimmer 3s ease-in-out infinite; }
        .header h1 { color: #2c3e50; font-size: 2.2rem; margin-bottom: 5px; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header p { color: #7f8c8d; font-size: 1rem; font-weight: 500; }
        .user-info { display: flex; align-items: center; gap: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 12px 20px; border-radius: 30px; border: 1px solid rgba(0,0,0,0.05); }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .nav-tabs { display: flex; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 20px; padding: 8px; margin-bottom: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow-x: auto; border: 1px solid rgba(255,255,255,0.3); }
        .nav-tab { flex: 1; padding: 15px 20px; text-align: center; background: transparent; border: none; border-radius: 12px; cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); font-size: 1rem; font-weight: 600; white-space: nowrap; min-width: 140px; position: relative; overflow: hidden; }
        .nav-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transform: translateY(-3px); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); }
        .nav-tab:hover:not(.active) { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 20px; padding: 30px; margin-bottom: 25px; box-shadow: 0 15px 50px rgba(0,0,0,0.08); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(255,255,255,0.3); position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #667eea, #764ba2, #667eea); background-size: 200% 100%; animation: shimmer 3s ease-in-out infinite; }
        .card:hover { transform: translateY(-8px); box-shadow: 0 25px 80px rgba(0,0,0,0.15); }
        .card h3 { color: #2c3e50; margin-bottom: 25px; font-size: 1.6rem; font-weight: 700; background: linear-gradient(135deg, #2c3e50 0%, #667eea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 25px; }
        .stat-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 15px 50px rgba(0,0,0,0.08); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; }
        .stat-card.green::before { background: linear-gradient(90deg, #27ae60, #2ecc71); }
        .stat-card.blue::before { background: linear-gradient(90deg, #3498db, #2980b9); }
        .stat-card.orange::before { background: linear-gradient(90deg, #f39c12, #e67e22); }
        .stat-card.red::before { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .stat-card.purple::before { background: linear-gradient(90deg, #9b59b6, #8e44ad); }
        .stat-card:hover { transform: translateY(-10px) scale(1.02); box-shadow: 0 25px 80px rgba(0,0,0,0.15); }
        .stat-number { font-size: 3rem; font-weight: 800; margin-bottom: 12px; background: linear-gradient(135deg, #2c3e50 0%, #667eea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: pulse 2s ease-in-out infinite; }
        .stat-label { font-weight: 600; color: #7f8c8d; font-size: 1.1rem; }
        .quick-actions { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 25px; }
        .department-selector { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
        .dept-card { flex: 1; min-width: 250px; padding: 25px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 20px; text-align: center; cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 3px solid transparent; box-shadow: 0 10px 40px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .dept-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
        .dept-card.selected { border-color: #667eea; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transform: translateY(-5px); box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4); }
        .dept-icon { font-size: 3.5rem; margin-bottom: 15px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1)); }
        .table-container { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 15px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 18px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .table th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; font-size: 0.95rem; }
        .table tr:hover { background: rgba(102, 126, 234, 0.05); transform: scale(1.01); transition: all 0.3s ease; }
        .status-badge { padding: 8px 16px; border-radius: 25px; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .status-normal { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; border: 1px solid #b8dacc; }
        .status-warning { background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); color: #856404; border: 1px solid #f5c842; }
        .status-danger { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); color: #721c24; border: 1px solid #f1aeb5; }
        .status-expired { background: linear-gradient(135deg, #343a40 0%, #495057 100%); color: white; border: 1px solid #6c757d; }
        .content-section { display: none; animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .content-section.active { display: block; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .hide { display: none !important; }
        .debug-panel { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: #2ecc71; padding: 20px; border-radius: 15px; margin-top: 20px; font-family: 'Courier New', monospace; font-size: 0.85rem; max-height: 250px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); }
        .notification { position: fixed; top: 25px; right: 25px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 20px 25px; border-radius: 15px; box-shadow: 0 15px 50px rgba(0,0,0,0.2); z-index: 10000; transform: translateX(400px); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); max-width: 350px; border: 1px solid rgba(255,255,255,0.3); }
        .notification.show { transform: translateX(0); }
        .notification.success { border-left: 6px solid #28a745; }
        .notification.error { border-left: 6px solid #dc3545; }
        .notification.warning { border-left: 6px solid #ffc107; }
        .notification.info { border-left: 6px solid #17a2b8; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 40px; border-radius: 20px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.3); animation: scaleIn 0.3s ease-out; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        .modal h3 { color: #2c3e50; margin-bottom: 25px; font-size: 1.8rem; font-weight: 700; text-align: center; background: linear-gradient(135deg, #2c3e50 0%, #667eea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .modal-buttons { display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px; flex-wrap: wrap; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .alert { padding: 20px 25px; border-radius: 15px; margin-bottom: 25px; border-left: 6px solid; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .alert-success { background: rgba(212, 237, 218, 0.9); border-color: #28a745; color: #155724; }
        .alert-warning { background: rgba(255, 243, 205, 0.9); border-color: #ffc107; color: #856404; }
        .alert-danger { background: rgba(248, 215, 218, 0.9); border-color: #dc3545; color: #721c24; }
        .alert-info { background: rgba(209, 236, 241, 0.9); border-color: #17a2b8; color: #0c5460; }
        @media (max-width: 768px) { .container { padding: 15px; } .header { flex-direction: column; text-align: center; padding: 20px; } .header h1 { font-size: 1.8rem; } .nav-tabs { flex-direction: column; gap: 5px; } .nav-tab { padding: 15px 20px; margin-bottom: 0; } .stats-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; } .department-selector { flex-direction: column; } .quick-actions { justify-content: center; } .table-container { overflow-x: auto; } .table { min-width: 600px; } .table th, .table td { padding: 12px 10px; font-size: 0.9rem; } .form-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">🐄</div>
            <h2 class="login-title">SmartStock อ.ส.ค.</h2>
            <p class="login-subtitle">ระบบจัดการสต๊อกวัตถุดิบอาหารโคนมอัจฉริยะ<br>องค์การส่งเสริมกิจการโคนมแห่งประเทศไทย</p>
            
            <div class="form-group">
                <label>อีเมล</label>
                <input type="email" id="loginEmail" placeholder="example@dairy.co.th" required>
            </div>
            <div class="form-group">
                <label>รหัสผ่าน</label>
                <input type="password" id="loginPassword" placeholder="••••••••" required>
            </div>
            <div class="form-group">
                <button class="btn btn-primary" onclick="doLogin()" style="width: 100%;">
                    🔐 เข้าสู่ระบบ
                </button>
            </div>

            <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%); padding: 15px; border-radius: 10px; margin-top: 20px; border: 1px solid rgba(255,193,7,0.3); text-align: center;">
                <div style="font-size: 0.9rem; color: #e65100; margin-bottom: 5px;">
                    <strong>🔒 ข้อมูลความปลอดภัย</strong>
                </div>
                <div style="color: #bf360c; font-size: 0.8rem; line-height: 1.4;">
                    กรุณาอย่าแบ่งปันข้อมูลการเข้าสู่ระบบให้ผู้อื่น<br>
                    และออกจากระบบทุกครั้งหลังใช้งานเสร็จ
                </div>
            </div>

            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); padding: 20px; border-radius: 15px; margin-top: 25px; border: 1px solid rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 1.2rem; margin-bottom: 10px;">📞 ช่วยเหลือและสนับสนุน</div>
                <div style="color: #555; font-size: 0.95rem; line-height: 1.5;">
                    <strong>หากมีปัญหาในการใช้งาน หรือต้องการปรึกษาเพิ่มเติม</strong><br>
                    กรุณาติดต่อ: <strong style="color: #1976d2;">แผนกวิชาการโคนม</strong><br>
                    <small style="color: #666;">ฝ่ายวิจัยและพัฒนาการเลี้ยงโคนม</small>
                </div>
            </div>
            
            <div style="margin-top: 15px; text-align: center;">
                <button type="button" onclick="showSecretPanel()" style="background: none; border: none; color: #ccc; font-size: 0.7rem; cursor: pointer; opacity: 0.3;">...</button>
            </div>
            
            <div id="debugInfo" class="debug-panel hide">
                <div style="color: #ecf0f1; margin-bottom: 10px; font-weight: bold;">🔧 Debug Console:</div>
                <div id="debugLog"></div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="container hide" id="mainApp">
        <div class="header">
            <div>
                <h1>🚀 SmartStock อ.ส.ค.</h1>
                <p>ระบบจัดการสต๊อกวัตถุดิบอาหารโคนมอัจฉริยะ</p>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <span id="userName">Admin</span>
                <button class="btn btn-danger" onclick="logout()">🚪 ออกจากระบบ</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('dashboard')">📊 ภาพรวม</button>
            <button class="nav-tab" onclick="showSection('inventory')">📦 สต๊อก</button>
            <button class="nav-tab" onclick="showSection('record')">📝 บันทึก</button>
            <button class="nav-tab" onclick="showSection('reports')">📈 รายงาน</button>
            <button class="nav-tab" onclick="showSection('alerts')">🚨 แจ้งเตือน</button>
            <button class="nav-tab" onclick="showSection('management')">⚙️ จัดการรายการ</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card green">
                    <div class="stat-number" id="totalItems">10</div>
                    <div class="stat-label">รายการทั้งหมด</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-number" id="totalValue">0</div>
                    <div class="stat-label">มูลค่ารวม (บาท)</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-number" id="lowStock">0</div>
                    <div class="stat-label">สต๊อกต่ำ</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-number" id="expiringSoon">0</div>
                    <div class="stat-label">ใกล้หมดอายุ</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-number" id="expiredItems">0</div>
                    <div class="stat-label">หมดอายุแล้ว</div>
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="refreshData()">🔄 รีเฟรชข้อมูล</button>
                <button class="btn btn-success" onclick="exportToExcel()">📊 Export Excel</button>
                <button class="btn btn-secondary" onclick="exportData()">📄 Export JSON</button>
                <button class="btn btn-info" onclick="backupData()">💾 สำรองข้อมูล</button>
                <button class="btn btn-warning" onclick="showItemModal()">➕ เพิ่มรายการใหม่</button>
            </div>

            <div class="card">
                <h3>📊 สรุปมูลค่าสต๊อกตามแผนก</h3>
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-number" id="farmValue">0</div>
                        <div class="stat-label">ฟาร์มโคนม (บาท)</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-number" id="breedingValue">0</div>
                        <div class="stat-label">ผลิตน้ำเชื้อ (บาท)</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>🔄 กิจกรรมล่าสุด</h3>
                <div id="recentActivities">
                    <p style="color: #7f8c8d; font-style: italic;">ยังไม่มีกิจกรรม</p>
                </div>
            </div>
        </div>

        <!-- Inventory Section -->
        <div id="inventory" class="content-section">
            <div class="card">
                <h3>🌾 สต๊อกวัตถุดิบแผนกฟาร์มโคนม</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>รายการ</th>
                                <th>คงเหลือ (กก.)</th>
                                <th>ราคา/กก.</th>
                                <th>มูลค่า (บาท)</th>
                                <th>วันหมดอายุ</th>
                                <th>สถานะ</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="farmInventoryTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">กำลังโหลดข้อมูล...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>🐂 สต๊อกอาหารแผนกผลิตน้ำเชื้อ</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>รายการ</th>
                                <th>คงเหลือ (กก.)</th>
                                <th>ราคา/กก.</th>
                                <th>มูลค่า (บาท)</th>
                                <th>วันหมดอายุ</th>
                                <th>สถานะ</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="breedingInventoryTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">กำลังโหลดข้อมูล...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Record Section -->
        <div id="record" class="content-section">
            <div class="department-selector">
                <div class="dept-card selected" onclick="selectDepartment('farm')" id="deptFarm">
                    <div class="dept-icon">🌾</div>
                    <h4>แผนกฟาร์มโคนม</h4>
                    <p>วัตถุดิบผสม TMR</p>
                </div>
                <div class="dept-card" onclick="selectDepartment('breeding')" id="deptBreeding">
                    <div class="dept-icon">🐂</div>
                    <h4>แผนกผลิตน้ำเชื้อ</h4>
                    <p>อาหารข้นโคนม</p>
                </div>
            </div>

            <div class="card">
                <h3 id="recordTitle">📝 บันทึกการรับ-จ่ายวัตถุดิบ</h3>
                <form onsubmit="submitRecord(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>วันที่</label>
                            <input type="date" id="recordDate" required>
                        </div>
                        <div class="form-group">
                            <label>เวลา</label>
                            <input type="time" id="recordTime" required>
                        </div>
                        <div class="form-group">
                            <label>ประเภทรายการ</label>
                            <select id="transactionType" required onchange="toggleFormFields()">
                                <option value="">เลือกประเภท</option>
                                <option value="in">รับเข้า</option>
                                <option value="out">จ่ายออก</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>รายการอาหาร/วัตถุดิบ</label>
                            <select id="itemSelect" required onchange="calculateAutoPrice()">
                                <option value="">เลือกรายการ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>จำนวน (กิโลกรัม)</label>
                            <input type="number" id="quantity" step="0.1" min="0" required onchange="calculateAutoPrice()">
                        </div>
                        <div class="form-group price-input-group">
                            <label>ราคารวม (บาท)</label>
                            <input type="number" id="totalPrice" step="0.01" min="0" placeholder="กรอกราคารวม" onchange="calculatePricePerKg()">
                            <small style="color: #666;">กรอกราคารวมเพื่อคำนวณราคาต่อกิโลกรัมอัตโนมัติ</small>
                        </div>
                        <div class="form-group price-input-group">
                            <label>ราคาต่อกิโลกรัม (บาท)</label>
                            <input type="number" id="unitPrice" step="0.01" min="0" onchange="calculateTotalPrice()">
                            <small style="color: #666;">คำนวณอัตโนมัติจากราคารวม หรือกรอกเองได้</small>
                        </div>
                        <div class="form-group supplier-group">
                            <label>ผู้จำหน่าย/หน่วยงาน</label>
                            <input type="text" id="supplier" required>
                        </div>
                        <div class="form-group">
                            <label>ผู้บันทึก</label>
                            <input type="text" id="recorder" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>หมายเหตุ</label>
                        <textarea id="notes" rows="3" placeholder="ระบุข้อมูลเพิ่มเติม"></textarea>
                    </div>

                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-primary">💾 บันทึกข้อมูล</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">🔄 เคลียร์ฟอร์ม</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports" class="content-section">
            <div class="card">
                <h3>📈 รายงานการใช้งานวัตถุดิบ</h3>
                
                <div class="form-grid" style="margin-bottom: 25px;">
                    <div class="form-group">
                        <label>ช่วงเวลา</label>
                        <select id="reportPeriod">
                            <option value="7">7 วันล่าสุด</option>
                            <option value="14">14 วันล่าสุด</option>
                            <option value="30">30 วันล่าสุด</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>แผนก</label>
                        <select id="reportDepartment">
                            <option value="all">ทุกแผนก</option>
                            <option value="farm">ฟาร์มโคนม</option>
                            <option value="breeding">ผลิตน้ำเชื้อ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="generateUsageReport()">🔍 สร้างรายงาน</button>
                    </div>
                </div>

                <div id="reportResults">
                    <div class="alert alert-info">
                        <strong>ℹ️ คำแนะนำ:</strong> เลือกช่วงเวลาและแผนกที่ต้องการ แล้วกดปุ่ม "สร้างรายงาน" เพื่อดูการวิเคราะห์การใช้งานวัตถุดิบ
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>🚨 การตรวจจับความเคลื่อนไหวผิดปกติ</h3>
                
                <div class="form-grid" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>เกณฑ์การแจ้งเตือน (%)</label>
                        <input type="number" id="anomalyThreshold" value="30" min="10" max="100" placeholder="30">
                        <small style="color: #666;">การเปลี่ยนแปลงมากกว่าเปอร์เซ็นต์นี้จะถือว่าผิดปกติ</small>
                    </div>
                    <div class="form-group">
                        <label>รอบการเปรียบเทียบ</label>
                        <select id="compareInterval">
                            <option value="daily">เปรียบเทียบรายวัน</option>
                            <option value="weekly">เปรียบเทียบรายสัปดาห์</option>
                            <option value="monthly">เปรียบเทียบรายเดือน</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-warning" onclick="detectAnomalies()">🔍 ตรวจจับความผิดปกติ</button>
                    </div>
                </div>

                <div id="anomalyResults">
                    <div class="alert alert-info">
                        <strong>ℹ️ การตรวจจับความผิดปกติ:</strong> 
                        ระบบจะวิเคราะห์รูปแบบการใช้งานวัตถุดิบและแจ้งเตือนเมื่อพบการใช้งานที่เพิ่มขึ้นหรือลดลงอย่างผิดปกติ
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>📊 สถิติการใช้งานโดยรวม</h3>
                <div id="overallStats">
                    <div class="stats-grid">
                        <div class="stat-card blue">
                            <div class="stat-number" id="totalTransactions">0</div>
                            <div class="stat-label">การทำรายการทั้งหมด</div>
                        </div>
                        <div class="stat-card green">
                            <div class="stat-number" id="avgDailyUsage">0</div>
                            <div class="stat-label">การใช้เฉลี่ย/วัน (กก.)</div>
                        </div>
                        <div class="stat-card orange">
                            <div class="stat-number" id="peakUsageDay">-</div>
                            <div class="stat-label">วันที่ใช้มากที่สุด</div>
                        </div>
                        <div class="stat-card purple">
                            <div class="stat-number" id="mostUsedItem">-</div>
                            <div class="stat-label">วัตถุดิบที่ใช้มากที่สุด</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div id="alerts" class="content-section">
            <div class="card">
                <h3>🚨 การแจ้งเตือนสำคัญ</h3>
                <div id="alertsContent">
                    <div class="alert alert-info">
                        <strong>ℹ️ สถานะ:</strong> ระบบพร้อมใช้งาน ข้อมูลถูกอัพเดทแบบ Real-time
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>⚙️ การตั้งค่าการแจ้งเตือน</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>แจ้งเตือนเมื่อสต๊อกต่ำกว่า (%)</label>
                        <input type="number" id="lowStockPercent" value="20" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label>แจ้งเตือนก่อนหมดอายุ (วัน)</label>
                        <input type="number" id="expiryDays" value="7" min="1" max="30">
                    </div>
                    <div class="form-group">
                        <label>แจ้งเตือนผ่าน Email</label>
                        <input type="email" id="alertEmail" placeholder="admin@dairy.co.th">
                    </div>
                </div>
                <button class="btn btn-success" onclick="saveAlertSettings()">💾 บันทึกการตั้งค่า</button>
            </div>
        </div>

        <!-- Management Section -->
        <div id="management" class="content-section">
            <div class="card">
                <h3>⚙️ จัดการรายการอาหาร/วัตถุดิบ</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h4>รายการทั้งหมด</h4>
                        <p style="color: #7f8c8d;">จัดการข้อมูลรายการอาหารและวัตถุดิบ</p>
                    </div>
                    <button class="btn btn-primary" onclick="showItemModal()">➕ เพิ่มรายการใหม่</button>
                </div>

                <div class="form-grid" style="margin-bottom: 25px; background: rgba(255,255,255,0.7); padding: 20px; border-radius: 15px;">
                    <div class="form-group">
                        <label>จัดเรียงตาม</label>
                        <select id="sortBy" onchange="sortManagementTable()">
                            <option value="name">ชื่อรายการ (A-Z)</option>
                            <option value="name_desc">ชื่อรายการ (Z-A)</option>
                            <option value="department">แผนก</option>
                            <option value="stock_desc">สต๊อกมาก → น้อย</option>
                            <option value="stock_asc">สต๊อกน้อย → มาก</option>
                            <option value="price_desc">ราคาสูง → ต่ำ</option>
                            <option value="price_asc">ราคาต่ำ → สูง</option>
                            <option value="expiry_asc">หมดอายุเร็ว → ช้า</option>
                            <option value="expiry_desc">หมดอายุช้า → เร็ว</option>
                            <option value="status">สถานะ (เร่งด่วน → ปกติ)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>กรองตามแผนก</label>
                        <select id="filterDepartment" onchange="sortManagementTable()">
                            <option value="all">ทุกแผนก</option>
                            <option value="farm">ฟาร์มโคนม</option>
                            <option value="breeding">ผลิตน้ำเชื้อ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>กรองตามสถานะ</label>
                        <select id="filterStatus" onchange="sortManagementTable()">
                            <option value="all">ทุกสถานะ</option>
                            <option value="normal">ปกติ</option>
                            <option value="warning">ต้องติดตาม</option>
                            <option value="danger">เร่งด่วน</option>
                            <option value="expired">หมดอายุ</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>รายการ</th>
                                <th>แผนก</th>
                                <th>สต๊อกปัจจุบัน (กก.)</th>
                                <th>ราคา/กก.</th>
                                <th>วันหมดอายุ</th>
                                <th>สถานะ</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="managementTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">กำลังโหลดข้อมูล...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Item Management Modal -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <h3 id="modalTitle">➕ เพิ่มรายการอาหาร/วัตถุดิบใหม่</h3>
            <form id="itemForm" onsubmit="saveItem(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>ชื่อรายการ</label>
                        <input type="text" id="itemName" required placeholder="เช่น ข้าวโพดบด">
                    </div>
                    <div class="form-group">
                        <label>แผนก</label>
                        <select id="itemDepartment" required>
                            <option value="">เลือกแผนก</option>
                            <option value="farm">ฟาร์มโคนม (TMR)</option>
                            <option value="breeding">ผลิตน้ำเชื้อและพิสูจน์พันธุ์</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>จุดสั่งซื้อ (กก.)</label>
                        <input type="number" id="itemReorder" step="0.1" min="0" required placeholder="เช่น 100">
                        <small style="color: #666;">จำนวนที่ต้องสั่งซื้อเมื่อสต๊อกต่ำ</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>บรรจุภัณฑ์</label>
                    <input type="text" id="itemPackaging" placeholder="เช่น ขนาดบรรจุ 30 กิโลกรัมต่อกระสอบ">
                </div>

                <div class="form-group">
                    <label>คุณลักษณะเฉพาะ</label>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>โปรตีน (%)</label>
                            <input type="text" id="itemProtein" placeholder="เช่น ไม่น้อยกว่า 16%">
                        </div>
                        <div class="form-group">
                            <label>ไขมัน (%)</label>
                            <input type="text" id="itemFat" placeholder="เช่น ไม่น้อยกว่า 3%">
                        </div>
                        <div class="form-group">
                            <label>ความชื้น (%)</label>
                            <input type="text" id="itemMoisture" placeholder="เช่น ไม่มากกว่า 13%">
                        </div>
                        <div class="form-group">
                            <label>เยื่อใย (%)</label>
                            <input type="text" id="itemFiber" placeholder="เช่น ไม่มากกว่า 14%">
                        </div>
                        <div class="form-group">
                            <label>กาก/เถ้า (%)</label>
                            <input type="text" id="itemAsh" placeholder="เช่น ไม่มากกว่า 9%">
                        </div>
                        <div class="form-group">
                            <label>อื่นๆ</label>
                            <input type="text" id="itemOther" placeholder="เช่น ยูเรียไม่มากกว่า 2%">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>เงื่อนไขคุณภาพ</label>
                    <textarea id="itemCondition" rows="2" placeholder="เช่น เป็นของใหม่ไม่มีกลิ่น ไม่จับตัวเป็นก้อนแข็ง"></textarea>
                </div>
                
                <div class="form-group">
                    <label>หมายเหตุ</label>
                    <textarea id="itemNotes" rows="3" placeholder="ข้อมูลเพิ่มเติม เช่น ผู้จำหน่าย, คุณสมบัติพิเศษ"></textarea>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeItemModal()">❌ ยกเลิก</button>
                    <button type="submit" class="btn btn-primary" id="saveItemBtn">💾 บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Item Details Modal -->
    <div class="modal" id="itemDetailsModal">
        <div class="modal-content">
            <h3 id="detailsModalTitle">📋 รายละเอียดวัตถุดิบ</h3>
            <div id="itemDetailsContent"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeItemDetailsModal()">❌ ปิด</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <script>
        // Global Variables
        let currentUser = null;
        let currentDepartment = 'farm';
        let editingItemId = null;
        let secretClickCount = 0;

        // Login Data
        const users = {
            'admin@dairy.co.th': { name: 'ผู้ดูแลระบบ', password: 'admin123', role: 'admin', department: 'all' },
            'farm@dairy.co.th': { name: 'แผนกฟาร์มโคนม', password: 'farm123', role: 'farm', department: 'farm' },
            'breeding@dairy.co.th': { name: 'แผนกผลิตน้ำเชื้อและพิสูจน์พันธุ์', password: 'breed123', role: 'breeding', department: 'breeding' }
        };

        // Demo Data
        const demoData = {
            items: {
                farm: {
                    'F001': { name: 'อาหารลูกโค CP 973', stock: 840, pricePerKg: 19.00, reorderPoint: 500, expiryDate: '2026-12-31', lastModified: new Date().toISOString(), notes: 'อาหารลูกโค คุณภาพสูง', specifications: { packaging: 'ถุงละ 10 กิโลกรัม', fat: 'ไขมันไม่น้อยกว่า 3%', ash: 'กากไม่มากกว่า 9%', moisture: 'ความชื้นไม่มากกว่า 13%', protein: 'โปรตีนไม่น้อยกว่า 20%', condition: 'เป็นของใหม่ไม่มีกลิ่น' }, batches: [{ quantity: 840, unitPrice: 19.00, expiryDate: '2026-12-31', dateReceived: '2025-07-01T00:00:00.000Z', batchId: '1719792000000' }] },
                    'F002': { name: 'อาหารข้น 16%', stock: 9900, pricePerKg: 10.11, reorderPoint: 1000, expiryDate: '2026-06-30', lastModified: new Date().toISOString(), notes: 'อาหารข้นโปรตีน 16%', specifications: { packaging: 'ขนาดบรรจุ 30 กิโลกรัมต่อกระสอบ', protein: 'โปรตีนรวมไม่น้อยกว่าร้อยละ 16', fat: 'ไขมันรวมไม่น้อยกว่าร้อยละ 3', fiber: 'เยื่อใยรวมไม่มากกว่าร้อยละ 14', moisture: 'ความชื้นไม่มากกว่าร้อยละ 13', other: 'ยูเรียไม่มากกว่าร้อยละ 2' }, batches: [{ quantity: 9900, unitPrice: 10.11, expiryDate: '2026-06-30', dateReceived: '2025-07-01T00:00:00.000Z', batchId: '1719792000001' }] },
                    'F003': { name: 'อาหารข้น 20% (ผสม TMR)', stock: 21510, pricePerKg: 11.675, reorderPoint: 800, expiryDate: '2026-06-30', lastModified: new Date().toISOString(), notes: 'อาหารข้นโปรตีน 20% สำหรับผสม TMR', specifications: { packaging: 'ขนาดบรรจุ 30 กิโลกรัมต่อกระสอบ', protein: 'โปรตีนรวมไม่น้อยกว่าร้อยละ 20', fat: 'ไขมันรวมไม่น้อยกว่าร้อยละ 3', fiber: 'เยื่อใยรวมไม่มากกว่าร้อยละ 14', moisture: 'ความชื้นไม่มากกว่าร้อยละ 13' }, batches: [{ quantity: 21510, unitPrice: 11.675, expiryDate: '2026-06-30', dateReceived: '2025-07-01T00:00:00.000Z', batchId: '1719792000002' }] },
                    'F004': { name: 'กากถั่วเหลือง', stock: 4600, pricePerKg: 18.00, reorderPoint: 1000, expiryDate: '2025-12-31', lastModified: new Date().toISOString(), notes: 'กากถั่วเหลือง คุณภาพดี', specifications: { packaging: 'ขนาดบรรจุ 50 กิโลกรัมต่อกระสอบ', condition: 'ไม่จับตัวเป็นก้อนแข็ง มีสีสม่ำเสมอ ไม่มีกลิ่นผิดปกติ', moisture: 'ความชื้นน้อยกว่าหรือเท่ากับ 12.5%', protein: 'มีโปรตีนมากกว่าหรือเท่ากับ 45%', ash: 'มีกากน้อยกว่าหรือเท่ากับ 4.5%', fat: 'ไขมันน้อยกว่าหรือเท่ากับ 2.5%' }, batches: [{ quantity: 4600, unitPrice: 18.00, expiryDate: '2025-12-31', dateReceived: '2025-07-01T00:00:00.000Z', batchId: '1719792000003' }] },
                    'F005': { name: 'มันเส้น', stock: 25560, pricePerKg: 8.56, reorderPoint: 2000, expiryDate: '2025-12-31', lastModified: new Date().toISOString(), notes: 'มันเส้น แห้งดี', specifications: { packaging: 'ขนาดบรรจุ 60 กิโลกรัมต่อกระสอบ', moisture: 'ความชื้นไม่เกิน 10%', fiber: 'เยื่อใยไม่เกิน 3.70%', protein: 'มีโปรตีนไม่ต่ำกว่า 2.5%', ash: 'เถ้าไม่เกิน 3.70%', condition: 'ไม่มีสิ่งปลอมปน ผ่านการผึ่งแดดมาแล้ว 3-4 แดด' }, batches: [{ quantity: 25560, unitPrice: 8.56, expiryDate: '2025-12-31', dateReceived: '2025-07-01T00:00:00.000Z', batchId: '1719792000004' }] },
                    'F006': { name: 'MC Miner', stock: 475, pricePerKg: 350.00, reorderPoint: 200, expiryDate: '2027-12-31', lastModified: new Date().toISOString(), notes: 'แร่ธาตุผสม MC Miner', specifications: { packaging: 'ขนาดบรรจุ 25 กิโลกรัมต่อกระสอบ' }, batches: [{ quantity: 475, unitPrice: 350.00, expiryDate: '2027-12-31', dateReceived: '2025-07-01T00:00:00.000Z', batchId: '1719792000005' }] },
                    'F007': { name: 'ไขมันผง', stock: 1100, pricePerKg: 55.00, reorderPoint: 100, expiryDate: '2026-03-31', lastModified: new Date().toISOString(), notes: 'ไขมันผง คุณภาพสูง', specifications: { packaging: 'บรรจุกระสอบละ 25 กิโลกรัม', fat: 'ไขมันไม่น้อยกว่า 84%', ash: 'เถ้าไม่น้อยกว่า 16%', moisture: 'ต้องมีความชื้นไม่มากกว่า 5%', other: 'แคลเซียมไม่น้อยกว่า 9%' }, batches: [{ quantity: 1100, unitPrice: 55.00, expiryDate: '2026-03-31', dateReceived: '2025-07-01T00:00:00.000Z', batchId: '1719792000006' }] },
                    'F008': { name: 'แร่ธาตุ', stock: 425, pricePerKg: 9.42, reorderPoint: 200, expiryDate: '2027-12-31', lastModified: new Date().toISOString(), notes: 'แร่ธาตุผสม', specifications: { packaging: 'บรรจุกระสอบละ 25 กิโลกรัม' }, batches: [{ quantity: 425, unitPrice: 9.42, expiryDate: '2027-12-31', dateReceived: '2025-07-01T00:00:00.000Z', batchId: '1719792000007' }] },
                    'F009': { name: 'พรีมิกซ์', stock: 640, pricePerKg: 47.88, reorderPoint: 50, expiryDate: '2026-12-31', lastModified: new Date().toISOString(), notes: 'วิตามินและแร่ธาตุผสม', specifications: { packaging: 'บรรจุกระสอบละ 10 กิโลกรัม' }, batches: [{ quantity: 640, unitPrice: 47.88, expiryDate: '2026-12-31', dateReceived: '2025-07-01T00:00:00.000Z', batchId: '1719792000008' }] },
                    'F010': { name: 'อาหารข้น 20% (คอกลูกโค)', stock: 0, pricePerKg: 11.675, reorderPoint: 500, expiryDate: '2026-06-30', lastModified: new Date().toISOString(), notes: 'อาหารข้นโปรตีน 20% สำหรับคอกลูกโค', specifications: { packaging: 'ขนาดบรรจุ 30 กิโลกรัมต่อกระสอบ', protein: 'โปรตีนรวมไม่น้อยกว่าร้อยละ 20', fat: 'ไขมันรวมไม่น้อยกว่าร้อยละ 3', fiber: 'เยื่อใยรวมไม่มากกว่าร้อยละ 14', moisture: 'ความชื้นไม่มากกว่าร้อยละ 13' }, batches: [] }
                },
                breeding: {
                    'B001': { name: 'อาหารข้น 16%', stock: 7170, pricePerKg: 14.17, reorderPoint: 500, expiryDate: '2026-06-30', lastModified: new Date().toISOString(), notes: 'อาหารข้นสำหรับโคพันธุ์', specifications: { packaging: 'ขนาดบรรจุ 30 กิโลกรัมต่อกระสอบ', protein: 'โปรตีนรวมไม่น้อยกว่าร้อยละ 16', fat: 'ไขมันรวมไม่น้อยกว่าร้อยละ 3', fiber: 'เยื่อใยรวมไม่มากกว่าร้อยละ 14', moisture: 'ความชื้นไม่มากกว่าร้อยละ 13', other: 'ยูเรียไม่มากกว่าร้อยละ 2' }, batches: [{ quantity: 7170, unitPrice: 14.17, expiryDate: '2026-06-30', dateReceived: '2025-07-01T00:00:00.000Z', batchId: '1719792000009' }] },
                    'B002': { name: 'แร่ธาตุ', stock: 50, pricePerKg: 10.90, reorderPoint: 100, expiryDate: '2027-12-31', lastModified: new Date().toISOString(), notes: 'แร่ธาตุสำหรับโคพันธุ์', specifications: { packaging: 'บรรจุกระสอบละ 50 กิโลกรัม' }, batches: [{ quantity: 50, unitPrice: 10.90, expiryDate: '2027-12-31', dateReceived: '2025-07-01T00:00:00.000Z', batchId: '1719792000010' }] },
                    'B003': { name: 'พรีมิกซ์', stock: 210, pricePerKg: 95.76, reorderPoint: 25, expiryDate: '2026-12-31', lastModified: new Date().toISOString(), notes: 'วิตามินและแร่ธาตุสำหรับโคพันธุ์', specifications: { packaging: 'บรรจุกระสอบละ 10 กิโลกรัม' }, batches: [{ quantity: 210, unitPrice: 95.76, expiryDate: '2026-12-31', dateReceived: '2025-07-01T00:00:00.000Z', batchId: '1719792000011' }] }
                }
            },
            transactions: [],
            usageHistory: [],
            settings: { lowStockPercent: 20, expiryDays: 7, alertEmail: 'admin@dairy.co.th', anomalyThreshold: 30 }
        };

        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type} show`;
            notification.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center;"><span><strong>${message}</strong></span><button onclick="hideNotification()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">×</button></div>`;
            setTimeout(() => hideNotification(), 5000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        function logMessage(message) {
            const debugLog = document.getElementById('debugLog');
            if (debugLog) {
                const time = new Date().toLocaleTimeString();
                debugLog.innerHTML += `[${time}] ${message}<br>`;
                debugLog.scrollTop = debugLog.scrollHeight;
            }
            console.log(message);
        }

        function calculateDaysDifference(dateString) {
            const targetDate = new Date(dateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            targetDate.setHours(0, 0, 0, 0);
            const diffTime = targetDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function getExpiryStatus(expiryDate, expiryDays = 7) {
            const daysUntilExpiry = calculateDaysDifference(expiryDate);
            if (daysUntilExpiry < 0) {
                return { status: 'expired', statusClass: 'status-expired', message: 'หมดอายุแล้ว' };
            } else if (daysUntilExpiry <= expiryDays) {
                return { status: 'expiring', statusClass: 'status-danger', message: `เหลือ ${daysUntilExpiry} วัน` };
            } else if (daysUntilExpiry <= expiryDays * 2) {
                return { status: 'warning', statusClass: 'status-warning', message: `เหลือ ${daysUntilExpiry} วัน` };
            } else {
                return { status: 'normal', statusClass: 'status-normal', message: `เหลือ ${daysUntilExpiry} วัน` };
            }
        }

        function calculatePackageUnits(stock, packaging) {
            if (!packaging || stock <= 0) return '';
            const numbers = packaging.match(/(\d+(?:\.\d+)?)/g);
            if (!numbers || numbers.length === 0) return '';
            const packageSize = parseFloat(numbers[0]);
            if (packageSize <= 0) return '';
            const units = Math.floor(stock / packageSize);
            const remainder = stock % packageSize;
            let unitType = 'ห่อ';
            if (packaging.includes('กระสอบ')) unitType = 'กระสอบ';
            else if (packaging.includes('ถุง')) unitType = 'ถุง';
            else if (packaging.includes('กล่อง')) unitType = 'กล่อง';
            if (units > 0 && remainder > 0) {
                return `(${units} ${unitType} + ${remainder.toFixed(1)} กก.)`;
            } else if (units > 0) {
                return `(${units} ${unitType})`;
            } else {
                return `(${remainder.toFixed(1)} กก.)`;
            }
        }

        // Permission Functions
        function hasPermission(department) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true;
            return currentUser.department === department;
        }

        function canAccessAllDepartments() {
            return currentUser && currentUser.role === 'admin';
        }

        function getUserDepartments() {
            if (!currentUser) return [];
            if (currentUser.role === 'admin') return ['farm', 'breeding'];
            return [currentUser.department];
        }

        function filterDataByPermission(data) {
            if (canAccessAllDepartments()) return data;
            const userDepts = getUserDepartments();
            const filteredData = {};
            userDepts.forEach(dept => {
                if (data[dept]) {
                    filteredData[dept] = data[dept];
                }
            });
            return filteredData;
        }

        // Login Functions
        function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showNotification('กรุณากรอกอีเมลและรหัสผ่าน', 'error');
                return;
            }
            
            if (!email.includes('@') || !email.includes('.')) {
                showNotification('รูปแบบอีเมลไม่ถูกต้อง', 'error');
                return;
            }
            
            const user = users[email];
            if (user && user.password === password) {
                currentUser = {
                    name: user.name,
                    email: email,
                    role: user.role,
                    department: user.department,
                    lastLogin: new Date().toISOString()
                };
                
                const sessionData = {
                    name: user.name,
                    email: email,
                    role: user.role,
                    department: user.department,
                    loginTime: new Date().toISOString()
                };
                
                localStorage.setItem('currentUser', JSON.stringify(sessionData));
                localStorage.setItem('dairyStockData', JSON.stringify(demoData));
                showNotification('เข้าสู่ระบบสำเร็จ!', 'success');
                
                document.getElementById('loginPassword').value = '';
                showMainApp();
            } else {
                showNotification('อีเมลหรือรหัสผ่านไม่ถูกต้อง', 'error');
                document.getElementById('loginPassword').value = '';
            }
        }

        function showSecretPanel() {
            secretClickCount++;
            if (secretClickCount >= 5) {
                toggleDebugMode();
                secretClickCount = 0;
            }
            setTimeout(() => {
                if (secretClickCount > 0) secretClickCount--;
            }, 1000);
        }

        function toggleDebugMode() {
            const debugPanel = document.getElementById('debugInfo');
            if (debugPanel) {
                debugPanel.classList.toggle('hide');
                if (!debugPanel.classList.contains('hide')) {
                    logMessage('🔧 Debug mode activated');
                    logMessage('📱 Current user: ' + (currentUser ? currentUser.name + ' (' + currentUser.role + ')' : 'None'));
                    logMessage('💾 Data status: ' + (localStorage.getItem('dairyStockData') ? 'Available' : 'Not available'));
                    logMessage('📦 Total items: ' + (Object.keys(demoData.items.farm).length + Object.keys(demoData.items.breeding).length));
                    logMessage('🕐 Session time: ' + (currentUser ? new Date(currentUser.lastLogin).toLocaleString('th-TH') : 'N/A'));
                }
            }
        }

        function showDebug() {
            toggleDebugMode();
        }

        function logout() {
            if (confirm('คุณต้องการออกจากระบบใช่หรือไม่?')) {
                localStorage.removeItem('currentUser');
                sessionStorage.clear();
                currentUser = null;
                secretClickCount = 0;
                const debugPanel = document.getElementById('debugInfo');
                if (debugPanel) {
                    debugPanel.classList.add('hide');
                }
                showLoginScreen();
                showNotification('ออกจากระบบเรียบร้อย', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        }

        // App Functions
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.add('hide');
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hide');
            
            if (currentUser) {
                document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('recorder').value = currentUser.name;
                setupNavigationByRole();
                if (currentUser.role === 'farm') {
                    currentDepartment = 'farm';
                    selectDepartment('farm');
                } else if (currentUser.role === 'breeding') {
                    currentDepartment = 'breeding';
                    selectDepartment('breeding');
                }
            }
            
            setupCurrentDateTime();
            updateStats();
            updateInventoryTables();
            updateItemSelect();
            updateManagementTable();
            generateAlerts();
            loadAlertSettings();
            updateOverallStats();
            toggleFormFields();
        }

        function setupNavigationByRole() {
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.style.display = 'block');
        }

        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');

            if (sectionName === 'inventory') {
                updateInventoryTables();
            } else if (sectionName === 'management') {
                updateManagementTable();
            } else if (sectionName === 'alerts') {
                generateAlerts();
            } else if (sectionName === 'reports') {
                updateOverallStats();
                setupReportsAccess();
            }
        }

        function setupReportsAccess() {
            const reportDeptSelect = document.getElementById('reportDepartment');
            if (reportDeptSelect) {
                reportDeptSelect.innerHTML = '';
                if (currentUser.role === 'admin') {
                    reportDeptSelect.innerHTML = `
                        <option value="all">ทุกแผนก</option>
                        <option value="farm">ฟาร์มโคนม</option>
                        <option value="breeding">ผลิตน้ำเชื้อ</option>
                    `;
                } else if (currentUser.role === 'farm') {
                    reportDeptSelect.innerHTML = '<option value="farm">ฟาร์มโคนม</option>';
                } else if (currentUser.role === 'breeding') {
                    reportDeptSelect.innerHTML = '<option value="breeding">ผลิตน้ำเชื้อ</option>';
                }
            }
        }

        function selectDepartment(dept) {
            currentDepartment = dept;
            document.getElementById('deptFarm').classList.toggle('selected', dept === 'farm');
            document.getElementById('deptBreeding').classList.toggle('selected', dept === 'breeding');
            const title = dept === 'farm' ? '📝 บันทึกการรับ-จ่ายวัตถุดิบ TMR' : '📝 บันทึกการรับ-จ่ายอาหารข้น';
            document.getElementById('recordTitle').textContent = title;
            updateItemSelect();
        }

        function setupCurrentDateTime() {
            const now = new Date();
            document.getElementById('recordDate').value = now.toISOString().split('T')[0];
            document.getElementById('recordTime').value = now.toTimeString().slice(0, 5);
        }

        function updateItemSelect() {
            const select = document.getElementById('itemSelect');
            const items = demoData.items[currentDepartment];
            select.innerHTML = '<option value="">เลือกรายการ</option>';
            Object.entries(items).forEach(([code, item]) => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = item.name;
                option.dataset.pricePerKg = item.pricePerKg;
                select.appendChild(option);
            });
        }

        function updateStats() {
            const filteredItems = filterDataByPermission(demoData.items);
            const allItems = {};
            Object.values(filteredItems).forEach(deptItems => {
                Object.assign(allItems, deptItems);
            });
            const totalItems = Object.keys(allItems).length;
            let totalValue = 0;
            let farmValue = 0;
            let breedingValue = 0;
            let lowStock = 0;
            let expiringSoon = 0;
            let expiredItems = 0;
            
            if (hasPermission('farm') && demoData.items.farm) {
                Object.values(demoData.items.farm).forEach(item => {
                    const value = item.stock * item.pricePerKg;
                    farmValue += value;
                    totalValue += value;
                    const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                    if (item.stock <= lowStockThreshold) {
                        lowStock++;
                    }
                    const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                    if (expiryStatus.status === 'expired') {
                        expiredItems++;
                    } else if (expiryStatus.status === 'expiring') {
                        expiringSoon++;
                    }
                });
            }
            
            if (hasPermission('breeding') && demoData.items.breeding) {
                Object.values(demoData.items.breeding).forEach(item => {
                    const value = item.stock * item.pricePerKg;
                    breedingValue += value;
                    totalValue += value;
                    const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                    if (item.stock <= lowStockThreshold) {
                        lowStock++;
                    }
                    const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                    if (expiryStatus.status === 'expired') {
                        expiredItems++;
                    } else if (expiryStatus.status === 'expiring') {
                        expiringSoon++;
                    }
                });
            }
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalValue').textContent = totalValue.toLocaleString('th-TH', { maximumFractionDigits: 0 });
            
            const farmValueCard = document.getElementById('farmValue').closest('.stat-card');
            const breedingValueCard = document.getElementById('breedingValue').closest('.stat-card');
            
            if (hasPermission('farm')) {
                document.getElementById('farmValue').textContent = farmValue.toLocaleString('th-TH', { maximumFractionDigits: 0 });
                farmValueCard.style.display = 'block';
            } else {
                farmValueCard.style.display = 'none';
            }
            
            if (hasPermission('breeding')) {
                document.getElementById('breedingValue').textContent = breedingValue.toLocaleString('th-TH', { maximumFractionDigits: 0 });
                breedingValueCard.style.display = 'block';
            } else {
                breedingValueCard.style.display = 'none';
            }
            
            document.getElementById('lowStock').textContent = lowStock;
            document.getElementById('expiringSoon').textContent = expiringSoon;
            document.getElementById('expiredItems').textContent = expiredItems;
        }

        function updateInventoryTables() {
            const farmSection = document.querySelector('#inventory .card:first-child');
            const breedingSection = document.querySelector('#inventory .card:last-child');
            
            if (hasPermission('farm')) {
                farmSection.style.display = 'block';
                updateInventoryTable('farm', 'farmInventoryTable');
            } else {
                farmSection.style.display = 'none';
            }
            
            if (hasPermission('breeding')) {
                breedingSection.style.display = 'block';
                updateInventoryTable('breeding', 'breedingInventoryTable');
            } else {
                breedingSection.style.display = 'none';
            }
        }

        function updateInventoryTable(department, tableId) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';
            const items = demoData.items[department] || {};
            
            if (Object.keys(items).length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #7f8c8d; font-style: italic;">ยังไม่มีรายการวัตถุดิบ<br><small>กดปุ่ม "เพิ่มรายการใหม่" เพื่อเริ่มต้น</small></td></tr>';
                return;
            }
            
            Object.entries(items).forEach(([code, item]) => {
                const row = document.createElement('tr');
                const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                let stockStatus, stockStatusClass;
                
                if (item.stock === 0) {
                    stockStatus = 'หมด';
                    stockStatusClass = 'status-danger';
                } else if (item.stock <= lowStockThreshold) {
                    stockStatus = 'ต่ำ';
                    stockStatusClass = 'status-warning';
                } else {
                    stockStatus = 'ปกติ';
                    stockStatusClass = 'status-normal';
                }

                const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                let finalStatus, finalStatusClass;
                if (expiryStatus.status === 'expired') {
                    finalStatus = 'หมดอายุ';
                    finalStatusClass = 'status-expired';
                } else if (expiryStatus.status === 'expiring') {
                    finalStatus = `หมดอายุ ${expiryStatus.message}`;
                    finalStatusClass = 'status-danger';
                } else if (stockStatus === 'หมด') {
                    finalStatus = stockStatus;
                    finalStatusClass = stockStatusClass;
                } else if (stockStatus === 'ต่ำ') {
                    finalStatus = `สต๊อกต่ำ`;
                    finalStatusClass = stockStatusClass;
                } else {
                    finalStatus = 'ปกติ';
                    finalStatusClass = 'status-normal';
                }
                
                const currentPrice = getAveragePrice(code, department);
                const totalValue = item.stock * currentPrice;
                const expiryDate = new Date(item.expiryDate).toLocaleDateString('th-TH');
                const specs = item.specifications || {};
                const packaging = specs.packaging ? `<br><small style="color: #666;">📦 ${specs.packaging}</small>` : '';
                const protein = specs.protein ? `<br><small style="color: #666;">🥩 ${specs.protein}</small>` : '';
                const packageUnits = calculatePackageUnits(item.stock, specs.packaging);
                const stockDisplay = packageUnits ? 
                    `<strong>${item.stock.toLocaleString()}</strong><br><small style="color: #999; font-size: 0.8rem;">${packageUnits}</small>` : 
                    `<strong>${item.stock.toLocaleString()}</strong>`;
                
                row.innerHTML = `
                    <td>
                        <strong>${item.name}</strong><br>
                        <small style="color: #666;">${code}</small>
                        ${packaging}${protein}
                    </td>
                    <td>${stockDisplay}</td>
                    <td>${currentPrice.toFixed(2)}<br><small style="color: #666;">FIFO</small></td>
                    <td><strong style="color: #27ae60;">${totalValue.toLocaleString('th-TH', { maximumFractionDigits: 0 })}</strong></td>
                    <td>${expiryDate}</td>
                    <td><span class="status-badge ${finalStatusClass}">${finalStatus}</span></td>
                    <td style="text-align: center; white-space: nowrap;">
                        <div style="display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-info btn-sm" onclick="showItemDetails('${code}', '${department}')" title="ดูรายละเอียด">
                                ℹ️ รายละเอียด
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="editItem('${code}', '${department}')" title="แก้ไขรายการ">
                                ✏️ แก้ไข
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteItem('${code}', '${department}')" title="ลบรายการ">
                                🗑️ ลบ
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function getAveragePrice(itemCode, department) {
            const item = demoData.items[department][itemCode];
            if (!item.batches || item.batches.length === 0) return item.pricePerKg;
            let totalValue = 0;
            let totalQuantity = 0;
            item.batches.forEach(batch => {
                totalValue += batch.quantity * batch.unitPrice;
                totalQuantity += batch.quantity;
            });
            return totalQuantity > 0 ? totalValue / totalQuantity : item.pricePerKg;
        }

        function generateAlerts() {
            const container = document.getElementById('alertsContent');
            const filteredItems = filterDataByPermission(demoData.items);
            const allItems = {};
            Object.values(filteredItems).forEach(deptItems => {
                Object.assign(allItems, deptItems);
            });
            let alerts = [];
            
            Object.entries(allItems).forEach(([code, item]) => {
                const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                if (expiryStatus.status === 'expired') {
                    alerts.push({
                        type: 'danger',
                        message: `${item.name} - หมดอายุแล้ว (${new Date(item.expiryDate).toLocaleDateString('th-TH')})`
                    });
                } else if (expiryStatus.status === 'expiring') {
                    alerts.push({
                        type: 'warning',
                        message: `${item.name} - ใกล้หมดอายุ ${expiryStatus.message} (${new Date(item.expiryDate).toLocaleDateString('th-TH')})`
                    });
                }
                const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                if (item.stock === 0) {
                    alerts.push({
                        type: 'danger',
                        message: `${item.name} - สต๊อกหมด (ต้องสั่งซื้อทันที)`
                    });
                } else if (item.stock <= lowStockThreshold) {
                    alerts.push({
                        type: 'warning',
                        message: `${item.name} - สต๊อกต่ำ เหลือ ${item.stock.toLocaleString()} กก.`
                    });
                }
            });
            
            if (alerts.length === 0) {
                container.innerHTML = '<div class="alert alert-success"><strong>✅ ทุกอย่างปกติ:</strong> ไม่มีการแจ้งเตือนในขณะนี้</div>';
                return;
            }
            
            const groupedAlerts = alerts.reduce((acc, alert) => {
                if (!acc[alert.type]) acc[alert.type] = [];
                acc[alert.type].push(alert.message);
                return acc;
            }, {});
            
            let alertsHTML = '';
            if (groupedAlerts.danger) {
                alertsHTML += `
                    <div class="alert alert-danger">
                        <strong>🚨 เร่งด่วน:</strong>
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            ${groupedAlerts.danger.map(msg => `<li>${msg}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            if (groupedAlerts.warning) {
                alertsHTML += `
                    <div class="alert alert-warning">
                        <strong>⚠️ ต้องติดตาม:</strong>
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            ${groupedAlerts.warning.map(msg => `<li>${msg}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            container.innerHTML = alertsHTML;
        }

        function updateManagementTable() {
            const filterDeptSelect = document.getElementById('filterDepartment');
            if (filterDeptSelect) {
                filterDeptSelect.innerHTML = '<option value="all">ทุกแผนก</option>';
                if (hasPermission('farm')) {
                    filterDeptSelect.innerHTML += '<option value="farm">ฟาร์มโคนม</option>';
                }
                if (hasPermission('breeding')) {
                    filterDeptSelect.innerHTML += '<option value="breeding">ผลิตน้ำเชื้อ</option>';
                }
            }
            sortManagementTable();
        }

        function sortManagementTable() {
            const sortBy = document.getElementById('sortBy').value;
            const filterDept = document.getElementById('filterDepartment').value;
            const filterStatus = document.getElementById('filterStatus').value;
            let allItems = [];
            
            if (hasPermission('farm') && demoData.items.farm) {
                Object.entries(demoData.items.farm).forEach(([code, item]) => {
                    allItems.push({ ...item, code, department: 'farm', departmentName: 'ฟาร์มโคนม' });
                });
            }
            if (hasPermission('breeding') && demoData.items.breeding) {
                Object.entries(demoData.items.breeding).forEach(([code, item]) => {
                    allItems.push({ ...item, code, department: 'breeding', departmentName: 'ผลิตน้ำเชื้อฯ' });
                });
            }
            
            if (filterDept !== 'all') {
                allItems = allItems.filter(item => item.department === filterDept);
            }
            if (filterStatus !== 'all') {
                allItems = allItems.filter(item => {
                    const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                    const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                    let status = 'normal';
                    if (expiryStatus.status === 'expired') {
                        status = 'expired';
                    } else if (expiryStatus.status === 'expiring' || item.stock === 0) {
                        status = 'danger';
                    } else if (expiryStatus.status === 'warning' || item.stock <= lowStockThreshold) {
                        status = 'warning';
                    }
                    return status === filterStatus;
                });
            }
            
            allItems.sort((a, b) => {
                switch (sortBy) {
                    case 'name': return a.name.localeCompare(b.name, 'th');
                    case 'name_desc': return b.name.localeCompare(a.name, 'th');
                    case 'department': return a.departmentName.localeCompare(b.departmentName, 'th');
                    case 'stock_desc': return b.stock - a.stock;
                    case 'stock_asc': return a.stock - b.stock;
                    case 'price_desc': return getAveragePrice(b.code, b.department) - getAveragePrice(a.code, a.department);
                    case 'price_asc': return getAveragePrice(a.code, a.department) - getAveragePrice(b.code, b.department);
                    case 'expiry_asc': return new Date(a.expiryDate) - new Date(b.expiryDate);
                    case 'expiry_desc': return new Date(b.expiryDate) - new Date(a.expiryDate);
                    case 'status':
                        const getStatusPriority = (item) => {
                            const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                            const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                            if (expiryStatus.status === 'expired') return 1;
                            if (expiryStatus.status === 'expiring' || item.stock === 0) return 2;
                            if (expiryStatus.status === 'warning' || item.stock <= lowStockThreshold) return 3;
                            return 4;
                        };
                        return getStatusPriority(a) - getStatusPriority(b);
                    default: return 0;
                }
            });
            
            const tbody = document.getElementById('managementTable');
            tbody.innerHTML = '';
            if (allItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">ไม่พบข้อมูลที่ตรงกับเงื่อนไข</td></tr>';
                return;
            }
            
            allItems.forEach(item => {
                const row = document.createElement('tr');
                const lowStockThreshold = item.reorderPoint * (demoData.settings.lowStockPercent / 100);
                const expiryStatus = getExpiryStatus(item.expiryDate, demoData.settings.expiryDays);
                let finalStatus, finalStatusClass;
                if (expiryStatus.status === 'expired') {
                    finalStatus = 'หมดอายุ';
                    finalStatusClass = 'status-expired';
                } else if (expiryStatus.status === 'expiring') {
                    finalStatus = `หมดอายุ ${expiryStatus.message}`;
                    finalStatusClass = 'status-danger';
                } else if (item.stock === 0) {
                    finalStatus = 'สต๊อกหมด';
                    finalStatusClass = 'status-danger';
                } else if (item.stock <= lowStockThreshold) {
                    finalStatus = 'สต๊อกต่ำ';
                    finalStatusClass = 'status-warning';
                } else {
                    finalStatus = 'ปกติ';
                    finalStatusClass = 'status-normal';
                }
                
                const currentPrice = getAveragePrice(item.code, item.department);
                const expiryDate = new Date(item.expiryDate).toLocaleDateString('th-TH');
                const specs = item.specifications || {};
                const packageUnits = calculatePackageUnits(item.stock, specs.packaging);
                const stockDisplay = packageUnits ? 
                    `${item.stock.toLocaleString()}<br><small style="color: #999; font-size: 0.8rem;">${packageUnits}</small>` : 
                    item.stock.toLocaleString();
                
                row.innerHTML = `
                    <td><strong>${item.name}</strong><br><small style="color: #666;">${item.code}</small></td>
                    <td>${item.departmentName}</td>
                    <td>${stockDisplay}</td>
                    <td>${currentPrice.toFixed(2)}</td>
                    <td>${expiryDate}</td>
                    <td><span class="status-badge ${finalStatusClass}">${finalStatus}</span></td>
                    <td style="text-align: center; white-space: nowrap;">
                        <div style="display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-info btn-sm" onclick="showItemDetails('${item.code}', '${item.department}')" title="ดูรายละเอียด">
                                ℹ️ รายละเอียด
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="editItem('${item.code}', '${item.department}')" title="แก้ไขรายการ">
                                ✏️ แก้ไข
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteItem('${item.code}', '${item.department}')" title="ลบรายการ">
                                🗑️ ลบ
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Item Management Functions
        function showItemModal() {
            const userDepts = getUserDepartments();
            if (userDepts.length === 0) {
                showNotification('คุณไม่มีสิทธิ์เพิ่มรายการใหม่', 'error');
                return;
            }
            editingItemId = null;
            document.getElementById('modalTitle').textContent = '➕ เพิ่มรายการอาหาร/วัตถุดิบใหม่';
            document.getElementById('saveItemBtn').textContent = '💾 บันทึก';
            document.getElementById('itemForm').reset();
            const deptSelect = document.getElementById('itemDepartment');
            deptSelect.innerHTML = '<option value="">เลือกแผนก</option>';
            if (currentUser.role === 'admin') {
                deptSelect.innerHTML += '<option value="farm">ฟาร์มโคนม (TMR)</option>';
                deptSelect.innerHTML += '<option value="breeding">ผลิตน้ำเชื้อและพิสูจน์พันธุ์</option>';
            } else {
                if (currentUser.role === 'farm') {
                    deptSelect.innerHTML += '<option value="farm">ฟาร์มโคนม (TMR)</option>';
                    deptSelect.value = 'farm';
                    deptSelect.disabled = true;
                } else if (currentUser.role === 'breeding') {
                    deptSelect.innerHTML += '<option value="breeding">ผลิตน้ำเชื้อและพิสูจน์พันธุ์</option>';
                    deptSelect.value = 'breeding';
                    deptSelect.disabled = true;
                }
            }
            document.getElementById('itemModal').classList.add('show');
        }

        function closeItemModal() {
            document.getElementById('itemModal').classList.remove('show');
            document.getElementById('itemDepartment').disabled = false;
            document.getElementById('itemForm').reset();
            ['itemPackaging', 'itemProtein', 'itemFat', 'itemMoisture', 'itemFiber', 'itemAsh', 'itemOther', 'itemCondition'].forEach(id => {
                document.getElementById(id).value = '';
            });
            editingItemId = null;
        }

        function editItem(code, department) {
            if (!hasPermission(department)) {
                showNotification('คุณไม่มีสิทธิ์แก้ไขข้อมูลแผนกนี้', 'error');
                return;
            }
            if (currentUser.role !== 'admin' && currentUser.department !== department) {
                showNotification('คุณสามารถแก้ไขได้เฉพาะข้อมูลของแผนกตัวเองเท่านั้น', 'error');
                return;
            }
            const item = demoData.items[department][code];
            if (!item) return;
            editingItemId = code;
            document.getElementById('modalTitle').textContent = `✏️ แก้ไขรายการ: ${item.name}`;
            document.getElementById('saveItemBtn').textContent = '💾 อัพเดท';
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemDepartment').value = department;
            document.getElementById('itemReorder').value = item.reorderPoint;
            document.getElementById('itemNotes').value = item.notes || '';
            const specs = item.specifications || {};
            ['itemPackaging', 'itemProtein', 'itemFat', 'itemMoisture', 'itemFiber', 'itemAsh', 'itemOther', 'itemCondition'].forEach(id => {
                const key = id.replace('item', '').toLowerCase();
                document.getElementById(id).value = specs[key] || '';
            });
            const deptSelect = document.getElementById('itemDepartment');
            if (currentUser.role !== 'admin') {
                deptSelect.disabled = true;
            }
            document.getElementById('itemModal').classList.add('show');
        }

        function deleteItem(code, department) {
            if (!hasPermission(department)) {
                showNotification('คุณไม่มีสิทธิ์ลบข้อมูลแผนกนี้', 'error');
                return;
            }
            if (currentUser.role !== 'admin' && currentUser.department !== department) {
                showNotification('คุณสามารถลบได้เฉพาะข้อมูลของแผนกตัวเองเท่านั้น', 'error');
                return;
            }
            const item = demoData.items[department][code];
            if (!item) return;
            if (item.stock > 0) {
                showNotification(`ไม่สามารถลบรายการ "${item.name}" ได้\n\nเนื่องจากยังมีสต๊อกคงเหลือ ${item.stock.toLocaleString()} กก.\nกรุณาใช้สต๊อกให้หมดก่อนหรือปรับปรุงจำนวนเป็น 0`, 'error');
                return;
            }
            if (confirm(`คุณต้องการลบรายการ "${item.name}" ใช่หรือไม่?\n\nการลบจะไม่สามารถย้อนกลับได้`)) {
                delete demoData.items[department][code];
                localStorage.setItem('dairyStockData', JSON.stringify(demoData));
                showNotification(`ลบรายการ "${item.name}" เรียบร้อยแล้ว`, 'success');
                updateStats();
                updateInventoryTables();
                updateManagementTable();
                updateItemSelect();
                generateAlerts();
            }
        }

        function saveItem(event) {
            event.preventDefault();
            const name = document.getElementById('itemName').value;
            const department = document.getElementById('itemDepartment').value;
            const reorderPoint = parseFloat(document.getElementById('itemReorder').value);
            const notes = document.getElementById('itemNotes').value;
            const specifications = {};
            ['packaging', 'protein', 'fat', 'moisture', 'fiber', 'ash', 'other', 'condition'].forEach(key => {
                const value = document.getElementById('item' + key.charAt(0).toUpperCase() + key.slice(1)).value;
                if (value) specifications[key] = value;
            });
            
            if (!hasPermission(department)) {
                showNotification('คุณไม่มีสิทธิ์จัดการข้อมูลแผนกนี้', 'error');
                return;
            }
            if (currentUser.role !== 'admin' && currentUser.department !== department) {
                showNotification('คุณสามารถจัดการได้เฉพาะข้อมูลของแผนกตัวเองเท่านั้น', 'error');
                return;
            }
            
            if (editingItemId) {
                const item = demoData.items[department][editingItemId];
                item.name = name;
                item.reorderPoint = reorderPoint;
                item.notes = notes;
                item.specifications = specifications;
                item.lastModified = new Date().toISOString();
                showNotification(`อัพเดทรายการ "${name}" เรียบร้อยแล้ว`, 'success');
            } else {
                const existingItems = demoData.items[department] || {};
                const prefix = department === 'farm' ? 'F' : 'B';
                const nextNumber = Object.keys(existingItems).length + 1;
                const newCode = `${prefix}${nextNumber.toString().padStart(3, '0')}`;
                const defaultExpiry = new Date();
                defaultExpiry.setFullYear(defaultExpiry.getFullYear() + 1);
                demoData.items[department][newCode] = {
                    name: name,
                    stock: 0,
                    pricePerKg: 0,
                    reorderPoint: reorderPoint,
                    expiryDate: defaultExpiry.toISOString().split('T')[0],
                    notes: notes,
                    specifications: specifications,
                    batches: [],
                    lastModified: new Date().toISOString()
                };
                showNotification(`เพิ่มรายการ "${name}" เรียบร้อยแล้ว\nจำนวนเริ่มต้น: 0 กก. (ใส่ข้อมูลสต๊อกและราคาเมื่อรับเข้า)`, 'success');
            }
            localStorage.setItem('dairyStockData', JSON.stringify(demoData));
            closeItemModal();
            updateStats();
            updateInventoryTables();
            updateManagementTable();
            updateItemSelect();
            generateAlerts();
        }

        function showItemDetails(code, department) {
            const item = demoData.items[department][code];
            if (!item) return;
            document.getElementById('detailsModalTitle').textContent = `📋 รายละเอียดวัตถุดิบ: ${item.name}`;
            const specs = item.specifications || {};
            const batches = item.batches || [];
            let detailsHTML = `
                <div class="form-grid" style="margin-bottom: 25px;">
                    <div class="form-group">
                        <label>รหัสรายการ</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">${code}</div>
                    </div>
                    <div class="form-group">
                        <label>สต๊อกปัจจุบัน</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;"><strong>${item.stock.toLocaleString()} กก.</strong></div>
                    </div>
                    <div class="form-group">
                        <label>ราคาเฉลี่ย FIFO</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;"><strong>${getAveragePrice(code, department).toFixed(2)} บาท/กก.</strong></div>
                    </div>
                    <div class="form-group">
                        <label>มูลค่ารวม</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;"><strong>${(item.stock * getAveragePrice(code, department)).toLocaleString()} บาท</strong></div>
                    </div>
                </div>
                <h4>📦 ข้อมูลบรรจุภัณฑ์และคุณลักษณะ</h4>
                <div class="table-container" style="margin-bottom: 25px;">
                    <table class="table">
                        <tbody>
            `;
            Object.entries(specs).forEach(([key, value]) => {
                if (value) {
                    const labels = {
                        packaging: 'บรรจุภัณฑ์',
                        protein: 'โปรตีน',
                        fat: 'ไขมัน',
                        moisture: 'ความชื้น',
                        fiber: 'เยื่อใย',
                        ash: 'กาก/เถ้า',
                        other: 'อื่นๆ',
                        condition: 'เงื่อนไขคุณภาพ'
                    };
                    detailsHTML += `<tr><td><strong>${labels[key] || key}</strong></td><td>${value}</td></tr>`;
                }
            });
            detailsHTML += `</tbody></table></div>`;
            
            if (batches.length > 0) {
                detailsHTML += `
                    <h4>📊 ข้อมูล Batch (FIFO)</h4>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>วันที่รับ</th>
                                    <th>คงเหลือ (กก.)</th>
                                    <th>ราคา/กก.</th>
                                    <th>วันหมดอายุ</th>
                                    <th>มูลค่า</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                batches.forEach(batch => {
                    const dateReceived = new Date(batch.dateReceived).toLocaleDateString('th-TH');
                    const expiryDate = new Date(batch.expiryDate).toLocaleDateString('th-TH');
                    const value = batch.quantity * batch.unitPrice;
                    detailsHTML += `
                        <tr>
                            <td>${dateReceived}</td>
                            <td><strong>${batch.quantity.toLocaleString()}</strong></td>
                            <td>${batch.unitPrice.toFixed(2)}</td>
                            <td>${expiryDate}</td>
                            <td><strong>${value.toLocaleString()}</strong></td>
                        </tr>
                    `;
                });
                detailsHTML += `</tbody></table></div>`;
            } else {
                detailsHTML += `
                    <div class="alert alert-info">
                        <strong>ℹ️ ข้อมูล Batch:</strong> ยังไม่มีการรับเข้าสินค้าในระบบ FIFO
                    </div>
                `;
            }
            if (item.notes) {
                detailsHTML += `
                    <h4>📝 หมายเหตุ</h4>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
                        ${item.notes}
                    </div>
                `;
            }
            document.getElementById('itemDetailsContent').innerHTML = detailsHTML;
            document.getElementById('itemDetailsModal').classList.add('show');
        }

        function closeItemDetailsModal() {
            document.getElementById('itemDetailsModal').classList.remove('show');
        }

        // Form Functions
        function toggleFormFields() {
            const transactionType = document.getElementById('transactionType').value;
            const priceInputGroups = document.querySelectorAll('.price-input-group');
            const supplierGroup = document.querySelector('.supplier-group');
            const totalPriceInput = document.getElementById('totalPrice');
            const unitPriceInput = document.getElementById('unitPrice');
            const supplierInput = document.getElementById('supplier');
            
            if (transactionType === 'out') {
                priceInputGroups.forEach(group => {
                    group.style.display = 'none';
                });
                supplierGroup.style.display = 'none';
                totalPriceInput.required = false;
                unitPriceInput.required = false;
                supplierInput.required = false;
                totalPriceInput.value = '';
                unitPriceInput.value = '';
                supplierInput.value = 'การจ่ายออกใช้งาน';
            } else if (transactionType === 'in') {
                priceInputGroups.forEach(group => {
                    group.style.display = 'block';
                });
                supplierGroup.style.display = 'block';
                supplierInput.required = true;
                supplierInput.value = '';
            } else {
                priceInputGroups.forEach(group => {
                    group.style.display = 'block';
                });
                supplierGroup.style.display = 'block';
                supplierInput.required = true;
            }
        }

        function calculateAutoPrice() {
            const transactionType = document.getElementById('transactionType').value;
            const itemCode = document.getElementById('itemSelect').value;
            const quantity = parseFloat(document.getElementById('quantity').value);
            
            if (transactionType === 'out' && itemCode && quantity > 0) {
                const item = demoData.items[currentDepartment][itemCode];
                if (item && item.batches && item.batches.length > 0) {
                    let remainingToCalculate = quantity;
                    let totalCost = 0;
                    for (let i = 0; i < item.batches.length && remainingToCalculate > 0; i++) {
                        const batch = item.batches[i];
                        const quantityToTake = Math.min(batch.quantity, remainingToCalculate);
                        totalCost += quantityToTake * batch.unitPrice;
                        remainingToCalculate -= quantityToTake;
                    }
                    const avgPrice = quantity > 0 ? totalCost / quantity : 0;
                    showCostPreview(totalCost, avgPrice);
                }
            } else {
                hideCostPreview();
            }
        }

        function showCostPreview(totalCost, avgPrice) {
            let preview = document.getElementById('costPreview');
            if (!preview) {
                preview = document.createElement('div');
                preview.id = 'costPreview';
                preview.style.cssText = `
                    margin-top: 10px;
                    padding: 10px;
                    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
                    border-radius: 8px;
                    border: 1px solid rgba(0,0,0,0.1);
                    font-size: 0.9rem;
                `;
                document.getElementById('quantity').parentNode.appendChild(preview);
            }
            preview.innerHTML = `
                <div style="color: #1976d2; font-weight: 600;">💰 ต้นทุน FIFO (อัตโนมัติ)</div>
                <div style="margin-top: 5px;">
                    ราคาต่อกก.: <strong>${avgPrice.toFixed(2)} บาท</strong><br>
                    ราคารวม: <strong>${totalCost.toFixed(2)} บาท</strong>
                </div>
                <small style="color: #666;">ระบบจะใช้ราคานี้สำหรับการจ่ายออก</small>
            `;
        }

        function hideCostPreview() {
            const preview = document.getElementById('costPreview');
            if (preview) {
                preview.remove();
            }
        }

        function calculatePricePerKg() {
            const transactionType = document.getElementById('transactionType').value;
            if (transactionType !== 'in') return;
            const quantity = parseFloat(document.getElementById('quantity').value);
            const totalPrice = parseFloat(document.getElementById('totalPrice').value);
            if (quantity > 0 && totalPrice > 0) {
                const pricePerKg = totalPrice / quantity;
                document.getElementById('unitPrice').value = pricePerKg.toFixed(2);
            }
        }

        function calculateTotalPrice() {
            const transactionType = document.getElementById('transactionType').value;
            if (transactionType !== 'in') return;
            const quantity = parseFloat(document.getElementById('quantity').value);
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);
            if (quantity > 0 && unitPrice > 0) {
                const totalPrice = quantity * unitPrice;
                document.getElementById('totalPrice').value = totalPrice.toFixed(2);
            }
        }

        function submitRecord(event) {
            event.preventDefault();
            showNotification('ระบบนี้เป็น Demo เท่านั้น\nในระบบจริงจะบันทึกข้อมูลได้', 'info');
        }

        function resetForm() {
            document.querySelector('#record form').reset();
            setupCurrentDateTime();
            if (currentUser) {
                document.getElementById('recorder').value = currentUser.name;
            }
            document.getElementById('totalPrice').value = '';
            document.getElementById('unitPrice').value = '';
            document.getElementById('supplier').value = '';
            hideCostPreview();
            toggleFormFields();
        }

        // Report Functions
        function generateUsageReport() {
            showNotification('ฟีเจอร์รายงานจะพร้อมใช้งานในระบบจริง', 'info');
        }

        function detectAnomalies() {
            showNotification('ฟีเจอร์ตรวจจับความผิดปกติจะพร้อมใช้งานในระบบจริง', 'info');
        }

        function updateOverallStats() {
            document.getElementById('totalTransactions').textContent = '0';
            document.getElementById('avgDailyUsage').textContent = '0';
            document.getElementById('peakUsageDay').textContent = '-';
            document.getElementById('mostUsedItem').textContent = '-';
        }

        // Settings Functions
        function saveAlertSettings() {
            const lowStockPercent = parseInt(document.getElementById('lowStockPercent').value);
            const expiryDays = parseInt(document.getElementById('expiryDays').value);
            const alertEmail = document.getElementById('alertEmail').value;
            demoData.settings.lowStockPercent = lowStockPercent;
            demoData.settings.expiryDays = expiryDays;
            demoData.settings.alertEmail = alertEmail;
            localStorage.setItem('dairyStockData', JSON.stringify(demoData));
            showNotification('บันทึกการตั้งค่าเรียบร้อย', 'success');
            generateAlerts();
            updateStats();
            updateInventoryTables();
            updateManagementTable();
        }

        function loadAlertSettings() {
            if (demoData.settings) {
                document.getElementById('lowStockPercent').value = demoData.settings.lowStockPercent || 20;
                document.getElementById('expiryDays').value = demoData.settings.expiryDays || 7;
                document.getElementById('alertEmail').value = demoData.settings.alertEmail || '';
            }
        }

        // Export Functions
        function refreshData() {
            updateStats();
            updateInventoryTables();
            updateManagementTable();
            generateAlerts();
            showNotification('รีเฟรชข้อมูลเรียบร้อย', 'success');
        }

        function exportToExcel() {
            try {
                const workbook = XLSX.utils.book_new();
                const today = new Date().toLocaleDateString('th-TH');
                const departments = [];
                if (hasPermission('farm')) departments.push({ key: 'farm', name: 'ฟาร์มโคนม' });
                if (hasPermission('breeding')) departments.push({ key: 'breeding', name: 'ผลิตน้ำเชื้อ' });
                
                departments.forEach(dept => {
                    const items = demoData.items[dept.key] || {};
                    const worksheetData = [];
                    worksheetData.push([
                        'รายงานสต๊อกวัตถุดิบ - ' + dept.name,
                        '', '', '', '', '', '', ''
                    ]);
                    worksheetData.push([
                        'วันที่ตรวจนับ: ' + today,
                        '', '', '', '', '', '', ''
                    ]);
                    worksheetData.push([
                        'ผู้ตรวจนับ: _________________________',
                        '', '', '', '', '', '', ''
                    ]);
                    worksheetData.push([]);
                    worksheetData.push([
                        'รหัส',
                        'ชื่อวัตถุดิบ',
                        'สต๊อกในระบบ (กก.)',
                        'หน่วยบรรจุ',
                        'ราคา/กก.',
                        'มูลค่า (บาท)',
                        'จำนวนจริง (กก.)',
                        'หมายเหตุ'
                    ]);
                    
                    let totalSystemStock = 0;
                    let totalValue = 0;
                    Object.entries(items).forEach(([code, item]) => {
                        const specs = item.specifications || {};
                        const packageUnits = calculatePackageUnits(item.stock, specs.packaging);
                        const currentPrice = getAveragePrice(code, dept.key);
                        const value = item.stock * currentPrice;
                        totalSystemStock += item.stock;
                        totalValue += value;
                        worksheetData.push([
                            code,
                            item.name,
                            item.stock,
                            packageUnits || '',
                            currentPrice.toFixed(2),
                            Math.round(value),
                            '',
                            ''
                        ]);
                    });
                    
                    worksheetData.push([]);
                    worksheetData.push([
                        'รวม',
                        '',
                        totalSystemStock,
                        '',
                        '',
                        Math.round(totalValue),
                        '',
                        ''
                    ]);
                    worksheetData.push([]);
                    worksheetData.push([
                        'สรุปการตรวจนับ:',
                        '', '', '', '', '', '', ''
                    ]);
                    worksheetData.push([
                        'จำนวนรายการทั้งหมด: ' + Object.keys(items).length + ' รายการ',
                        '', '', '', '', '', '', ''
                    ]);
                    worksheetData.push([
                        'มูลค่ารวมในระบบ: ' + Math.round(totalValue).toLocaleString() + ' บาท',
                        '', '', '', '', '', '', ''
                    ]);
                    worksheetData.push([
                        'ลงชื่อผู้ตรวจนับ: _________________________',
                        '', '', '', '', '', '', ''
                    ]);
                    worksheetData.push([
                        'วันที่: _________________________',
                        '', '', '', '', '', '', ''
                    ]);
                    
                    const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                    worksheet['!cols'] = [
                        { width: 8 },
                        { width: 25 },
                        { width: 15 },
                        { width: 15 },
                        { width: 12 },
                        { width: 15 },
                        { width: 15 },
                        { width: 20 }
                    ];
                    worksheet['!margins'] = {
                        left: 0.7, right: 0.7, top: 0.75, bottom: 0.75,
                        header: 0.3, footer: 0.3
                    };
                    XLSX.utils.book_append_sheet(workbook, worksheet, dept.name);
                });
                
                const fileName = `อสค-สต๊อกวัตถุดิบ-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);
                showNotification('ส่งออกไฟล์ Excel เรียบร้อย\nไฟล์พร้อมสำหรับการพิมพ์และตรวจนับ', 'success');
            } catch (error) {
                console.error('Export Excel error:', error);
                showNotification('เกิดข้อผิดพลาดในการส่งออก Excel', 'error');
            }
        }

        function exportData() {
            try {
                const data = {
                    items: demoData.items,
                    transactions: demoData.transactions,
                    settings: demoData.settings,
                    exportDate: new Date().toISOString(),
                    version: '2.0'
                };
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `อสค-ข้อมูลสต๊อก-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                showNotification('ส่งออกข้อมูลเรียบร้อย', 'success');
            } catch (error) {
                showNotification('เกิดข้อผิดพลาดในการส่งออกข้อมูล', 'error');
            }
        }

        function backupData() {
            try {
                const backupData = {
                    ...demoData,
                    backupDate: new Date().toISOString(),
                    backupBy: currentUser?.email || 'unknown'
                };
                localStorage.setItem(`dairyBackup_${Date.now()}`, JSON.stringify(backupData));
                showNotification('สำรองข้อมูลเรียบร้อย', 'success');
            } catch (error) {
                showNotification('เกิดข้อผิดพลาดในการสำรองข้อมูล', 'error');
            }
        }

        // Session Recovery Functions
        function showSessionRecoveryOption(userData) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
                display: flex; align-items: center; justify-content: center;
                z-index: 10000; padding: 20px;
            `;
            modal.innerHTML = `
                <div style="
                    background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
                    padding: 40px; border-radius: 20px; text-align: center;
                    max-width: 450px; box-shadow: 0 25px 80px rgba(0,0,0,0.3);
                ">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">🔄 กู้คืน Session</h3>
                    <p style="margin-bottom: 25px; color: #555; line-height: 1.5;">
                        พบ Session เดิมของ<br>
                        <strong>${userData.name}</strong><br>
                        <small style="color: #999;">เข้าสู่ระบบล่าสุด: ${new Date(userData.loginTime || userData.lastLogin).toLocaleString('th-TH')}</small>
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="continueSession('${userData.email}')" class="btn btn-primary">
                            ✅ ใช้ Session เดิม
                        </button>
                        <button onclick="startNewSession()" class="btn btn-secondary">
                            🔐 Login ใหม่
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function continueSession(email) {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                currentUser.lastLogin = new Date().toISOString();
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                const modal = document.querySelector('div[style*="position: fixed"]');
                if (modal) modal.remove();
                showNotification('กู้คืน Session สำเร็จ', 'success');
                showMainApp();
            } else {
                startNewSession();
            }
        }

        function startNewSession() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) modal.remove();
            showLoginScreen();
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 SmartStock System Starting...');
            try {
                const savedData = localStorage.getItem('dairyStockData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    Object.assign(demoData, parsedData);
                    console.log('✅ Data loaded successfully');
                }
            } catch (e) {
                console.warn('⚠️ Could not load saved data, using defaults');
                localStorage.removeItem('dairyStockData');
            }
            
            try {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    const userData = JSON.parse(savedUser);
                    const loginTime = new Date(userData.loginTime || userData.lastLogin);
                    const now = new Date();
                    const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                    if (hoursDiff <= 8 && userData.email && userData.role) {
                        showSessionRecoveryOption(userData);
                        return;
                    } else {
                        localStorage.removeItem('currentUser');
                        console.log('🕐 Session expired, please login again');
                    }
                }
            } catch (e) {
                console.warn('⚠️ Invalid session data, cleared');
                localStorage.removeItem('currentUser');
            }
            showLoginScreen();
        });

        // Event Listeners
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
                doLogin();
            }
            if (event.key === 'Escape') {
                closeItemModal();
                closeItemDetailsModal();
            }
        });

        document.getElementById('itemModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeItemModal();
            }
        });

        document.getElementById('itemDetailsModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeItemDetailsModal();
            }
        });
    </script>
</body>
</html>
